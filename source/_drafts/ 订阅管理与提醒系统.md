---
abbrlink: 'SubsTracker '
ai: å·¥å…·
aplayer: null
aside: null
background: '#fff'
categories:
- - å·¥å…·ç±»
comments: null
copyright: null
copyright_author: null
copyright_author_href: null
copyright_info: null
copyright_url: null
cover: https://5f4480c.webp.li/2025/07/a451a90a4bf6a24ba9772733ccec5d10.webp
date: '2025-07-05T13:44:04.162058+08:00'
description: null
excerpt: SubsTrackerÂ â€“Â è®¢é˜…ç®¡ç†ä¸æé†’ç³»ç»Ÿæ˜¯åŸºäºCloudflareÂ Workersçš„è½»é‡çº§è®¢é˜…ç®¡ç†ç³»ç»Ÿï¼Œå¸®åŠ©æ‚¨è½»æ¾è·Ÿè¸ªå„ç±»è®¢é˜…æœåŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œå¹¶é€šè¿‡Telegramå‘é€åŠæ—¶æé†’ã€‚Â Â Â âœ¨Â ç‰¹æ€§Â Â Â ğŸ””Â è‡ªåŠ¨æé†’:Â åœ¨è®¢é˜…åˆ°æœŸå‰è‡ªåŠ¨å‘é€Telegramé€šçŸ¥Â Â Â ğŸ“ŠÂ è®¢é˜…ç®¡ç†:Â ç›´è§‚çš„Webç•Œé¢ç®¡ç†æ‰€æœ‰è®¢é˜…Â Â Â ğŸ”„Â å‘¨æœŸè®¡ç®—:Â æ™ºèƒ½è®¡ç®—å¾ªç¯è®¢é˜…çš„ä¸‹ä¸€ä¸ªå‘¨æœŸÂ Â Â ğŸ“±Â å“åº”å¼è®¾è®¡:Â å®Œç¾é€‚é…...
highlight_shrink: null
katex: null
keywords: null
mathjax: null
swiper_index: 10
tags:
- å·¥å…·ç±»
title: ' è®¢é˜…ç®¡ç†ä¸æé†’ç³»ç»Ÿ'
toc: null
toc_number: null
toc_style_simple: null
top: null
top_group_index: 10
top_img: https://5f4480c.webp.li/2025/07/a451a90a4bf6a24ba9772733ccec5d10.webp
updated: '2025-08-04T16:59:01.903+08:00'
---
**SubsTracker â€“ è®¢é˜…ç®¡ç†ä¸æé†’ç³»ç»Ÿæ˜¯**åŸºäºCloudflare Workersçš„è½»é‡çº§è®¢é˜…ç®¡ç†ç³»ç»Ÿï¼Œå¸®åŠ©æ‚¨è½»æ¾è·Ÿè¸ªå„ç±»è®¢é˜…æœåŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œå¹¶é€šè¿‡Telegramå‘é€åŠæ—¶æé†’ã€‚

<img src="https://5f4480c.webp.li/2025/07/afc71eb7193ffcc329983d745874efe4.png" >

<img src="https://5f4480c.webp.li/2025/07/a451a90a4bf6a24ba9772733ccec5d10.webp" >

## âœ¨ ç‰¹æ€§

* ğŸ”” **è‡ªåŠ¨æé†’**: åœ¨è®¢é˜…åˆ°æœŸå‰è‡ªåŠ¨å‘é€Telegramé€šçŸ¥
* ğŸ“Š **è®¢é˜…ç®¡ç†**: ç›´è§‚çš„Webç•Œé¢ç®¡ç†æ‰€æœ‰è®¢é˜…
* ğŸ”„ **å‘¨æœŸè®¡ç®—**: æ™ºèƒ½è®¡ç®—å¾ªç¯è®¢é˜…çš„ä¸‹ä¸€ä¸ªå‘¨æœŸ
* ğŸ“± **å“åº”å¼è®¾è®¡**: å®Œç¾é€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢è®¾å¤‡
* â˜ï¸ **å…æœåŠ¡å™¨**: åŸºäºCloudflare Workersï¼Œæ— éœ€è‡ªå»ºæœåŠ¡å™¨
* ğŸ”’ **å®‰å…¨å¯é **: æ•°æ®å­˜å‚¨åœ¨Cloudflare KVä¸­ï¼Œå®‰å…¨ä¸”é«˜æ•ˆ

  ** æœ€æ–°ç‰ˆæœ¬ä»£ç ï¼š**

  ```
  // è®¢é˜…ç»­æœŸé€šçŸ¥ç½‘ç«™ - åŸºäºCloudFlare Workers (å®Œå…¨ä¼˜åŒ–ç‰ˆ)

  // æ—¶åŒºå·¥å…·å‡½æ•°
  function formatBeijingTime(date = new Date(), format = 'full') {
    if (format === 'date') {
      return date.toLocaleDateString('zh-CN', {
        timeZone: 'Asia/Shanghai',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    } else if (format === 'datetime') {
      return date.toLocaleString('zh-CN', {
        timeZone: 'Asia/Shanghai',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    } else {
      // full format
      return date.toLocaleString('zh-CN', {
        timeZone: 'Asia/Shanghai'
      });
    }
  }

  // å†œå†è½¬æ¢å·¥å…·å‡½æ•°
  const lunarCalendar = {
    // å†œå†æ•°æ® (1900-2100å¹´)
    lunarInfo: [
      0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
      0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
      0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
      0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
      0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
      0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0,
      0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
      0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b6a0, 0x195a6,
      0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
      0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
      0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
      0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
      0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
      0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
      0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0
    ],

    // å¤©å¹²åœ°æ”¯
    gan: ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
    zhi: ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'],

    // å†œå†æœˆä»½
    months: ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'],

    // å†œå†æ—¥æœŸ
    days: ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
           'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
           'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'],

    // è·å–å†œå†å¹´å¤©æ•°
    lunarYearDays: function(year) {
      let sum = 348;
      for (let i = 0x8000; i > 0x8; i >>= 1) {
        sum += (this.lunarInfo[year - 1900] & i) ? 1 : 0;
      }
      return sum + this.leapDays(year);
    },

    // è·å–é—°æœˆå¤©æ•°
    leapDays: function(year) {
      if (this.leapMonth(year)) {
        return (this.lunarInfo[year - 1900] & 0x10000) ? 30 : 29;
      }
      return 0;
    },

    // è·å–é—°æœˆæœˆä»½
    leapMonth: function(year) {
      return this.lunarInfo[year - 1900] & 0xf;
    },

    // è·å–å†œå†æœˆå¤©æ•°
    monthDays: function(year, month) {
      return (this.lunarInfo[year - 1900] & (0x10000 >> month)) ? 30 : 29;
    },

    // å…¬å†è½¬å†œå†
    solar2lunar: function(year, month, day) {
      if (year < 1900 || year > 2100) return null;

      const baseDate = new Date(1900, 0, 31);
      const objDate = new Date(year, month - 1, day);
      let offset = Math.floor((objDate - baseDate) / 86400000);

      let temp = 0;
      let lunarYear = 1900;

      for (lunarYear = 1900; lunarYear < 2101 && offset > 0; lunarYear++) {
        temp = this.lunarYearDays(lunarYear);
        offset -= temp;
      }

      if (offset < 0) {
        offset += temp;
        lunarYear--;
      }

      let lunarMonth = 1;
      let leap = this.leapMonth(lunarYear);
      let isLeap = false;

      for (lunarMonth = 1; lunarMonth < 13 && offset > 0; lunarMonth++) {
        if (leap > 0 && lunarMonth === (leap + 1) && !isLeap) {
          --lunarMonth;
          isLeap = true;
          temp = this.leapDays(lunarYear);
        } else {
          temp = this.monthDays(lunarYear, lunarMonth);
        }

        if (isLeap && lunarMonth === (leap + 1)) isLeap = false;
        offset -= temp;
      }

      if (offset === 0 && leap > 0 && lunarMonth === leap + 1) {
        if (isLeap) {
          isLeap = false;
        } else {
          isLeap = true;
          --lunarMonth;
        }
      }

      if (offset < 0) {
        offset += temp;
        --lunarMonth;
      }

      const lunarDay = offset + 1;

      // ç”Ÿæˆå†œå†å­—ç¬¦ä¸²
      const ganIndex = (lunarYear - 4) % 10;
      const zhiIndex = (lunarYear - 4) % 12;
      const yearStr = this.gan[ganIndex] + this.zhi[zhiIndex] + 'å¹´';
      const monthStr = (isLeap ? 'é—°' : '') + this.months[lunarMonth - 1] + 'æœˆ';
      const dayStr = this.days[lunarDay - 1];

      return {
        year: lunarYear,
        month: lunarMonth,
        day: lunarDay,
        isLeap: isLeap,
        yearStr: yearStr,
        monthStr: monthStr,
        dayStr: dayStr,
        fullStr: yearStr + monthStr + dayStr
      };
    }
  };

  // 1. æ–°å¢ lunarBiz å·¥å…·æ¨¡å—ï¼Œæ”¯æŒå†œå†åŠ å‘¨æœŸã€å†œå†è½¬å…¬å†ã€å†œå†è·ç¦»å¤©æ•°
  const lunarBiz = {
    // å†œå†åŠ å‘¨æœŸï¼Œè¿”å›æ–°çš„å†œå†æ—¥æœŸå¯¹è±¡
    addLunarPeriod(lunar, periodValue, periodUnit) {
      let { year, month, day, isLeap } = lunar;
      if (periodUnit === 'year') {
        year += periodValue;
        const leap = lunarCalendar.leapMonth(year);
        if (isLeap && leap === month) {
          isLeap = true;
        } else {
          isLeap = false;
        }
      } else if (periodUnit === 'month') {
        let totalMonths = (year - 1900) * 12 + (month - 1) + periodValue;
        year = Math.floor(totalMonths / 12) + 1900;
        month = (totalMonths % 12) + 1;
        const leap = lunarCalendar.leapMonth(year);
        if (isLeap && leap === month) {
          isLeap = true;
        } else {
          isLeap = false;
        }
      } else if (periodUnit === 'day') {
        const solar = lunarBiz.lunar2solar(lunar);
        const date = new Date(solar.year, solar.month - 1, solar.day + periodValue);
        return lunarCalendar.solar2lunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
      }
      let maxDay = isLeap
        ? lunarCalendar.leapDays(year)
        : lunarCalendar.monthDays(year, month);
      let targetDay = Math.min(day, maxDay);
      while (targetDay > 0) {
        let solar = lunarBiz.lunar2solar({ year, month, day: targetDay, isLeap });
        if (solar) {
          return { year, month, day: targetDay, isLeap };
        }
        targetDay--;
      }
      return { year, month, day, isLeap };
    },
    // å†œå†è½¬å…¬å†ï¼ˆéå†æ³•ï¼Œé€‚ç”¨1900-2100å¹´ï¼‰
    lunar2solar(lunar) {
      for (let y = lunar.year - 1; y <= lunar.year + 1; y++) {
        for (let m = 1; m <= 12; m++) {
          for (let d = 1; d <= 31; d++) {
            const date = new Date(y, m - 1, d);
            if (date.getFullYear() !== y || date.getMonth() + 1 !== m || date.getDate() !== d) continue;
            const l = lunarCalendar.solar2lunar(y, m, d);
            if (
              l &&
              l.year === lunar.year &&
              l.month === lunar.month &&
              l.day === lunar.day &&
              l.isLeap === lunar.isLeap
            ) {
              return { year: y, month: m, day: d };
            }
          }
        }
      }
      return null;
    },
    // è·ç¦»å†œå†æ—¥æœŸè¿˜æœ‰å¤šå°‘å¤©
    daysToLunar(lunar) {
      const solar = lunarBiz.lunar2solar(lunar);
      const date = new Date(solar.year, solar.month - 1, solar.day);
      const now = new Date();
      return Math.ceil((date - now) / (1000 * 60 * 60 * 24));
    }
  };

  // å®šä¹‰HTMLæ¨¡æ¿
  const loginPage = `
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
      .login-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .login-box {
        backdrop-filter: blur(8px);
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: all 0.3s;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .input-field {
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
      }
      .input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
      }
    </style>
  </head>
  <body class="login-container flex items-center justify-center">
    <div class="login-box p-8 rounded-xl w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-calendar-check mr-2"></i>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</h1>
        <p class="text-gray-600 mt-2">ç™»å½•ç®¡ç†æ‚¨çš„è®¢é˜…æé†’</p>
      </div>

      <form id="loginForm" class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-user mr-2"></i>ç”¨æˆ·å
          </label>
          <input type="text" id="username" name="username" required
            class="input-field w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
            <i class="fas fa-lock mr-2"></i>å¯†ç 
          </label>
          <input type="password" id="password" name="password" required
            class="input-field w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none">
        </div>

        <button type="submit" 
          class="btn-primary w-full py-3 rounded-lg text-white font-medium focus:outline-none">
          <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
        </button>

        <div id="errorMsg" class="text-red-500 text-center"></div>
      </form>
    </div>

    <script>
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const button = e.target.querySelector('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç™»å½•ä¸­...';
        button.disabled = true;

        try {
          const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const result = await response.json();

          if (result.success) {
            window.location.href = '/admin';
          } else {
            document.getElementById('errorMsg').textContent = result.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        } catch (error) {
          document.getElementById('errorMsg').textContent = 'å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      });
    </script>
  </body>
  </html>
  `;

  const adminPage = `
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
      .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .btn-danger { background: linear-gradient(135deg, #f87171 0%, #dc2626 100%); transition: all 0.3s; }
      .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .btn-success { background: linear-gradient(135deg, #34d399 0%, #059669 100%); transition: all 0.3s; }
      .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .btn-warning { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); transition: all 0.3s; }
      .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); transition: all 0.3s; }
      .btn-info:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .table-container { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
      .modal-container { backdrop-filter: blur(8px); }
      .readonly-input { background-color: #f8fafc; border-color: #e2e8f0; cursor: not-allowed; }
      .error-message { font-size: 0.875rem; margin-top: 0.25rem; display: none; }
      .error-message.show { display: block; }

      /* é€šç”¨æ‚¬æµ®æç¤ºä¼˜åŒ– */
      .hover-container {
        position: relative;
        width: 100%;
      }
      .hover-text {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
      }
      .hover-text:hover { color: #3b82f6; }
      .hover-tooltip {
        position: fixed;
        z-index: 9999;
        background: #1f2937;
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 0.875rem;
        max-width: 320px;
        word-wrap: break-word;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        transform: translateY(-10px);
        white-space: normal;
        pointer-events: none;
        line-height: 1.4;
      }
      .hover-tooltip.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      .hover-tooltip::before {
        content: '';
        position: absolute;
        top: -6px;
        left: 20px;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #1f2937;
      }
      .hover-tooltip.tooltip-above::before {
        top: auto;
        bottom: -6px;
        border-bottom: none;
        border-top: 6px solid #1f2937;
      }

      /* å¤‡æ³¨æ˜¾ç¤ºä¼˜åŒ– */
      .notes-container {
        position: relative;
        max-width: 200px;
        width: 100%;
      }
      .notes-text {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
      }
      .notes-text:hover { color: #3b82f6; }
      .notes-tooltip {
        position: fixed;
        z-index: 9999;
        background: #1f2937;
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 0.875rem;
        max-width: 320px;
        word-wrap: break-word;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        transform: translateY(-10px);
        white-space: normal;
        pointer-events: none;
        line-height: 1.4;
      }
      .notes-tooltip.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      .notes-tooltip::before {
        content: '';
        position: absolute;
        top: -6px;
        left: 20px;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #1f2937;
      }
      .notes-tooltip.tooltip-above::before {
        top: auto;
        bottom: -6px;
        border-bottom: none;
        border-top: 6px solid #1f2937;
      }

      /* å†œå†æ˜¾ç¤ºæ ·å¼ */
      .lunar-display {
        font-size: 0.75rem;
        color: #6366f1;
        margin-top: 2px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .lunar-display.show {
        opacity: 1;
      }
      .lunar-toggle {
        display: inline-flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.875rem;
      }
      .lunar-toggle input[type="checkbox"] {
        margin-right: 6px;
      }

      /* è¡¨æ ¼å¸ƒå±€ä¼˜åŒ– */
      .table-container {
        width: 100%;
        overflow: visible;
      }

      .table-container table {
        table-layout: fixed;
        width: 100%;
      }

      /* é˜²æ­¢è¡¨æ ¼å†…å®¹æº¢å‡º */
      .table-container td {
        overflow: hidden;
        word-wrap: break-word;
      }

      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* å“åº”å¼ä¼˜åŒ– */
      .responsive-table { table-layout: fixed; width: 100%; }
      .td-content-wrapper { word-wrap: break-word; white-space: normal; text-align: left; width: 100%; }
      .td-content-wrapper > * { text-align: left; } /* Align content left within the wrapper */

      @media (max-width: 767px) {
        .table-container { overflow-x: initial; } /* Override previous setting */
        .responsive-table thead { display: none; }
        .responsive-table tbody, .responsive-table tr, .responsive-table td { display: block; width: 100%; }
        .responsive-table tr { margin-bottom: 1.5rem; border: 1px solid #ddd; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .responsive-table td { display: flex; justify-content: flex-start; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #eee; }
        .responsive-table td:last-of-type { border-bottom: none; }
        .responsive-table td:before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; color: #374151; white-space: nowrap; }
        .action-buttons-wrapper { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }

        .notes-container, .hover-container {
          max-width: 180px; /* Adjust for new layout */
          text-align: right;
        }
        .td-content-wrapper .notes-text {
          text-align: right;
        }
      }

      @media (min-width: 768px) {
        .table-container {
          overflow: visible;
        }
        /* .td-content-wrapper is aligned left by default */
      }

      /* Toast æ ·å¼ */
      .toast {
        position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
        color: white; font-weight: 500; z-index: 1000; transform: translateX(400px);
        transition: all 0.3s ease-in-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .toast.show { transform: translateX(0); }
      .toast.success { background-color: #10b981; }
      .toast.error { background-color: #ef4444; }
      .toast.info { background-color: #3b82f6; }
      .toast.warning { background-color: #f59e0b; }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="toast-container"></div>

    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
          </div>
          <div class="flex items-center space-x-4">
            <a href="/admin" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
            </a>
            <a href="/admin/config" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
            </a>
            <a href="/api/logout" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">è®¢é˜…åˆ—è¡¨</h2>
        <div class="flex items-center space-x-4">
          <label class="lunar-toggle">
            <input type="checkbox" id="listShowLunar" class="form-checkbox h-4 w-4 text-indigo-600">
            <span class="text-gray-700">æ˜¾ç¤ºå†œå†</span>
          </label>
          <button id="addSubscriptionBtn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
            <i class="fas fa-plus mr-2"></i>æ·»åŠ æ–°è®¢é˜…
          </button>
        </div>
      </div>

      <div class="table-container bg-white rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full divide-y divide-gray-200 responsive-table">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 25%;">
                  åç§°
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">
                  ç±»å‹
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 20%;">
                  åˆ°æœŸæ—¶é—´ <i class="fas fa-sort-up ml-1 text-indigo-500" title="æŒ‰åˆ°æœŸæ—¶é—´å‡åºæ’åˆ—"></i>
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">
                  æé†’è®¾ç½®
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                  çŠ¶æ€
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 15%;">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
          <tbody id="subscriptionsBody" class="bg-white divide-y divide-gray-200">
          </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è®¢é˜…çš„æ¨¡æ€æ¡† -->
    <div id="subscriptionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-container hidden flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
          <div class="flex items-center justify-between">
            <h3 id="modalTitle" class="text-lg font-medium text-gray-900">æ·»åŠ æ–°è®¢é˜…</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <form id="subscriptionForm" class="p-6 space-y-6">
          <input type="hidden" id="subscriptionId">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…åç§° *</label>
              <input type="text" id="name" required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <div class="error-message text-red-500"></div>
            </div>

            <div>
              <label for="customType" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…ç±»å‹</label>
              <input type="text" id="customType" placeholder="ä¾‹å¦‚ï¼šæµåª’ä½“ã€äº‘æœåŠ¡ã€è½¯ä»¶ç­‰"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <div class="error-message text-red-500"></div>
            </div>
          </div>

          <div class="mb-4">
            <label class="lunar-toggle">
              <input type="checkbox" id="showLunar" class="form-checkbox h-4 w-4 text-indigo-600">
              <span class="text-gray-700">æ˜¾ç¤ºå†œå†æ—¥æœŸ</span>
            </label>
          </div>
  		<!-- æ–°å¢ä¿®æ”¹ï¼Œåœ¨è¡¨å•æ·»åŠ "å‘¨æœŸæŒ‰å†œå†"å¤é€‰æ¡†ï¼Œå»ºè®®æ”¾åœ¨"æ˜¾ç¤ºå†œå†æ—¥æœŸ"ä¸‹æ–¹ -->
  		<div class="mb-4">
  		  <label class="lunar-toggle">
  			<input type="checkbox" id="useLunar" class="form-checkbox h-4 w-4 text-indigo-600">
  			<span class="text-gray-700">å‘¨æœŸæŒ‰å†œå†</span>
  		  </label>
  		</div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¥æœŸ</label>
              <input type="date" id="startDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <div id="startDateLunar" class="lunar-display"></div>
              <div class="error-message text-red-500"></div>
            </div>

            <div>
              <label for="periodValue" class="block text-sm font-medium text-gray-700 mb-1">å‘¨æœŸæ•°å€¼ *</label>
              <input type="number" id="periodValue" min="1" value="1" required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <div class="error-message text-red-500"></div>
            </div>

            <div>
              <label for="periodUnit" class="block text-sm font-medium text-gray-700 mb-1">å‘¨æœŸå•ä½ *</label>
              <select id="periodUnit" required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="day">å¤©</option>
                <option value="month" selected>æœˆ</option>
                <option value="year">å¹´</option>
              </select>
              <div class="error-message text-red-500"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">åˆ°æœŸæ—¥æœŸ *</label>
              <input type="date" id="expiryDate" required
                class="readonly-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
              <div id="expiryDateLunar" class="lunar-display"></div>
              <div class="error-message text-red-500"></div>
            </div>

            <div class="flex items-end">
              <button type="button" id="calculateExpiryBtn" 
                class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium h-10">
                <i class="fas fa-calculator mr-2"></i>è‡ªåŠ¨è®¡ç®—åˆ°æœŸæ—¥æœŸ
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="reminderDays" class="block text-sm font-medium text-gray-700 mb-1">æå‰æé†’å¤©æ•°</label>
              <input type="number" id="reminderDays" min="0" value="7"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <p class="text-xs text-gray-500 mt-1">0 = ä»…åˆ°æœŸæ—¥å½“å¤©æé†’ï¼Œ1+ = æå‰Nå¤©å¼€å§‹æé†’</p>
              <div class="error-message text-red-500"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">é€‰é¡¹è®¾ç½®</label>
              <div class="space-y-2">
                <label class="inline-flex items-center">
                  <input type="checkbox" id="isActive" checked 
                    class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">å¯ç”¨è®¢é˜…</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" id="autoRenew" checked 
                    class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">è‡ªåŠ¨ç»­è®¢</span>
                </label>
              </div>
            </div>
          </div>

          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
            <textarea id="notes" rows="3" placeholder="å¯æ·»åŠ ç›¸å…³å¤‡æ³¨ä¿¡æ¯..."
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            <div class="error-message text-red-500"></div>
          </div>

          <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
            <button type="button" id="cancelBtn" 
              class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
              å–æ¶ˆ
            </button>
            <button type="submit" 
              class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-save mr-2"></i>ä¿å­˜
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // æ—¶åŒºå·¥å…·å‡½æ•° - å‰ç«¯ç‰ˆæœ¬
      function formatBeijingTime(date = new Date(), format = 'full') {
        if (format === 'date') {
          return date.toLocaleDateString('zh-CN', {
            timeZone: 'Asia/Shanghai',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        } else if (format === 'datetime') {
          return date.toLocaleString('zh-CN', {
            timeZone: 'Asia/Shanghai',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
        } else {
          // full format
          return date.toLocaleString('zh-CN', {
            timeZone: 'Asia/Shanghai'
          });
        }
      }

      // å†œå†è½¬æ¢å·¥å…·å‡½æ•° - å‰ç«¯ç‰ˆæœ¬
      const lunarCalendar = {
        // å†œå†æ•°æ® (1900-2100å¹´)
        lunarInfo: [
          0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
          0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
          0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
          0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
          0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
          0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0,
          0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
          0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b6a0, 0x195a6,
          0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
          0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
          0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
          0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
          0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
          0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
          0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0
        ],

        // å¤©å¹²åœ°æ”¯
        gan: ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
        zhi: ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'],

        // å†œå†æœˆä»½
        months: ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'],

        // å†œå†æ—¥æœŸ
        days: ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
               'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
               'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'],

        // è·å–å†œå†å¹´å¤©æ•°
        lunarYearDays: function(year) {
          let sum = 348;
          for (let i = 0x8000; i > 0x8; i >>= 1) {
            sum += (this.lunarInfo[year - 1900] & i) ? 1 : 0;
          }
          return sum + this.leapDays(year);
        },

        // è·å–é—°æœˆå¤©æ•°
        leapDays: function(year) {
          if (this.leapMonth(year)) {
            return (this.lunarInfo[year - 1900] & 0x10000) ? 30 : 29;
          }
          return 0;
        },

        // è·å–é—°æœˆæœˆä»½
        leapMonth: function(year) {
          return this.lunarInfo[year - 1900] & 0xf;
        },

        // è·å–å†œå†æœˆå¤©æ•°
        monthDays: function(year, month) {
          return (this.lunarInfo[year - 1900] & (0x10000 >> month)) ? 30 : 29;
        },

        // å…¬å†è½¬å†œå†
        solar2lunar: function(year, month, day) {
          if (year < 1900 || year > 2100) return null;

          const baseDate = new Date(1900, 0, 31);
          const objDate = new Date(year, month - 1, day);
          let offset = Math.floor((objDate - baseDate) / 86400000);

          let temp = 0;
          let lunarYear = 1900;

          for (lunarYear = 1900; lunarYear < 2101 && offset > 0; lunarYear++) {
            temp = this.lunarYearDays(lunarYear);
            offset -= temp;
          }

          if (offset < 0) {
            offset += temp;
            lunarYear--;
          }

          let lunarMonth = 1;
          let leap = this.leapMonth(lunarYear);
          let isLeap = false;

          for (lunarMonth = 1; lunarMonth < 13 && offset > 0; lunarMonth++) {
            if (leap > 0 && lunarMonth === (leap + 1) && !isLeap) {
              --lunarMonth;
              isLeap = true;
              temp = this.leapDays(lunarYear);
            } else {
              temp = this.monthDays(lunarYear, lunarMonth);
            }

            if (isLeap && lunarMonth === (leap + 1)) isLeap = false;
            offset -= temp;
          }

          if (offset === 0 && leap > 0 && lunarMonth === leap + 1) {
            if (isLeap) {
              isLeap = false;
            } else {
              isLeap = true;
              --lunarMonth;
            }
          }

          if (offset < 0) {
            offset += temp;
            --lunarMonth;
          }

          const lunarDay = offset + 1;

          // ç”Ÿæˆå†œå†å­—ç¬¦ä¸²
          const ganIndex = (lunarYear - 4) % 10;
          const zhiIndex = (lunarYear - 4) % 12;
          const yearStr = this.gan[ganIndex] + this.zhi[zhiIndex] + 'å¹´';
          const monthStr = (isLeap ? 'é—°' : '') + this.months[lunarMonth - 1] + 'æœˆ';
          const dayStr = this.days[lunarDay - 1];

          return {
            year: lunarYear,
            month: lunarMonth,
            day: lunarDay,
            isLeap: isLeap,
            yearStr: yearStr,
            monthStr: monthStr,
            dayStr: dayStr,
            fullStr: yearStr + monthStr + dayStr
          };
        }
      };


  // æ–°å¢ä¿®æ”¹ï¼Œå†œå†è½¬å…¬å†ï¼ˆç®€åŒ–ï¼Œé€‚ç”¨1900-2100å¹´ï¼‰
  function lunar2solar(lunar) {
    for (let y = lunar.year - 1; y <= lunar.year + 1; y++) {
      for (let m = 1; m <= 12; m++) {
        for (let d = 1; d <= 31; d++) {
          const date = new Date(y, m - 1, d);
          if (date.getFullYear() !== y || date.getMonth() + 1 !== m || date.getDate() !== d) continue;
          const l = lunarCalendar.solar2lunar(y, m, d);
          if (
            l &&
            l.year === lunar.year &&
            l.month === lunar.month &&
            l.day === lunar.day &&
            l.isLeap === lunar.isLeap
          ) {
            return { year: y, month: m, day: d };
          }
        }
      }
    }
    return null;
  }

  // æ–°å¢ä¿®æ”¹ï¼Œå†œå†åŠ å‘¨æœŸï¼Œå‰æœŸç‰ˆæœ¬
  function addLunarPeriod(lunar, periodValue, periodUnit) {
    let { year, month, day, isLeap } = lunar;
    if (periodUnit === 'year') {
      year += periodValue;
      const leap = lunarCalendar.leapMonth(year);
      if (isLeap && leap === month) {
        isLeap = true;
      } else {
        isLeap = false;
      }
    } else if (periodUnit === 'month') {
      let totalMonths = (year - 1900) * 12 + (month - 1) + periodValue;
      year = Math.floor(totalMonths / 12) + 1900;
      month = (totalMonths % 12) + 1;
      const leap = lunarCalendar.leapMonth(year);
      if (isLeap && leap === month) {
        isLeap = true;
      } else {
        isLeap = false;
      }
    } else if (periodUnit === 'day') {
      const solar = lunar2solar(lunar);
      const date = new Date(solar.year, solar.month - 1, solar.day + periodValue);
      return lunarCalendar.solar2lunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
    }
    let maxDay = isLeap
      ? lunarCalendar.leapDays(year)
      : lunarCalendar.monthDays(year, month);
    let targetDay = Math.min(day, maxDay);
    while (targetDay > 0) {
      let solar = lunar2solar({ year, month, day: targetDay, isLeap });
      if (solar) {
        return { year, month, day: targetDay, isLeap };
      }
      targetDay--;
    }
    return { year, month, day, isLeap };
  }



      // å†œå†æ˜¾ç¤ºç›¸å…³å‡½æ•°
      function updateLunarDisplay(dateInputId, lunarDisplayId) {
        const dateInput = document.getElementById(dateInputId);
        const lunarDisplay = document.getElementById(lunarDisplayId);
        const showLunar = document.getElementById('showLunar');

        if (!dateInput.value || !showLunar.checked) {
          lunarDisplay.classList.remove('show');
          return;
        }

        const date = new Date(dateInput.value);
        const lunar = lunarCalendar.solar2lunar(date.getFullYear(), date.getMonth() + 1, date.getDate());

        if (lunar) {
          lunarDisplay.textContent = 'å†œå†ï¼š' + lunar.fullStr;
          lunarDisplay.classList.add('show');
        } else {
          lunarDisplay.classList.remove('show');
        }
      }

      function toggleLunarDisplay() {
        const showLunar = document.getElementById('showLunar');
        updateLunarDisplay('startDate', 'startDateLunar');
        updateLunarDisplay('expiryDate', 'expiryDateLunar');

        // ä¿å­˜ç”¨æˆ·åå¥½
        localStorage.setItem('showLunar', showLunar.checked);
      }

      function loadLunarPreference() {
        const showLunar = document.getElementById('showLunar');
        const saved = localStorage.getItem('showLunar');
        if (saved !== null) {
          showLunar.checked = saved === 'true';
        } else {
          showLunar.checked = true; // é»˜è®¤æ˜¾ç¤º
        }
        toggleLunarDisplay();
      }

      function handleListLunarToggle() {
        const listShowLunar = document.getElementById('listShowLunar');
        // ä¿å­˜ç”¨æˆ·åå¥½
        localStorage.setItem('showLunar', listShowLunar.checked);
        // é‡æ–°åŠ è½½è®¢é˜…åˆ—è¡¨ä»¥åº”ç”¨å†œå†æ˜¾ç¤ºè®¾ç½®
        loadSubscriptions();
      }

      function showToast(message, type = 'success', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;

        const icon = type === 'success' ? 'check-circle' :
                     type === 'error' ? 'exclamation-circle' :
                     type === 'warning' ? 'exclamation-triangle' : 'info-circle';

        toast.innerHTML = '<div class="flex items-center"><i class="fas fa-' + icon + ' mr-2"></i><span>' + message + '</span></div>';

        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (container.contains(toast)) {
              container.removeChild(toast);
            }
          }, 300);
        }, duration);
      }

      function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorDiv = field.parentElement.querySelector('.error-message');
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.classList.add('show');
          field.classList.add('border-red-500');
        }
      }

      function clearFieldErrors() {
        document.querySelectorAll('.error-message').forEach(el => {
          el.classList.remove('show');
          el.textContent = '';
        });
        document.querySelectorAll('.border-red-500').forEach(el => {
          el.classList.remove('border-red-500');
        });
      }

      function validateForm() {
        clearFieldErrors();
        let isValid = true;

        const name = document.getElementById('name').value.trim();
        if (!name) {
          showFieldError('name', 'è¯·è¾“å…¥è®¢é˜…åç§°');
          isValid = false;
        }

        const periodValue = document.getElementById('periodValue').value;
        if (!periodValue || periodValue < 1) {
          showFieldError('periodValue', 'å‘¨æœŸæ•°å€¼å¿…é¡»å¤§äº0');
          isValid = false;
        }

        const expiryDate = document.getElementById('expiryDate').value;
        if (!expiryDate) {
          showFieldError('expiryDate', 'è¯·é€‰æ‹©åˆ°æœŸæ—¥æœŸ');
          isValid = false;
        }

        const reminderDays = document.getElementById('reminderDays').value;
        if (reminderDays === '' || reminderDays < 0) {
          showFieldError('reminderDays', 'æé†’å¤©æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
          isValid = false;
        }

        return isValid;
      }

      // åˆ›å»ºå¸¦æ‚¬æµ®æç¤ºçš„æ–‡æœ¬å…ƒç´ 
      function createHoverText(text, maxLength = 30, className = 'text-sm text-gray-900') {
        if (!text || text.length <= maxLength) {
          return '<div class="' + className + '">' + text + '</div>';
        }

        const truncated = text.substring(0, maxLength) + '...';
        return '<div class="hover-container">' +
          '<div class="hover-text ' + className + '" data-full-text="' + text.replace(/"/g, '"') + '">' +
            truncated +
          '</div>' +
          '<div class="hover-tooltip"></div>' +
        '</div>';
      }

      // è·å–æ‰€æœ‰è®¢é˜…å¹¶æŒ‰åˆ°æœŸæ—¶é—´æ’åº
      async function loadSubscriptions() {
        try {
          // åŠ è½½å†œå†æ˜¾ç¤ºåå¥½
          const listShowLunar = document.getElementById('listShowLunar');
          const saved = localStorage.getItem('showLunar');
          if (saved !== null) {
            listShowLunar.checked = saved === 'true';
          } else {
            listShowLunar.checked = true; // é»˜è®¤æ˜¾ç¤º
          }

          const tbody = document.getElementById('subscriptionsBody');
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ä¸­...</td></tr>';

          const response = await fetch('/api/subscriptions');
          const data = await response.json();

          tbody.innerHTML = '';

          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">æ²¡æœ‰è®¢é˜…æ•°æ®</td></tr>';
            return;
          }

          // æŒ‰åˆ°æœŸæ—¶é—´å‡åºæ’åºï¼ˆæœ€æ—©åˆ°æœŸçš„åœ¨å‰ï¼‰
          data.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

  		//æ–°å¢ä¿®æ”¹ï¼Œæ·»åŠ æ—¥å†ç±»å‹
          data.forEach(subscription => {
            const row = document.createElement('tr');
            row.className = subscription.isActive === false ? 'hover:bg-gray-50 bg-gray-100' : 'hover:bg-gray-50';

  		  // æ–°å¢ä¿®æ”¹ï¼šæ—¥å†ç±»å‹æ˜¾ç¤º
  		  let calendarTypeHtml = '';
  		  if (subscription.useLunar) {
  			calendarTypeHtml = '<div class="text-xs text-purple-600 mt-1">æ—¥å†ç±»å‹ï¼šå†œå†</div>';
  		  } else {
  			calendarTypeHtml = '<div class="text-xs text-gray-600 mt-1">æ—¥å†ç±»å‹ï¼šå…¬å†</div>';
  		  }

            const expiryDate = new Date(subscription.expiryDate);
            const now = new Date();
            const daysDiff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

            let statusHtml = '';
            if (!subscription.isActive) {
              statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-gray-500"><i class="fas fa-pause-circle mr-1"></i>å·²åœç”¨</span>';
            } else if (daysDiff < 0) {
              statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-red-500"><i class="fas fa-exclamation-circle mr-1"></i>å·²è¿‡æœŸ</span>';
            } else if (daysDiff <= (subscription.reminderDays || 7)) {
              statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-yellow-500"><i class="fas fa-exclamation-triangle mr-1"></i>å³å°†åˆ°æœŸ</span>';
            } else {
              statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-green-500"><i class="fas fa-check-circle mr-1"></i>æ­£å¸¸</span>';
            }

            let periodText = '';
            if (subscription.periodValue && subscription.periodUnit) {
              const unitMap = { day: 'å¤©', month: 'æœˆ', year: 'å¹´' };
              periodText = subscription.periodValue + ' ' + (unitMap[subscription.periodUnit] || subscription.periodUnit);
            }

            const autoRenewIcon = subscription.autoRenew !== false ? 
              '<i class="fas fa-sync-alt text-blue-500 ml-1" title="è‡ªåŠ¨ç»­è®¢"></i>' : 
              '<i class="fas fa-ban text-gray-400 ml-1" title="ä¸è‡ªåŠ¨ç»­è®¢"></i>';

            // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå†œå†
            const showLunar = document.getElementById('listShowLunar').checked;
            let lunarExpiryText = '';
            let startLunarText = '';

            if (showLunar) {
              // è®¡ç®—å†œå†æ—¥æœŸ
              const expiryDateObj = new Date(subscription.expiryDate);
              const lunarExpiry = lunarCalendar.solar2lunar(expiryDateObj.getFullYear(), expiryDateObj.getMonth() + 1, expiryDateObj.getDate());
              lunarExpiryText = lunarExpiry ? lunarExpiry.fullStr : '';

              if (subscription.startDate) {
                const startDateObj = new Date(subscription.startDate);
                const lunarStart = lunarCalendar.solar2lunar(startDateObj.getFullYear(), startDateObj.getMonth() + 1, startDateObj.getDate());
                startLunarText = lunarStart ? lunarStart.fullStr : '';
              }
            }

            // å¤„ç†å¤‡æ³¨æ˜¾ç¤º
            let notesHtml = '';
            if (subscription.notes) {
              const notes = subscription.notes;
              if (notes.length > 50) {
                const truncatedNotes = notes.substring(0, 50) + '...';
                notesHtml = '<div class="notes-container">' +
                  '<div class="notes-text text-xs text-gray-500" data-full-notes="' + notes.replace(/"/g, '"') + '">' +
                    truncatedNotes +
                  '</div>' +
                  '<div class="notes-tooltip"></div>' +
                '</div>';
              } else {
                notesHtml = '<div class="text-xs text-gray-500">' + notes + '</div>';
              }
            }

  		  // ç”Ÿæˆå„åˆ—å†…å®¹
  		  const nameHtml = createHoverText(subscription.name, 20, 'text-sm font-medium text-gray-900');
  		  const typeHtml = createHoverText((subscription.customType || 'å…¶ä»–'), 15, 'text-sm text-gray-900');
  		  const periodHtml = periodText ? createHoverText('å‘¨æœŸ: ' + periodText, 20, 'text-xs text-gray-500 mt-1') : '';

            // åˆ°æœŸæ—¶é—´ç›¸å…³ä¿¡æ¯
            const expiryDateText = formatBeijingTime(new Date(subscription.expiryDate), 'date');
            const lunarHtml = lunarExpiryText ? createHoverText('å†œå†: ' + lunarExpiryText, 25, 'text-xs text-blue-600 mt-1') : '';
            const daysLeftText = daysDiff < 0 ? 'å·²è¿‡æœŸ' + Math.abs(daysDiff) + 'å¤©' : 'è¿˜å‰©' + daysDiff + 'å¤©';
            const startDateText = subscription.startDate ?
              'å¼€å§‹: ' + formatBeijingTime(new Date(subscription.startDate), 'date') + (startLunarText ? ' (' + startLunarText + ')' : '') : '';
            const startDateHtml = startDateText ? createHoverText(startDateText, 30, 'text-xs text-gray-500 mt-1') : '';

  		  //æ–°å¢ä¿®æ”¹ï¼Œä¿®æ”¹æ—¥å†ç±»å‹
  		  row.innerHTML =
  			'<td data-label="åç§°" class="px-4 py-3"><div class="td-content-wrapper">' +
  			  nameHtml +
  			  notesHtml +
  			'</div></td>' +
  			'<td data-label="ç±»å‹" class="px-4 py-3"><div class="td-content-wrapper">' +
  			  '<div class="flex items-center"><i class="fas fa-tag mr-1"></i><span>' + typeHtml + '</span></div>' +
  			  (periodHtml ? '<div class="flex items-center">' + periodHtml + autoRenewIcon + '</div>' : '') +
  			  calendarTypeHtml + // æ–°å¢ï¼šæ—¥å†ç±»å‹
  			'</div></td>' +
  			// ...existing code...
  			'<td data-label="åˆ°æœŸæ—¶é—´" class="px-4 py-3"><div class="td-content-wrapper">' +
  			  '<div class="text-sm text-gray-900">' + expiryDateText + '</div>' +
  			  lunarHtml +
  			  '<div class="text-xs text-gray-500 mt-1">' + daysLeftText + '</div>' +
  			  startDateHtml +
  			'</div></td>' +
  			// ...existing code...
  			'<td data-label="æé†’è®¾ç½®" class="px-4 py-3"><div class="td-content-wrapper">' +
  			  '<div><i class="fas fa-bell mr-1"></i>æå‰' + (subscription.reminderDays || 0) + 'å¤©</div>' +
  			  (subscription.reminderDays === 0 ? '<div class="text-xs text-gray-500 mt-1">ä»…åˆ°æœŸæ—¥æé†’</div>' : '') +
  			'</div></td>' +
  			'<td data-label="çŠ¶æ€" class="px-4 py-3"><div class="td-content-wrapper">' + statusHtml + '</div></td>' +
  			'<td data-label="æ“ä½œ" class="px-4 py-3">' +
  			  '<div class="action-buttons-wrapper">' +
  				'<button class="edit btn-primary text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '"><i class="fas fa-edit mr-1"></i>ç¼–è¾‘</button>' +
  				'<button class="test-notify btn-info text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '"><i class="fas fa-paper-plane mr-1"></i>æµ‹è¯•</button>' +
  				'<button class="delete btn-danger text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '"><i class="fas fa-trash-alt mr-1"></i>åˆ é™¤</button>' +
  				(subscription.isActive ?
  				  '<button class="toggle-status btn-warning text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '" data-action="deactivate"><i class="fas fa-pause-circle mr-1"></i>åœç”¨</button>' :
  				  '<button class="toggle-status btn-success text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '" data-action="activate"><i class="fas fa-play-circle mr-1"></i>å¯ç”¨</button>') +
  			  '</div>' +
  			'</td>';

  		  tbody.appendChild(row);
          });

          document.querySelectorAll('.edit').forEach(button => {
            button.addEventListener('click', editSubscription);
          });

          document.querySelectorAll('.delete').forEach(button => {
            button.addEventListener('click', deleteSubscription);
          });

          document.querySelectorAll('.toggle-status').forEach(button => {
            button.addEventListener('click', toggleSubscriptionStatus);
          });

          document.querySelectorAll('.test-notify').forEach(button => {
            button.addEventListener('click', testSubscriptionNotification);
          });

          // æ·»åŠ æ‚¬åœåŠŸèƒ½
          function addHoverListeners() {
            // è®¡ç®—æ‚¬æµ®æç¤ºä½ç½®
            function positionTooltip(element, tooltip) {
              const rect = element.getBoundingClientRect();
              const tooltipHeight = 100; // é¢„ä¼°é«˜åº¦
              const viewportHeight = window.innerHeight;
              const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

              let top = rect.bottom + scrollTop + 8;
              let left = rect.left;

              // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
              if (rect.bottom + tooltipHeight > viewportHeight) {
                top = rect.top + scrollTop - tooltipHeight - 8;
                tooltip.style.transform = 'translateY(10px)';
                // è°ƒæ•´ç®­å¤´ä½ç½®
                tooltip.classList.add('tooltip-above');
              } else {
                tooltip.style.transform = 'translateY(-10px)';
                tooltip.classList.remove('tooltip-above');
              }

              // ç¡®ä¿ä¸è¶…å‡ºå³è¾¹ç•Œ
              const maxLeft = window.innerWidth - 320 - 20;
              if (left > maxLeft) {
                left = maxLeft;
              }

              tooltip.style.left = left + 'px';
              tooltip.style.top = top + 'px';
            }

            // å¤‡æ³¨æ‚¬åœåŠŸèƒ½
            document.querySelectorAll('.notes-text').forEach(notesElement => {
              const fullNotes = notesElement.getAttribute('data-full-notes');
              const tooltip = notesElement.parentElement.querySelector('.notes-tooltip');

              if (fullNotes && tooltip) {
                notesElement.addEventListener('mouseenter', () => {
                  tooltip.textContent = fullNotes;
                  positionTooltip(notesElement, tooltip);
                  tooltip.classList.add('show');
                });

                notesElement.addEventListener('mouseleave', () => {
                  tooltip.classList.remove('show');
                });

                // æ»šåŠ¨æ—¶éšè—æç¤º
                window.addEventListener('scroll', () => {
                  if (tooltip.classList.contains('show')) {
                    tooltip.classList.remove('show');
                  }
                }, { passive: true });
              }
            });

            // é€šç”¨æ‚¬åœåŠŸèƒ½
            document.querySelectorAll('.hover-text').forEach(hoverElement => {
              const fullText = hoverElement.getAttribute('data-full-text');
              const tooltip = hoverElement.parentElement.querySelector('.hover-tooltip');

              if (fullText && tooltip) {
                hoverElement.addEventListener('mouseenter', () => {
                  tooltip.textContent = fullText;
                  positionTooltip(hoverElement, tooltip);
                  tooltip.classList.add('show');
                });

                hoverElement.addEventListener('mouseleave', () => {
                  tooltip.classList.remove('show');
                });

                // æ»šåŠ¨æ—¶éšè—æç¤º
                window.addEventListener('scroll', () => {
                  if (tooltip.classList.contains('show')) {
                    tooltip.classList.remove('show');
                  }
                }, { passive: true });
              }
            });
          }

          addHoverListeners();

          // æ·»åŠ å†œå†å¼€å…³äº‹ä»¶ç›‘å¬
          listShowLunar.removeEventListener('change', handleListLunarToggle);
          listShowLunar.addEventListener('change', handleListLunarToggle);
        } catch (error) {
          console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
          const tbody = document.getElementById('subscriptionsBody');
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</td></tr>';
          showToast('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥', 'error');
        }
      }

      async function testSubscriptionNotification(e) {
          const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
          const id = button.dataset.id;
          const originalContent = button.innerHTML;
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>';
          button.disabled = true;

          try {
              const response = await fetch('/api/subscriptions/' + id + '/test-notify', { method: 'POST' });
              const result = await response.json();
              if (result.success) {
                  showToast(result.message || 'æµ‹è¯•é€šçŸ¥å·²å‘é€', 'success');
              } else {
                  showToast(result.message || 'æµ‹è¯•é€šçŸ¥å‘é€å¤±è´¥', 'error');
              }
          } catch (error) {
              console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
              showToast('å‘é€æµ‹è¯•é€šçŸ¥æ—¶å‘ç”Ÿé”™è¯¯', 'error');
          } finally {
              button.innerHTML = originalContent;
              button.disabled = false;
          }
      }

      async function toggleSubscriptionStatus(e) {
        const id = e.target.dataset.id || e.target.parentElement.dataset.id;
        const action = e.target.dataset.action || e.target.parentElement.dataset.action;
        const isActivate = action === 'activate';

        const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + (isActivate ? 'å¯ç”¨ä¸­...' : 'åœç”¨ä¸­...');
        button.disabled = true;

        try {
          const response = await fetch('/api/subscriptions/' + id + '/toggle-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isActive: isActivate })
          });

          if (response.ok) {
            showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'æˆåŠŸ', 'success');
            loadSubscriptions();
          } else {
            const error = await response.json();
            showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        } catch (error) {
          console.error((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'è®¢é˜…å¤±è´¥:', error);
          showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      }

      document.getElementById('addSubscriptionBtn').addEventListener('click', () => {
        document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°è®¢é˜…';
        document.getElementById('subscriptionModal').classList.remove('hidden');

        document.getElementById('subscriptionForm').reset();
        document.getElementById('subscriptionId').value = '';
        clearFieldErrors();

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('reminderDays').value = '7';
        document.getElementById('isActive').checked = true;
        document.getElementById('autoRenew').checked = true;

        loadLunarPreference();
        calculateExpiryDate();
        setupModalEventListeners();
      });

      function setupModalEventListeners() {
        document.getElementById('calculateExpiryBtn').removeEventListener('click', calculateExpiryDate);
        document.getElementById('calculateExpiryBtn').addEventListener('click', calculateExpiryDate);
  	  document.getElementById('useLunar').removeEventListener('change', calculateExpiryDate);//æ–°å¢ä¿®æ”¹ï¼Œ
  	  document.getElementById('useLunar').addEventListener('change', calculateExpiryDate);//æ–°å¢ä¿®æ”¹ï¼Œ

        ['startDate', 'periodValue', 'periodUnit'].forEach(id => {
          const element = document.getElementById(id);
          element.removeEventListener('change', calculateExpiryDate);
          element.addEventListener('change', calculateExpiryDate);
  		document.getElementById('useLunar').removeEventListener('change', calculateExpiryDate);//æ–°å¢ä¿®æ”¹ï¼Œ
  	    document.getElementById('useLunar').addEventListener('change', calculateExpiryDate);//æ–°å¢ä¿®æ”¹ï¼Œ
        });

        // æ·»åŠ å†œå†æ˜¾ç¤ºäº‹ä»¶ç›‘å¬
        document.getElementById('showLunar').removeEventListener('change', toggleLunarDisplay);
        document.getElementById('showLunar').addEventListener('change', toggleLunarDisplay);

        document.getElementById('startDate').removeEventListener('change', () => updateLunarDisplay('startDate', 'startDateLunar'));
        document.getElementById('startDate').addEventListener('change', () => updateLunarDisplay('startDate', 'startDateLunar'));

        document.getElementById('expiryDate').removeEventListener('change', () => updateLunarDisplay('expiryDate', 'expiryDateLunar'));
        document.getElementById('expiryDate').addEventListener('change', () => updateLunarDisplay('expiryDate', 'expiryDateLunar'));

        document.getElementById('cancelBtn').addEventListener('click', () => {
          document.getElementById('subscriptionModal').classList.add('hidden');
        });
      }

  	// 3. æ–°å¢ä¿®æ”¹ï¼Œ calculateExpiryDate å‡½æ•°ï¼Œæ”¯æŒå†œå†å‘¨æœŸæ¨ç®—   
  	function calculateExpiryDate() {
  	  const startDate = document.getElementById('startDate').value;
  	  const periodValue = parseInt(document.getElementById('periodValue').value);
  	  const periodUnit = document.getElementById('periodUnit').value;
  	  const useLunar = document.getElementById('useLunar').checked;

  	  if (!startDate || !periodValue || !periodUnit) {
  		return;
  	  }

  	  if (useLunar) {
  		// å†œå†æ¨ç®—
  		const start = new Date(startDate);
  		const lunar = lunarCalendar.solar2lunar(start.getFullYear(), start.getMonth() + 1, start.getDate());
  		let nextLunar = addLunarPeriod(lunar, periodValue, periodUnit);
  		const solar = lunar2solar(nextLunar);
  		//const expiry = new Date(solar.year, solar.month - 1, solar.day);

  		  // ä½¿ç”¨ä¸å…¬å†ç›¸åŒçš„æ–¹å¼åˆ›å»ºæ—¥æœŸ  
    const expiry = new Date(startDate); // ä»åŸå§‹æ—¥æœŸå¼€å§‹  
    expiry.setFullYear(solar.year);  
    expiry.setMonth(solar.month - 1);  
    expiry.setDate(solar.day);  
  		document.getElementById('expiryDate').value = expiry.toISOString().split('T')[0];
  		console.log('start:', start);
  		console.log('nextLunar:', nextLunar);
  		console.log('expiry:', expiry);
  		console.log('expiryDate:', document.getElementById('expiryDate').value);

  		console.log('solar from lunar2solar:', solar);  
  		console.log('solar.year:', solar.year, 'solar.month:', solar.month, 'solar.day:', solar.day);
  		console.log('expiry.getTime():', expiry.getTime());  
  console.log('expiry.toString():', expiry.toString());


  	  } else {
  		// å…¬å†æ¨ç®—
  		const start = new Date(startDate);
  		const expiry = new Date(start);
  		if (periodUnit === 'day') {
  		  expiry.setDate(start.getDate() + periodValue);
  		} else if (periodUnit === 'month') {
  		  expiry.setMonth(start.getMonth() + periodValue);
  		} else if (periodUnit === 'year') {
  		  expiry.setFullYear(start.getFullYear() + periodValue);
  		}
  		document.getElementById('expiryDate').value = expiry.toISOString().split('T')[0];
  		console.log('start:', start);
  		console.log('expiry:', expiry);
  		console.log('expiryDate:', document.getElementById('expiryDate').value);
  	  }

  	  // æ›´æ–°å†œå†æ˜¾ç¤º
  	  updateLunarDisplay('startDate', 'startDateLunar');
  	  updateLunarDisplay('expiryDate', 'expiryDateLunar');
  	}

      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('subscriptionModal').classList.add('hidden');
      });

      // ç¦æ­¢ç‚¹å‡»å¼¹çª—å¤–åŒºåŸŸå…³é—­å¼¹çª—ï¼Œé˜²æ­¢è¯¯æ“ä½œä¸¢å¤±å†…å®¹
      // document.getElementById('subscriptionModal').addEventListener('click', (event) => {
      //   if (event.target === document.getElementById('subscriptionModal')) {
      //     document.getElementById('subscriptionModal').classList.add('hidden');
      //   }
      // });


  	// 4. æ–°å¢ä¿®æ”¹ï¼Œç›‘å¬ useLunar å¤é€‰æ¡†å˜åŒ–æ—¶ä¹Ÿè‡ªåŠ¨é‡æ–°è®¡ç®—
  	document.getElementById('useLunar').addEventListener('change', calculateExpiryDate);   
     // æ–°å¢ä¿®æ”¹ï¼Œè¡¨å•æäº¤æ—¶å¸¦ä¸Š useLunar å­—æ®µ
      document.getElementById('subscriptionForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!validateForm()) {
          return;
        }

        const id = document.getElementById('subscriptionId').value;
        const subscription = {
          name: document.getElementById('name').value.trim(),
          customType: document.getElementById('customType').value.trim(),
          notes: document.getElementById('notes').value.trim() || '',
          isActive: document.getElementById('isActive').checked,
          autoRenew: document.getElementById('autoRenew').checked,
          startDate: document.getElementById('startDate').value,
          expiryDate: document.getElementById('expiryDate').value,
          periodValue: parseInt(document.getElementById('periodValue').value),
          periodUnit: document.getElementById('periodUnit').value,
          reminderDays: parseInt(document.getElementById('reminderDays').value) || 0,
  		useLunar: document.getElementById('useLunar').checked // æ–°å¢ä¿®æ”¹
        };

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalContent = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + (id ? 'æ›´æ–°ä¸­...' : 'ä¿å­˜ä¸­...');
        submitButton.disabled = true;

        try {
          const url = id ? '/api/subscriptions/' + id : '/api/subscriptions';
          const method = id ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscription)
          });

          const result = await response.json();

          if (result.success) {
            showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…æˆåŠŸ', 'success');
            document.getElementById('subscriptionModal').classList.add('hidden');
            loadSubscriptions();
          } else {
            showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        } catch (error) {
          console.error((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥:', error);
          showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        } finally {
          submitButton.innerHTML = originalContent;
          submitButton.disabled = false;
        }
      });

  	// æ–°å¢ä¿®æ”¹ï¼Œç¼–è¾‘è®¢é˜…æ—¶å›æ˜¾ useLunar å­—æ®µ
      async function editSubscription(e) {
        const id = e.target.dataset.id || e.target.parentElement.dataset.id;

        try {
          const response = await fetch('/api/subscriptions/' + id);
          const subscription = await response.json();

          if (subscription) {
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è®¢é˜…';
            document.getElementById('subscriptionId').value = subscription.id;
            document.getElementById('name').value = subscription.name;
            document.getElementById('customType').value = subscription.customType || '';
            document.getElementById('notes').value = subscription.notes || '';
            document.getElementById('isActive').checked = subscription.isActive !== false;
            document.getElementById('autoRenew').checked = subscription.autoRenew !== false;
            document.getElementById('startDate').value = subscription.startDate ? subscription.startDate.split('T')[0] : '';
            document.getElementById('expiryDate').value = subscription.expiryDate ? subscription.expiryDate.split('T')[0] : '';
            document.getElementById('periodValue').value = subscription.periodValue || 1;
            document.getElementById('periodUnit').value = subscription.periodUnit || 'month';
            document.getElementById('reminderDays').value = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;
  		  document.getElementById('useLunar').checked = !!subscription.useLunar; // æ–°å¢ä¿®æ”¹

            clearFieldErrors();
            loadLunarPreference();
            document.getElementById('subscriptionModal').classList.remove('hidden');
            setupModalEventListeners();

            // æ›´æ–°å†œå†æ˜¾ç¤º
            setTimeout(() => {
              updateLunarDisplay('startDate', 'startDateLunar');
              updateLunarDisplay('expiryDate', 'expiryDateLunar');
            }, 100);
          }
        } catch (error) {
          console.error('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥:', error);
          showToast('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥', 'error');
        }
      }

      async function deleteSubscription(e) {
        const id = e.target.dataset.id || e.target.parentElement.dataset.id;

        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
          return;
        }

        const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>åˆ é™¤ä¸­...';
        button.disabled = true;

        try {
          const response = await fetch('/api/subscriptions/' + id, {
            method: 'DELETE'
          });

          if (response.ok) {
            showToast('åˆ é™¤æˆåŠŸ', 'success');
            loadSubscriptions();
          } else {
            const error = await response.json();
            showToast('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        } catch (error) {
          console.error('åˆ é™¤è®¢é˜…å¤±è´¥:', error);
          showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      }

      window.addEventListener('load', loadSubscriptions);
    </script>
  </body>
  </html>
  `;

  const configPage = `
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿé…ç½® - è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
      .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
      .btn-secondary { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); transition: all 0.3s; }
      .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }

      .toast {
        position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
        color: white; font-weight: 500; z-index: 1000; transform: translateX(400px);
        transition: all 0.3s ease-in-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .toast.show { transform: translateX(0); }
      .toast.success { background-color: #10b981; }
      .toast.error { background-color: #ef4444; }
      .toast.info { background-color: #3b82f6; }
      .toast.warning { background-color: #f59e0b; }

      .config-section { 
        border: 1px solid #e5e7eb; 
        border-radius: 8px; 
        padding: 16px; 
        margin-bottom: 24px; 
      }
      .config-section.active { 
        background-color: #f8fafc; 
        border-color: #6366f1; 
      }
      .config-section.inactive { 
        background-color: #f9fafb; 
        opacity: 0.7; 
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="toast-container"></div>

    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
          </div>
          <div class="flex items-center space-x-4">
            <a href="/admin" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
            </a>
            <a href="/admin/config" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
            </a>
            <a href="/api/logout" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»ç»Ÿé…ç½®</h2>

        <form id="configForm" class="space-y-8">
          <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">ç®¡ç†å‘˜è´¦æˆ·</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="adminUsername" class="block text-sm font-medium text-gray-700">ç”¨æˆ·å</label>
                <input type="text" id="adminUsername" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="adminPassword" class="block text-sm font-medium text-gray-700">å¯†ç </label>
                <input type="password" id="adminPassword" placeholder="å¦‚ä¸ä¿®æ”¹å¯†ç ï¼Œè¯·ç•™ç©º" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å½“å‰å¯†ç </p>
              </div>
            </div>
          </div>

          <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">æ˜¾ç¤ºè®¾ç½®</h3>
            <div class="mb-6">
              <label class="inline-flex items-center">
                <input type="checkbox" id="showLunarGlobal" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                <span class="ml-2 text-sm text-gray-700">åœ¨é€šçŸ¥ä¸­æ˜¾ç¤ºå†œå†æ—¥æœŸ</span>
              </label>
              <p class="mt-1 text-sm text-gray-500">æ§åˆ¶æ˜¯å¦åœ¨é€šçŸ¥æ¶ˆæ¯ä¸­åŒ…å«å†œå†æ—¥æœŸä¿¡æ¯</p>
            </div>
          </div>

          <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">é€šçŸ¥è®¾ç½®</h3>
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-3">é€šçŸ¥æ–¹å¼ï¼ˆå¯å¤šé€‰ï¼‰</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="enabledNotifiers" value="telegram" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">Telegram</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="enabledNotifiers" value="notifyx" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                  <span class="ml-2 text-sm text-gray-700 font-semibold">NotifyX</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="enabledNotifiers" value="webhook" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="enabledNotifiers" value="wechatbot" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="enabledNotifiers" value="email" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">é‚®ä»¶é€šçŸ¥</span>
                </label>
              </div>
              <div class="mt-2 flex flex-wrap gap-4">
                <a href="https://www.notifyx.cn/" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                  <i class="fas fa-external-link-alt ml-1"></i> NotifyXå®˜ç½‘
                </a>
                <a href="https://push.wangwangit.com" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                  <i class="fas fa-external-link-alt ml-1"></i> ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥å®˜ç½‘
                </a>
                <a href="https://developer.work.weixin.qq.com/document/path/91770" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                  <i class="fas fa-external-link-alt ml-1"></i> ä¼ä¸šå¾®ä¿¡æœºå™¨äººæ–‡æ¡£
                </a>
                <a href="https://developers.cloudflare.com/workers/tutorials/send-emails-with-resend/" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                  <i class="fas fa-external-link-alt ml-1"></i> è·å– Resend API Key
                </a>
              </div>
            </div>

            <div id="telegramConfig" class="config-section">
              <h4 class="text-md font-medium text-gray-900 mb-3">Telegram é…ç½®</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label for="tgBotToken" class="block text-sm font-medium text-gray-700">Bot Token</label>
                  <input type="text" id="tgBotToken" placeholder="ä» @BotFather è·å–" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                  <label for="tgChatId" class="block text-sm font-medium text-gray-700">Chat ID</label>
                  <input type="text" id="tgChatId" placeholder="å¯ä» @userinfobot è·å–" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
              </div>
              <div class="flex justify-end">
                <button type="button" id="testTelegramBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                  <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• Telegram é€šçŸ¥
                </button>
              </div>
            </div>

            <div id="notifyxConfig" class="config-section">
              <h4 class="text-md font-medium text-gray-900 mb-3">NotifyX é…ç½®</h4>
              <div class="mb-4">
                <label for="notifyxApiKey" class="block text-sm font-medium text-gray-700">API Key</label>
                <input type="text" id="notifyxApiKey" placeholder="ä» NotifyX å¹³å°è·å–çš„ API Key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">ä» <a href="https://www.notifyx.cn/" target="_blank" class="text-indigo-600 hover:text-indigo-800">NotifyXå¹³å°</a> è·å–çš„ API Key</p>
              </div>
              <div class="flex justify-end">
                <button type="button" id="testNotifyXBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                  <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• NotifyX é€šçŸ¥
                </button>
              </div>
            </div>

            <div id="webhookConfig" class="config-section">
              <h4 class="text-md font-medium text-gray-900 mb-3">ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥ é…ç½®</h4>
              <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label for="webhookUrl" class="block text-sm font-medium text-gray-700">ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥ URL</label>
                  <input type="url" id="webhookUrl" placeholder="https://push.wangwangit.com/api/send/your-key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">ä» <a href="https://push.wangwangit.com" target="_blank" class="text-indigo-600 hover:text-indigo-800">ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥å¹³å°</a> è·å–çš„æ¨é€URL</p>
                </div>
                <div>
                  <label for="webhookMethod" class="block text-sm font-medium text-gray-700">è¯·æ±‚æ–¹æ³•</label>
                  <select id="webhookMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                    <option value="PUT">PUT</option>
                  </select>
                </div>
                <div>
                  <label for="webhookHeaders" class="block text-sm font-medium text-gray-700">è‡ªå®šä¹‰è¯·æ±‚å¤´ (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                  <textarea id="webhookHeaders" rows="3" placeholder='{"Authorization": "Bearer your-token", "Content-Type": "application/json"}' class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                  <p class="mt-1 text-sm text-gray-500">JSONæ ¼å¼çš„è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤</p>
                </div>
                <div>
                  <label for="webhookTemplate" class="block text-sm font-medium text-gray-700">æ¶ˆæ¯æ¨¡æ¿ (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                  <textarea id="webhookTemplate" rows="4" placeholder='{"title": "{{title}}", "content": "{{content}}", "timestamp": "{{timestamp}}"}' class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                  <p class="mt-1 text-sm text-gray-500">æ”¯æŒå˜é‡: {{title}}, {{content}}, {{timestamp}}ã€‚ç•™ç©ºä½¿ç”¨é»˜è®¤æ ¼å¼</p>
                </div>
              </div>
              <div class="flex justify-end">
                <button type="button" id="testWebhookBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                  <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥
                </button>
              </div>
            </div>

            <div id="wechatbotConfig" class="config-section">
              <h4 class="text-md font-medium text-gray-900 mb-3">ä¼ä¸šå¾®ä¿¡æœºå™¨äºº é…ç½®</h4>
              <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label for="wechatbotWebhook" class="block text-sm font-medium text-gray-700">æœºå™¨äºº Webhook URL</label>
                  <input type="url" id="wechatbotWebhook" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">ä»ä¼ä¸šå¾®ä¿¡ç¾¤èŠä¸­æ·»åŠ æœºå™¨äººè·å–çš„ Webhook URL</p>
                </div>
                <div>
                  <label for="wechatbotMsgType" class="block text-sm font-medium text-gray-700">æ¶ˆæ¯ç±»å‹</label>
                  <select id="wechatbotMsgType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="text">æ–‡æœ¬æ¶ˆæ¯</option>
                    <option value="markdown">Markdownæ¶ˆæ¯</option>
                  </select>
                  <p class="mt-1 text-sm text-gray-500">é€‰æ‹©å‘é€çš„æ¶ˆæ¯æ ¼å¼ç±»å‹</p>
                </div>
                <div>
                  <label for="wechatbotAtMobiles" class="block text-sm font-medium text-gray-700">@æ‰‹æœºå· (å¯é€‰)</label>
                  <input type="text" id="wechatbotAtMobiles" placeholder="13800138000,13900139000" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">éœ€è¦@çš„æ‰‹æœºå·ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™ä¸@ä»»ä½•äºº</p>
                </div>
                <div>
                  <label for="wechatbotAtAll" class="block text-sm font-medium text-gray-700 mb-2">@æ‰€æœ‰äºº</label>
                  <label class="inline-flex items-center">
                    <input type="checkbox" id="wechatbotAtAll" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700">å‘é€æ¶ˆæ¯æ—¶@æ‰€æœ‰äºº</span>
                  </label>
                </div>
              </div>
              <div class="flex justify-end">
                <button type="button" id="testWechatBotBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                  <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• ä¼ä¸šå¾®ä¿¡æœºå™¨äºº
                </button>
              </div>
            </div>

            <div id="emailConfig" class="config-section">
              <h4 class="text-md font-medium text-gray-900 mb-3">é‚®ä»¶é€šçŸ¥ é…ç½®</h4>
              <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                  <label for="resendApiKey" class="block text-sm font-medium text-gray-700">Resend API Key</label>
                  <input type="text" id="resendApiKey" placeholder="re_xxxxxxxxxx" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">ä» <a href="https://resend.com/api-keys" target="_blank" class="text-indigo-600 hover:text-indigo-800">Resendæ§åˆ¶å°</a> è·å–çš„ API Key</p>
                </div>
                <div>
                  <label for="emailFrom" class="block text-sm font-medium text-gray-700">å‘ä»¶äººé‚®ç®±</label>
                  <input type="email" id="emailFrom" placeholder="noreply@yourdomain.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">å¿…é¡»æ˜¯å·²åœ¨ResendéªŒè¯çš„åŸŸåé‚®ç®±</p>
                </div>
                <div>
                  <label for="emailFromName" class="block text-sm font-medium text-gray-700">å‘ä»¶äººåç§°</label>
                  <input type="text" id="emailFromName" placeholder="è®¢é˜…æé†’ç³»ç»Ÿ" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸­çš„å‘ä»¶äººåç§°</p>
                </div>
                <div>
                  <label for="emailTo" class="block text-sm font-medium text-gray-700">æ”¶ä»¶äººé‚®ç®±</label>
                  <input type="email" id="emailTo" placeholder="user@example.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">æ¥æ”¶é€šçŸ¥é‚®ä»¶çš„é‚®ç®±åœ°å€</p>
                </div>
              </div>
              <div class="flex justify-end">
                <button type="button" id="testEmailBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                  <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• é‚®ä»¶é€šçŸ¥
                </button>
              </div>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit" class="btn-primary text-white px-6 py-2 rounded-md text-sm font-medium">
              <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function showToast(message, type = 'success', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;

        const icon = type === 'success' ? 'check-circle' :
                     type === 'error' ? 'exclamation-circle' :
                     type === 'warning' ? 'exclamation-triangle' : 'info-circle';

        toast.innerHTML = '<div class="flex items-center"><i class="fas fa-' + icon + ' mr-2"></i><span>' + message + '</span></div>';

        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (container.contains(toast)) {
              container.removeChild(toast);
            }
          }, 300);
        }, duration);
      }

      async function loadConfig() {
        try {
          const response = await fetch('/api/config');
          const config = await response.json();

          document.getElementById('adminUsername').value = config.ADMIN_USERNAME || '';
          document.getElementById('tgBotToken').value = config.TG_BOT_TOKEN || '';
          document.getElementById('tgChatId').value = config.TG_CHAT_ID || '';
          document.getElementById('notifyxApiKey').value = config.NOTIFYX_API_KEY || '';
          document.getElementById('webhookUrl').value = config.WEBHOOK_URL || '';
          document.getElementById('webhookMethod').value = config.WEBHOOK_METHOD || 'POST';
          document.getElementById('webhookHeaders').value = config.WEBHOOK_HEADERS || '';
          document.getElementById('webhookTemplate').value = config.WEBHOOK_TEMPLATE || '';
          document.getElementById('wechatbotWebhook').value = config.WECHATBOT_WEBHOOK || '';
          document.getElementById('wechatbotMsgType').value = config.WECHATBOT_MSG_TYPE || 'text';
          document.getElementById('wechatbotAtMobiles').value = config.WECHATBOT_AT_MOBILES || '';
          document.getElementById('wechatbotAtAll').checked = config.WECHATBOT_AT_ALL === 'true';
          document.getElementById('resendApiKey').value = config.RESEND_API_KEY || '';
          document.getElementById('emailFrom').value = config.EMAIL_FROM || '';
          document.getElementById('emailFromName').value = config.EMAIL_FROM_NAME || 'è®¢é˜…æé†’ç³»ç»Ÿ';
          document.getElementById('emailTo').value = config.EMAIL_TO || '';

          // åŠ è½½å†œå†æ˜¾ç¤ºè®¾ç½®
          document.getElementById('showLunarGlobal').checked = config.SHOW_LUNAR === true;

          // å¤„ç†å¤šé€‰é€šçŸ¥æ¸ é“
          const enabledNotifiers = config.ENABLED_NOTIFIERS || ['notifyx'];
          document.querySelectorAll('input[name="enabledNotifiers"]').forEach(checkbox => {
            checkbox.checked = enabledNotifiers.includes(checkbox.value);
          });

          toggleNotificationConfigs(enabledNotifiers);
        } catch (error) {
          console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
          showToast('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        }
      }

      function toggleNotificationConfigs(enabledNotifiers) {
        const telegramConfig = document.getElementById('telegramConfig');
        const notifyxConfig = document.getElementById('notifyxConfig');
        const webhookConfig = document.getElementById('webhookConfig');
        const wechatbotConfig = document.getElementById('wechatbotConfig');
        const emailConfig = document.getElementById('emailConfig');

        // é‡ç½®æ‰€æœ‰é…ç½®åŒºåŸŸ
        [telegramConfig, notifyxConfig, webhookConfig, wechatbotConfig, emailConfig].forEach(config => {
          config.classList.remove('active', 'inactive');
          config.classList.add('inactive');
        });

        // æ¿€æ´»é€‰ä¸­çš„é…ç½®åŒºåŸŸ
        enabledNotifiers.forEach(type => {
          if (type === 'telegram') {
            telegramConfig.classList.remove('inactive');
            telegramConfig.classList.add('active');
          } else if (type === 'notifyx') {
            notifyxConfig.classList.remove('inactive');
            notifyxConfig.classList.add('active');
          } else if (type === 'webhook') {
            webhookConfig.classList.remove('inactive');
            webhookConfig.classList.add('active');
          } else if (type === 'wechatbot') {
            wechatbotConfig.classList.remove('inactive');
            wechatbotConfig.classList.add('active');
          } else if (type === 'email') {
            emailConfig.classList.remove('inactive');
            emailConfig.classList.add('active');
          }
        });
      }

      document.querySelectorAll('input[name="enabledNotifiers"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const enabledNotifiers = Array.from(document.querySelectorAll('input[name="enabledNotifiers"]:checked'))
            .map(cb => cb.value);
          toggleNotificationConfigs(enabledNotifiers);
        });
      });

      document.getElementById('configForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const enabledNotifiers = Array.from(document.querySelectorAll('input[name="enabledNotifiers"]:checked'))
          .map(cb => cb.value);

        if (enabledNotifiers.length === 0) {
          showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é€šçŸ¥æ–¹å¼', 'warning');
          return;
        }

        const config = {
          ADMIN_USERNAME: document.getElementById('adminUsername').value.trim(),
          TG_BOT_TOKEN: document.getElementById('tgBotToken').value.trim(),
          TG_CHAT_ID: document.getElementById('tgChatId').value.trim(),
          NOTIFYX_API_KEY: document.getElementById('notifyxApiKey').value.trim(),
          WEBHOOK_URL: document.getElementById('webhookUrl').value.trim(),
          WEBHOOK_METHOD: document.getElementById('webhookMethod').value,
          WEBHOOK_HEADERS: document.getElementById('webhookHeaders').value.trim(),
          WEBHOOK_TEMPLATE: document.getElementById('webhookTemplate').value.trim(),
          SHOW_LUNAR: document.getElementById('showLunarGlobal').checked,
          WECHATBOT_WEBHOOK: document.getElementById('wechatbotWebhook').value.trim(),
          WECHATBOT_MSG_TYPE: document.getElementById('wechatbotMsgType').value,
          WECHATBOT_AT_MOBILES: document.getElementById('wechatbotAtMobiles').value.trim(),
          WECHATBOT_AT_ALL: document.getElementById('wechatbotAtAll').checked.toString(),
          RESEND_API_KEY: document.getElementById('resendApiKey').value.trim(),
          EMAIL_FROM: document.getElementById('emailFrom').value.trim(),
          EMAIL_FROM_NAME: document.getElementById('emailFromName').value.trim(),
          EMAIL_TO: document.getElementById('emailTo').value.trim(),
          ENABLED_NOTIFIERS: enabledNotifiers
        };

        const passwordField = document.getElementById('adminPassword');
        if (passwordField.value.trim()) {
          config.ADMIN_PASSWORD = passwordField.value.trim();
        }

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalContent = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ä¿å­˜ä¸­...';
        submitButton.disabled = true;

        try {
          const response = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });

          const result = await response.json();

          if (result.success) {
            showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            passwordField.value = '';
          } else {
            showToast('é…ç½®ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        } catch (error) {
          console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
          showToast('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        } finally {
          submitButton.innerHTML = originalContent;
          submitButton.disabled = false;
        }
      });

      async function testNotification(type) {
        const buttonId = type === 'telegram' ? 'testTelegramBtn' :
                        type === 'notifyx' ? 'testNotifyXBtn' :
                        type === 'wechatbot' ? 'testWechatBotBtn' :
                        type === 'email' ? 'testEmailBtn' : 'testWebhookBtn';
        const button = document.getElementById(buttonId);
        const originalContent = button.innerHTML;
        const serviceName = type === 'telegram' ? 'Telegram' :
                            type === 'notifyx' ? 'NotifyX' :
                            type === 'wechatbot' ? 'ä¼ä¸šå¾®ä¿¡æœºå™¨äºº' :
                            type === 'email' ? 'é‚®ä»¶é€šçŸ¥' : 'ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥';

        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
        button.disabled = true;

        const config = {};
        if (type === 'telegram') {
          config.TG_BOT_TOKEN = document.getElementById('tgBotToken').value.trim();
          config.TG_CHAT_ID = document.getElementById('tgChatId').value.trim();

          if (!config.TG_BOT_TOKEN || !config.TG_CHAT_ID) {
            showToast('è¯·å…ˆå¡«å†™ Telegram Bot Token å’Œ Chat ID', 'warning');
            button.innerHTML = originalContent;
            button.disabled = false;
            return;
          }
        } else if (type === 'notifyx') {
          config.NOTIFYX_API_KEY = document.getElementById('notifyxApiKey').value.trim();

          if (!config.NOTIFYX_API_KEY) {
            showToast('è¯·å…ˆå¡«å†™ NotifyX API Key', 'warning');
            button.innerHTML = originalContent;
            button.disabled = false;
            return;
          }
        } else if (type === 'webhook') {
          config.WEBHOOK_URL = document.getElementById('webhookUrl').value.trim();
          config.WEBHOOK_METHOD = document.getElementById('webhookMethod').value;
          config.WEBHOOK_HEADERS = document.getElementById('webhookHeaders').value.trim();
          config.WEBHOOK_TEMPLATE = document.getElementById('webhookTemplate').value.trim();

          if (!config.WEBHOOK_URL) {
            showToast('è¯·å…ˆå¡«å†™ ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥ URL', 'warning');
            button.innerHTML = originalContent;
            button.disabled = false;
            return;
          }
        } else if (type === 'wechatbot') {
          config.WECHATBOT_WEBHOOK = document.getElementById('wechatbotWebhook').value.trim();
          config.WECHATBOT_MSG_TYPE = document.getElementById('wechatbotMsgType').value;
          config.WECHATBOT_AT_MOBILES = document.getElementById('wechatbotAtMobiles').value.trim();
          config.WECHATBOT_AT_ALL = document.getElementById('wechatbotAtAll').checked.toString();

          if (!config.WECHATBOT_WEBHOOK) {
            showToast('è¯·å…ˆå¡«å†™ä¼ä¸šå¾®ä¿¡æœºå™¨äºº Webhook URL', 'warning');
            button.innerHTML = originalContent;
            button.disabled = false;
            return;
          }
        } else if (type === 'email') {
          config.RESEND_API_KEY = document.getElementById('resendApiKey').value.trim();
          config.EMAIL_FROM = document.getElementById('emailFrom').value.trim();
          config.EMAIL_FROM_NAME = document.getElementById('emailFromName').value.trim();
          config.EMAIL_TO = document.getElementById('emailTo').value.trim();

          if (!config.RESEND_API_KEY || !config.EMAIL_FROM || !config.EMAIL_TO) {
            showToast('è¯·å…ˆå¡«å†™ Resend API Keyã€å‘ä»¶äººé‚®ç®±å’Œæ”¶ä»¶äººé‚®ç®±', 'warning');
            button.innerHTML = originalContent;
            button.disabled = false;
            return;
          }
        }

        try {
          const response = await fetch('/api/test-notification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: type, ...config })
          });

          const result = await response.json();

          if (result.success) {
            showToast(serviceName + ' é€šçŸ¥æµ‹è¯•æˆåŠŸï¼', 'success');
          } else {
            showToast(serviceName + ' é€šçŸ¥æµ‹è¯•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        } catch (error) {
          console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
          showToast('æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        } finally {
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      }

      document.getElementById('testTelegramBtn').addEventListener('click', () => {
        testNotification('telegram');
      });

      document.getElementById('testNotifyXBtn').addEventListener('click', () => {
        testNotification('notifyx');
      });

      document.getElementById('testWebhookBtn').addEventListener('click', () => {
        testNotification('webhook');
      });

      document.getElementById('testWechatBotBtn').addEventListener('click', () => {
        testNotification('wechatbot');
      });

      document.getElementById('testEmailBtn').addEventListener('click', () => {
        testNotification('email');
      });

      window.addEventListener('load', loadConfig);
    </script>
  </body>
  </html>
  `;

  // ç®¡ç†é¡µé¢
  const admin = {
    async handleRequest(request, env, ctx) {
      try {
        const url = new URL(request.url);
        const pathname = url.pathname;

        console.log('[ç®¡ç†é¡µé¢] è®¿é—®è·¯å¾„:', pathname);

        const token = getCookieValue(request.headers.get('Cookie'), 'token');
        console.log('[ç®¡ç†é¡µé¢] Tokenå­˜åœ¨:', !!token);

        const config = await getConfig(env);
        const user = token ? await verifyJWT(token, config.JWT_SECRET) : null;

        console.log('[ç®¡ç†é¡µé¢] ç”¨æˆ·éªŒè¯ç»“æœ:', !!user);

        if (!user) {
          console.log('[ç®¡ç†é¡µé¢] ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
          return new Response('', {
            status: 302,
            headers: { 'Location': '/' }
          });
        }

        if (pathname === '/admin/config') {
          return new Response(configPage, {
            headers: { 'Content-Type': 'text/html; charset=utf-8' }
          });
        }

        return new Response(adminPage, {
          headers: { 'Content-Type': 'text/html; charset=utf-8' }
        });
      } catch (error) {
        console.error('[ç®¡ç†é¡µé¢] å¤„ç†è¯·æ±‚æ—¶å‡ºé”™:', error);
        return new Response('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯', {
          status: 500,
          headers: { 'Content-Type': 'text/plain; charset=utf-8' }
        });
      }
    }
  };

  // å¤„ç†APIè¯·æ±‚
  const api = {
    async handleRequest(request, env, ctx) {
      const url = new URL(request.url);
      const path = url.pathname.slice(4);
      const method = request.method;

      const config = await getConfig(env);

      if (path === '/login' && method === 'POST') {
        const body = await request.json();

        if (body.username === config.ADMIN_USERNAME && body.password === config.ADMIN_PASSWORD) {
          const token = await generateJWT(body.username, config.JWT_SECRET);

          return new Response(
            JSON.stringify({ success: true }),
            {
              headers: {
                'Content-Type': 'application/json',
                'Set-Cookie': 'token=' + token + '; HttpOnly; Path=/; SameSite=Strict; Max-Age=86400'
              }
            }
          );
        } else {
          return new Response(
            JSON.stringify({ success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' }),
            { headers: { 'Content-Type': 'application/json' } }
          );
        }
      }

      if (path === '/logout' && (method === 'GET' || method === 'POST')) {
        return new Response('', {
          status: 302,
          headers: {
            'Location': '/',
            'Set-Cookie': 'token=; HttpOnly; Path=/; SameSite=Strict; Max-Age=0'
          }
        });
      }

      const token = getCookieValue(request.headers.get('Cookie'), 'token');
      const user = token ? await verifyJWT(token, config.JWT_SECRET) : null;

      if (!user && path !== '/login') {
        return new Response(
          JSON.stringify({ success: false, message: 'æœªæˆæƒè®¿é—®' }),
          { status: 401, headers: { 'Content-Type': 'application/json' } }
        );
      }

      if (path === '/config') {
        if (method === 'GET') {
          const { JWT_SECRET, ADMIN_PASSWORD, ...safeConfig } = config;
          return new Response(
            JSON.stringify(safeConfig),
            { headers: { 'Content-Type': 'application/json' } }
          );
        }

        if (method === 'POST') {
          try {
            const newConfig = await request.json();

            const updatedConfig = {
              ...config,
              ADMIN_USERNAME: newConfig.ADMIN_USERNAME || config.ADMIN_USERNAME,
              TG_BOT_TOKEN: newConfig.TG_BOT_TOKEN || '',
              TG_CHAT_ID: newConfig.TG_CHAT_ID || '',
              NOTIFYX_API_KEY: newConfig.NOTIFYX_API_KEY || '',
              WEBHOOK_URL: newConfig.WEBHOOK_URL || '',
              WEBHOOK_METHOD: newConfig.WEBHOOK_METHOD || 'POST',
              WEBHOOK_HEADERS: newConfig.WEBHOOK_HEADERS || '',
              WEBHOOK_TEMPLATE: newConfig.WEBHOOK_TEMPLATE || '',
              SHOW_LUNAR: newConfig.SHOW_LUNAR === true,
              WECHATBOT_WEBHOOK: newConfig.WECHATBOT_WEBHOOK || '',
              WECHATBOT_MSG_TYPE: newConfig.WECHATBOT_MSG_TYPE || 'text',
              WECHATBOT_AT_MOBILES: newConfig.WECHATBOT_AT_MOBILES || '',
              WECHATBOT_AT_ALL: newConfig.WECHATBOT_AT_ALL || 'false',
              RESEND_API_KEY: newConfig.RESEND_API_KEY || '',
              EMAIL_FROM: newConfig.EMAIL_FROM || '',
              EMAIL_FROM_NAME: newConfig.EMAIL_FROM_NAME || '',
              EMAIL_TO: newConfig.EMAIL_TO || '',
              ENABLED_NOTIFIERS: newConfig.ENABLED_NOTIFIERS || ['notifyx']
            };

            if (newConfig.ADMIN_PASSWORD) {
              updatedConfig.ADMIN_PASSWORD = newConfig.ADMIN_PASSWORD;
            }

            // ç¡®ä¿JWT_SECRETå­˜åœ¨ä¸”å®‰å…¨
            if (!updatedConfig.JWT_SECRET || updatedConfig.JWT_SECRET === 'your-secret-key') {
              updatedConfig.JWT_SECRET = generateRandomSecret();
              console.log('[å®‰å…¨] ç”Ÿæˆæ–°çš„JWTå¯†é’¥');
            }

            await env.SUBSCRIPTIONS_KV.put('config', JSON.stringify(updatedConfig));

            return new Response(
              JSON.stringify({ success: true }),
              { headers: { 'Content-Type': 'application/json' } }
            );
          } catch (error) {
            console.error('é…ç½®ä¿å­˜é”™è¯¯:', error);
            return new Response(
              JSON.stringify({ success: false, message: 'æ›´æ–°é…ç½®å¤±è´¥: ' + error.message }),
              { status: 400, headers: { 'Content-Type': 'application/json' } }
            );
          }
        }
      }

      if (path === '/test-notification' && method === 'POST') {
        try {
          const body = await request.json();
          let success = false;
          let message = '';

          if (body.type === 'telegram') {
            const testConfig = {
              ...config,
              TG_BOT_TOKEN: body.TG_BOT_TOKEN,
              TG_CHAT_ID: body.TG_CHAT_ID
            };

            const content = '*æµ‹è¯•é€šçŸ¥*\n\nè¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯Telegramé€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + formatBeijingTime();
            success = await sendTelegramNotification(content, testConfig);
            message = success ? 'Telegramé€šçŸ¥å‘é€æˆåŠŸ' : 'Telegramé€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
          } else if (body.type === 'notifyx') {
            const testConfig = {
              ...config,
              NOTIFYX_API_KEY: body.NOTIFYX_API_KEY
            };

            const title = 'æµ‹è¯•é€šçŸ¥';
            const content = '## è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥\n\nç”¨äºéªŒè¯NotifyXé€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + formatBeijingTime();
            const description = 'æµ‹è¯•NotifyXé€šçŸ¥åŠŸèƒ½';

            success = await sendNotifyXNotification(title, content, description, testConfig);
            message = success ? 'NotifyXé€šçŸ¥å‘é€æˆåŠŸ' : 'NotifyXé€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
          } else if (body.type === 'webhook') {
            const testConfig = {
              ...config,
              WEBHOOK_URL: body.WEBHOOK_URL,
              WEBHOOK_METHOD: body.WEBHOOK_METHOD,
              WEBHOOK_HEADERS: body.WEBHOOK_HEADERS,
              WEBHOOK_TEMPLATE: body.WEBHOOK_TEMPLATE
            };

            const title = 'æµ‹è¯•é€šçŸ¥';
            const content = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + formatBeijingTime();

            success = await sendWebhookNotification(title, content, testConfig);
            message = success ? 'ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥å‘é€æˆåŠŸ' : 'ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
           } else if (body.type === 'wechatbot') {
            const testConfig = {
              ...config,
              WECHATBOT_WEBHOOK: body.WECHATBOT_WEBHOOK,
              WECHATBOT_MSG_TYPE: body.WECHATBOT_MSG_TYPE,
              WECHATBOT_AT_MOBILES: body.WECHATBOT_AT_MOBILES,
              WECHATBOT_AT_ALL: body.WECHATBOT_AT_ALL
            };

            const title = 'æµ‹è¯•é€šçŸ¥';
            const content = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯ä¼ä¸šå¾®ä¿¡æœºå™¨äººåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + formatBeijingTime();

            success = await sendWechatBotNotification(title, content, testConfig);
            message = success ? 'ä¼ä¸šå¾®ä¿¡æœºå™¨äººé€šçŸ¥å‘é€æˆåŠŸ' : 'ä¼ä¸šå¾®ä¿¡æœºå™¨äººé€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
          } else if (body.type === 'email') {
            const testConfig = {
              ...config,
              RESEND_API_KEY: body.RESEND_API_KEY,
              EMAIL_FROM: body.EMAIL_FROM,
              EMAIL_FROM_NAME: body.EMAIL_FROM_NAME,
              EMAIL_TO: body.EMAIL_TO
            };

            const title = 'æµ‹è¯•é€šçŸ¥';
            const content = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯é‚®ä»¶é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + formatBeijingTime();

            success = await sendEmailNotification(title, content, testConfig);
            message = success ? 'é‚®ä»¶é€šçŸ¥å‘é€æˆåŠŸ' : 'é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
          }

          return new Response(
            JSON.stringify({ success, message }),
            { headers: { 'Content-Type': 'application/json' } }
          );
        } catch (error) {
          console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
          return new Response(
            JSON.stringify({ success: false, message: 'æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message }),
            { status: 500, headers: { 'Content-Type': 'application/json' } }
          );
        }
      }

      if (path === '/subscriptions') {
        if (method === 'GET') {
          const subscriptions = await getAllSubscriptions(env);
          return new Response(
            JSON.stringify(subscriptions),
            { headers: { 'Content-Type': 'application/json' } }
          );
        }

        if (method === 'POST') {
          const subscription = await request.json();
          const result = await createSubscription(subscription, env);

          return new Response(
            JSON.stringify(result),
            {
              status: result.success ? 201 : 400,
              headers: { 'Content-Type': 'application/json' }
            }
          );
        }
      }

      if (path.startsWith('/subscriptions/')) {
        const parts = path.split('/');
        const id = parts[2];

        if (parts[3] === 'toggle-status' && method === 'POST') {
          const body = await request.json();
          const result = await toggleSubscriptionStatus(id, body.isActive, env);

          return new Response(
            JSON.stringify(result),
            {
              status: result.success ? 200 : 400,
              headers: { 'Content-Type': 'application/json' }
            }
          );
        }

        if (parts[3] === 'test-notify' && method === 'POST') {
          const result = await testSingleSubscriptionNotification(id, env);
          return new Response(JSON.stringify(result), { status: result.success ? 200 : 500, headers: { 'Content-Type': 'application/json' } });
        }

        if (method === 'GET') {
          const subscription = await getSubscription(id, env);

          return new Response(
            JSON.stringify(subscription),
            { headers: { 'Content-Type': 'application/json' } }
          );
        }

        if (method === 'PUT') {
          const subscription = await request.json();
          const result = await updateSubscription(id, subscription, env);

          return new Response(
            JSON.stringify(result),
            {
              status: result.success ? 200 : 400,
              headers: { 'Content-Type': 'application/json' }
            }
          );
        }

        if (method === 'DELETE') {
          const result = await deleteSubscription(id, env);

          return new Response(
            JSON.stringify(result),
            {
              status: result.success ? 200 : 400,
              headers: { 'Content-Type': 'application/json' }
            }
          );
        }
      }

      // å¤„ç†ç¬¬ä¸‰æ–¹é€šçŸ¥API
      if (path.startsWith('/notify/')) {
        const code = path.split('/')[2];
        if (method === 'POST') {
          try {
            const body = await request.json();
            const title = body.title || 'ç¬¬ä¸‰æ–¹é€šçŸ¥';
            const content = body.content || '';

            if (!content) {
              return new Response(
                JSON.stringify({ message: 'ç¼ºå°‘å¿…å¡«å‚æ•° content' }),
                { status: 400, headers: { 'Content-Type': 'application/json' } }
              );
            }

            const config = await getConfig(env);

            // ä½¿ç”¨å¤šæ¸ é“å‘é€é€šçŸ¥
            await sendNotificationToAllChannels(title, content, config, '[ç¬¬ä¸‰æ–¹API]');

            return new Response(
              JSON.stringify({
                message: 'å‘é€æˆåŠŸ',
                response: {
                  errcode: 0,
                  errmsg: 'ok',
                  msgid: 'MSGID' + Date.now()
                }
              }),
              { headers: { 'Content-Type': 'application/json' } }
            );
          } catch (error) {
            console.error('[ç¬¬ä¸‰æ–¹API] å‘é€é€šçŸ¥å¤±è´¥:', error);
            return new Response(
              JSON.stringify({
                message: 'å‘é€å¤±è´¥',
                response: {
                  errcode: 1,
                  errmsg: error.message
                }
              }),
              { status: 500, headers: { 'Content-Type': 'application/json' } }
            );
          }
        }
      }

      return new Response(
        JSON.stringify({ success: false, message: 'æœªæ‰¾åˆ°è¯·æ±‚çš„èµ„æº' }),
        { status: 404, headers: { 'Content-Type': 'application/json' } }
      );
    }
  };

  // å·¥å…·å‡½æ•°
  function generateRandomSecret() {
    // ç”Ÿæˆä¸€ä¸ª64å­—ç¬¦çš„éšæœºå¯†é’¥
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let result = '';
    for (let i = 0; i < 64; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  async function getConfig(env) {
    try {
      if (!env.SUBSCRIPTIONS_KV) {
        console.error('[é…ç½®] KVå­˜å‚¨æœªç»‘å®š');
        throw new Error('KVå­˜å‚¨æœªç»‘å®š');
      }

      const data = await env.SUBSCRIPTIONS_KV.get('config');
      console.log('[é…ç½®] ä»KVè¯»å–é…ç½®:', data ? 'æˆåŠŸ' : 'ç©ºé…ç½®');

      const config = data ? JSON.parse(data) : {};

      // ç¡®ä¿JWT_SECRETçš„ä¸€è‡´æ€§
      let jwtSecret = config.JWT_SECRET;
      if (!jwtSecret || jwtSecret === 'your-secret-key') {
        jwtSecret = generateRandomSecret();
        console.log('[é…ç½®] ç”Ÿæˆæ–°çš„JWTå¯†é’¥');

        // ä¿å­˜æ–°çš„JWTå¯†é’¥
        const updatedConfig = { ...config, JWT_SECRET: jwtSecret };
        await env.SUBSCRIPTIONS_KV.put('config', JSON.stringify(updatedConfig));
      }

      const finalConfig = {
        ADMIN_USERNAME: config.ADMIN_USERNAME || 'admin',
        ADMIN_PASSWORD: config.ADMIN_PASSWORD || 'password',
        JWT_SECRET: jwtSecret,
        TG_BOT_TOKEN: config.TG_BOT_TOKEN || '',
        TG_CHAT_ID: config.TG_CHAT_ID || '',
        NOTIFYX_API_KEY: config.NOTIFYX_API_KEY || '',
        WEBHOOK_URL: config.WEBHOOK_URL || '',
        WEBHOOK_METHOD: config.WEBHOOK_METHOD || 'POST',
        WEBHOOK_HEADERS: config.WEBHOOK_HEADERS || '',
        WEBHOOK_TEMPLATE: config.WEBHOOK_TEMPLATE || '',
        SHOW_LUNAR: config.SHOW_LUNAR === true,
        WECHATBOT_WEBHOOK: config.WECHATBOT_WEBHOOK || '',
        WECHATBOT_MSG_TYPE: config.WECHATBOT_MSG_TYPE || 'text',
        WECHATBOT_AT_MOBILES: config.WECHATBOT_AT_MOBILES || '',
        WECHATBOT_AT_ALL: config.WECHATBOT_AT_ALL || 'false',
        RESEND_API_KEY: config.RESEND_API_KEY || '',
        EMAIL_FROM: config.EMAIL_FROM || '',
        EMAIL_FROM_NAME: config.EMAIL_FROM_NAME || '',
        EMAIL_TO: config.EMAIL_TO || '',
        ENABLED_NOTIFIERS: config.ENABLED_NOTIFIERS || ['notifyx']
      };

      console.log('[é…ç½®] æœ€ç»ˆé…ç½®ç”¨æˆ·å:', finalConfig.ADMIN_USERNAME);
      return finalConfig;
    } catch (error) {
      console.error('[é…ç½®] è·å–é…ç½®å¤±è´¥:', error);
      const defaultJwtSecret = generateRandomSecret();

      return {
        ADMIN_USERNAME: 'admin',
        ADMIN_PASSWORD: 'password',
        JWT_SECRET: defaultJwtSecret,
        TG_BOT_TOKEN: '',
        TG_CHAT_ID: '',
        NOTIFYX_API_KEY: '',
        WEBHOOK_URL: '',
        WEBHOOK_METHOD: 'POST',
        WEBHOOK_HEADERS: '',
        WEBHOOK_TEMPLATE: '',
        SHOW_LUNAR: true,
        WECHATBOT_WEBHOOK: '',
        WECHATBOT_MSG_TYPE: 'text',
        WECHATBOT_AT_MOBILES: '',
        WECHATBOT_AT_ALL: 'false',
        RESEND_API_KEY: '',
        EMAIL_FROM: '',
        EMAIL_FROM_NAME: '',
        EMAIL_TO: '',
        ENABLED_NOTIFIERS: ['notifyx']
      };
    }
  }

  async function generateJWT(username, secret) {
    const header = { alg: 'HS256', typ: 'JWT' };
    const payload = { username, iat: Math.floor(Date.now() / 1000) };

    const headerBase64 = btoa(JSON.stringify(header));
    const payloadBase64 = btoa(JSON.stringify(payload));

    const signatureInput = headerBase64 + '.' + payloadBase64;
    const signature = await CryptoJS.HmacSHA256(signatureInput, secret);

    return headerBase64 + '.' + payloadBase64 + '.' + signature;
  }

  async function verifyJWT(token, secret) {
    try {
      if (!token || !secret) {
        console.log('[JWT] Tokenæˆ–Secretä¸ºç©º');
        return null;
      }

      const parts = token.split('.');
      if (parts.length !== 3) {
        console.log('[JWT] Tokenæ ¼å¼é”™è¯¯ï¼Œéƒ¨åˆ†æ•°é‡:', parts.length);
        return null;
      }

      const [headerBase64, payloadBase64, signature] = parts;
      const signatureInput = headerBase64 + '.' + payloadBase64;
      const expectedSignature = await CryptoJS.HmacSHA256(signatureInput, secret);

      if (signature !== expectedSignature) {
        console.log('[JWT] ç­¾åéªŒè¯å¤±è´¥');
        return null;
      }

      const payload = JSON.parse(atob(payloadBase64));
      console.log('[JWT] éªŒè¯æˆåŠŸï¼Œç”¨æˆ·:', payload.username);
      return payload;
    } catch (error) {
      console.error('[JWT] éªŒè¯è¿‡ç¨‹å‡ºé”™:', error);
      return null;
    }
  }

  async function getAllSubscriptions(env) {
    try {
      const data = await env.SUBSCRIPTIONS_KV.get('subscriptions');
      return data ? JSON.parse(data) : [];
    } catch (error) {
      return [];
    }
  }

  async function getSubscription(id, env) {
    const subscriptions = await getAllSubscriptions(env);
    return subscriptions.find(s => s.id === id);
  }

  // 2. ä¿®æ”¹ createSubscriptionï¼Œæ”¯æŒ useLunar å­—æ®µ
  async function createSubscription(subscription, env) {
    try {
      const subscriptions = await getAllSubscriptions(env);

      if (!subscription.name || !subscription.expiryDate) {
        return { success: false, message: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' };
      }

      let expiryDate = new Date(subscription.expiryDate);
      const now = new Date();


      let useLunar = !!subscription.useLunar;
      if (useLunar) {
        let lunar = lunarCalendar.solar2lunar(
          expiryDate.getFullYear(),
          expiryDate.getMonth() + 1,
          expiryDate.getDate()
        );

        if (lunar && subscription.periodValue && subscription.periodUnit) {
          // å¦‚æœåˆ°æœŸæ—¥<=ä»Šå¤©ï¼Œè‡ªåŠ¨æ¨ç®—åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ
          while (expiryDate <= now) {
            lunar = lunarBiz.addLunarPeriod(lunar, subscription.periodValue, subscription.periodUnit);
            const solar = lunarBiz.lunar2solar(lunar);
            expiryDate = new Date(solar.year, solar.month - 1, solar.day);
          }
          subscription.expiryDate = expiryDate.toISOString();
        }
      } else {
        if (expiryDate < now && subscription.periodValue && subscription.periodUnit) {
          while (expiryDate < now) {
            if (subscription.periodUnit === 'day') {
              expiryDate.setDate(expiryDate.getDate() + subscription.periodValue);
            } else if (subscription.periodUnit === 'month') {
              expiryDate.setMonth(expiryDate.getMonth() + subscription.periodValue);
            } else if (subscription.periodUnit === 'year') {
              expiryDate.setFullYear(expiryDate.getFullYear() + subscription.periodValue);
            }
          }
          subscription.expiryDate = expiryDate.toISOString();
        }
      }

      const newSubscription = {
        id: Date.now().toString(),
        name: subscription.name,
        customType: subscription.customType || '',
        startDate: subscription.startDate || null,
        expiryDate: subscription.expiryDate,
        periodValue: subscription.periodValue || 1,
        periodUnit: subscription.periodUnit || 'month',
        reminderDays: subscription.reminderDays !== undefined ? subscription.reminderDays : 7,
        notes: subscription.notes || '',
        isActive: subscription.isActive !== false,
        autoRenew: subscription.autoRenew !== false,
        useLunar: useLunar, // æ–°å¢
        createdAt: new Date().toISOString()
      };

      subscriptions.push(newSubscription);

      await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(subscriptions));

      return { success: true, subscription: newSubscription };
    } catch (error) {
      console.error("åˆ›å»ºè®¢é˜…å¼‚å¸¸ï¼š", error && error.stack ? error.stack : error);
      return { success: false, message: error && error.message ? error.message : 'åˆ›å»ºè®¢é˜…å¤±è´¥' };
    }
  }

  // 3. ä¿®æ”¹ updateSubscriptionï¼Œæ”¯æŒ useLunar å­—æ®µ
  async function updateSubscription(id, subscription, env) {
    try {
      const subscriptions = await getAllSubscriptions(env);
      const index = subscriptions.findIndex(s => s.id === id);

      if (index === -1) {
        return { success: false, message: 'è®¢é˜…ä¸å­˜åœ¨' };
      }

      if (!subscription.name || !subscription.expiryDate) {
        return { success: false, message: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' };
      }

      let expiryDate = new Date(subscription.expiryDate);
      const now = new Date();

  let useLunar = !!subscription.useLunar;
  if (useLunar) {
    let lunar = lunarCalendar.solar2lunar(
      expiryDate.getFullYear(),
      expiryDate.getMonth() + 1,
      expiryDate.getDate()
    );
    if (!lunar) {
      return { success: false, message: 'å†œå†æ—¥æœŸè¶…å‡ºæ”¯æŒèŒƒå›´ï¼ˆ1900-2100å¹´ï¼‰' };
    }
    if (lunar && expiryDate < now && subscription.periodValue && subscription.periodUnit) {
      // æ–°å¢ï¼šå¾ªç¯åŠ å‘¨æœŸï¼Œç›´åˆ° expiryDate > now
      do {
        lunar = lunarBiz.addLunarPeriod(lunar, subscription.periodValue, subscription.periodUnit);
        const solar = lunarBiz.lunar2solar(lunar);
        expiryDate = new Date(solar.year, solar.month - 1, solar.day);
      } while (expiryDate < now);
      subscription.expiryDate = expiryDate.toISOString();
    }
  } else {
        if (expiryDate < now && subscription.periodValue && subscription.periodUnit) {
          while (expiryDate < now) {
            if (subscription.periodUnit === 'day') {
              expiryDate.setDate(expiryDate.getDate() + subscription.periodValue);
            } else if (subscription.periodUnit === 'month') {
              expiryDate.setMonth(expiryDate.getMonth() + subscription.periodValue);
            } else if (subscription.periodUnit === 'year') {
              expiryDate.setFullYear(expiryDate.getFullYear() + subscription.periodValue);
            }
          }
          subscription.expiryDate = expiryDate.toISOString();
        }
      }

      subscriptions[index] = {
        ...subscriptions[index],
        name: subscription.name,
        customType: subscription.customType || subscriptions[index].customType || '',
        startDate: subscription.startDate || subscriptions[index].startDate,
        expiryDate: subscription.expiryDate,
        periodValue: subscription.periodValue || subscriptions[index].periodValue || 1,
        periodUnit: subscription.periodUnit || subscriptions[index].periodUnit || 'month',
        reminderDays: subscription.reminderDays !== undefined ? subscription.reminderDays : (subscriptions[index].reminderDays !== undefined ? subscriptions[index].reminderDays : 7),
        notes: subscription.notes || '',
        isActive: subscription.isActive !== undefined ? subscription.isActive : subscriptions[index].isActive,
        autoRenew: subscription.autoRenew !== undefined ? subscription.autoRenew : (subscriptions[index].autoRenew !== undefined ? subscriptions[index].autoRenew : true),
        useLunar: useLunar, // æ–°å¢
        updatedAt: new Date().toISOString()
      };

      await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(subscriptions));

      return { success: true, subscription: subscriptions[index] };
    } catch (error) {
      return { success: false, message: 'æ›´æ–°è®¢é˜…å¤±è´¥' };
    }
  }

  async function deleteSubscription(id, env) {
    try {
      const subscriptions = await getAllSubscriptions(env);
      const filteredSubscriptions = subscriptions.filter(s => s.id !== id);

      if (filteredSubscriptions.length === subscriptions.length) {
        return { success: false, message: 'è®¢é˜…ä¸å­˜åœ¨' };
      }

      await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(filteredSubscriptions));

      return { success: true };
    } catch (error) {
      return { success: false, message: 'åˆ é™¤è®¢é˜…å¤±è´¥' };
    }
  }

  async function toggleSubscriptionStatus(id, isActive, env) {
    try {
      const subscriptions = await getAllSubscriptions(env);
      const index = subscriptions.findIndex(s => s.id === id);

      if (index === -1) {
        return { success: false, message: 'è®¢é˜…ä¸å­˜åœ¨' };
      }

      subscriptions[index] = {
        ...subscriptions[index],
        isActive: isActive,
        updatedAt: new Date().toISOString()
      };

      await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(subscriptions));

      return { success: true, subscription: subscriptions[index] };
    } catch (error) {
      return { success: false, message: 'æ›´æ–°è®¢é˜…çŠ¶æ€å¤±è´¥' };
    }
  }

  async function testSingleSubscriptionNotification(id, env) {
    try {
      const subscription = await getSubscription(id, env);
      if (!subscription) {
        return { success: false, message: 'æœªæ‰¾åˆ°è¯¥è®¢é˜…' };
      }
      const config = await getConfig(env);

      const title = `æ‰‹åŠ¨æµ‹è¯•é€šçŸ¥: ${subscription.name}`;

      // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå†œå†ï¼ˆä»é…ç½®ä¸­è·å–ï¼Œé»˜è®¤ä¸æ˜¾ç¤ºï¼‰
      const showLunar = config.SHOW_LUNAR === true;
      let lunarExpiryText = '';

      if (showLunar) {
        // è®¡ç®—å†œå†æ—¥æœŸ
        const expiryDateObj = new Date(subscription.expiryDate);
        const lunarExpiry = lunarCalendar.solar2lunar(expiryDateObj.getFullYear(), expiryDateObj.getMonth() + 1, expiryDateObj.getDate());
        lunarExpiryText = lunarExpiry ? ` (å†œå†: ${lunarExpiry.fullStr})` : '';
      }

      const commonContent = `**è®¢é˜…è¯¦æƒ…**:\n- **ç±»å‹**: ${subscription.customType || 'å…¶ä»–'}\n- **åˆ°æœŸæ—¥**: ${formatBeijingTime(new Date(subscription.expiryDate), 'date')}${lunarExpiryText}\n- **å¤‡æ³¨**: ${subscription.notes || 'æ— '}`;

      // ä½¿ç”¨å¤šæ¸ é“å‘é€
      await sendNotificationToAllChannels(title, commonContent, config, '[æ‰‹åŠ¨æµ‹è¯•]');

      return { success: true, message: 'æµ‹è¯•é€šçŸ¥å·²å‘é€åˆ°æ‰€æœ‰å¯ç”¨çš„æ¸ é“' };

    } catch (error) {
      console.error('[æ‰‹åŠ¨æµ‹è¯•] å‘é€å¤±è´¥:', error);
      return { success: false, message: 'å‘é€æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message };
    }
  }

  async function sendWebhookNotification(title, content, config) {
    try {
      if (!config.WEBHOOK_URL) {
        console.error('[ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘URL');
        return false;
      }

      console.log('[ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥] å¼€å§‹å‘é€é€šçŸ¥åˆ°: ' + config.WEBHOOK_URL);

      const timestamp = formatBeijingTime(new Date(), 'datetime');
      let requestBody;
      let headers = { 'Content-Type': 'application/json' };

      // å¤„ç†è‡ªå®šä¹‰è¯·æ±‚å¤´
      if (config.WEBHOOK_HEADERS) {
        try {
          const customHeaders = JSON.parse(config.WEBHOOK_HEADERS);
          headers = { ...headers, ...customHeaders };
        } catch (error) {
          console.warn('[ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥] è‡ªå®šä¹‰è¯·æ±‚å¤´æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤è¯·æ±‚å¤´');
        }
      }

      // å¤„ç†æ¶ˆæ¯æ¨¡æ¿
      if (config.WEBHOOK_TEMPLATE) {
        try {
          const template = JSON.parse(config.WEBHOOK_TEMPLATE);
          requestBody = JSON.stringify(template)
            .replace(/\{\{title\}\}/g, title)
            .replace(/\{\{content\}\}/g, content)
            .replace(/\{\{timestamp\}\}/g, timestamp);
          requestBody = JSON.parse(requestBody);
        } catch (error) {
          console.warn('[ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥] æ¶ˆæ¯æ¨¡æ¿æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼');
          requestBody = { title, content, timestamp };
        }
      } else {
        requestBody = { title, content, timestamp };
      }

      const response = await fetch(config.WEBHOOK_URL, {
        method: config.WEBHOOK_METHOD || 'POST',
        headers: headers,
        body: JSON.stringify(requestBody)
      });

      const result = await response.text();
      console.log('[ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥] å‘é€ç»“æœ:', response.status, result);
      return response.ok;
    } catch (error) {
      console.error('[ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥] å‘é€é€šçŸ¥å¤±è´¥:', error);
      return false;
    }
  }

  async function sendWeComNotification(message, config) {
      // This is a placeholder. In a real scenario, you would implement the WeCom notification logic here.
      console.log("[ä¼ä¸šå¾®ä¿¡] é€šçŸ¥åŠŸèƒ½æœªå®ç°");
      return { success: false, message: "ä¼ä¸šå¾®ä¿¡é€šçŸ¥åŠŸèƒ½æœªå®ç°" };
  }

  async function sendWechatBotNotification(title, content, config) {
    try {
      if (!config.WECHATBOT_WEBHOOK) {
        console.error('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘Webhook URL');
        return false;
      }

      console.log('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] å¼€å§‹å‘é€é€šçŸ¥åˆ°: ' + config.WECHATBOT_WEBHOOK);

      // æ„å»ºæ¶ˆæ¯å†…å®¹
      let messageData;
      const msgType = config.WECHATBOT_MSG_TYPE || 'text';

      if (msgType === 'markdown') {
        // Markdown æ¶ˆæ¯æ ¼å¼
        const markdownContent = `# ${title}\n\n${content}`;
        messageData = {
          msgtype: 'markdown',
          markdown: {
            content: markdownContent
          }
        };
      } else {
        // æ–‡æœ¬æ¶ˆæ¯æ ¼å¼
        const textContent = `${title}\n\n${content}`;
        messageData = {
          msgtype: 'text',
          text: {
            content: textContent
          }
        };
      }

      // å¤„ç†@åŠŸèƒ½
      if (config.WECHATBOT_AT_ALL === 'true') {
        // @æ‰€æœ‰äºº
        if (msgType === 'text') {
          messageData.text.mentioned_list = ['@all'];
        }
      } else if (config.WECHATBOT_AT_MOBILES) {
        // @æŒ‡å®šæ‰‹æœºå·
        const mobiles = config.WECHATBOT_AT_MOBILES.split(',').map(m => m.trim()).filter(m => m);
        if (mobiles.length > 0) {
          if (msgType === 'text') {
            messageData.text.mentioned_mobile_list = mobiles;
          }
        }
      }

      console.log('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] å‘é€æ¶ˆæ¯æ•°æ®:', JSON.stringify(messageData, null, 2));

      const response = await fetch(config.WECHATBOT_WEBHOOK, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(messageData)
      });

      const responseText = await response.text();
      console.log('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] å“åº”çŠ¶æ€:', response.status);
      console.log('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] å“åº”å†…å®¹:', responseText);

      if (response.ok) {
        try {
          const result = JSON.parse(responseText);
          if (result.errcode === 0) {
            console.log('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] é€šçŸ¥å‘é€æˆåŠŸ');
            return true;
          } else {
            console.error('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] å‘é€å¤±è´¥ï¼Œé”™è¯¯ç :', result.errcode, 'é”™è¯¯ä¿¡æ¯:', result.errmsg);
            return false;
          }
        } catch (parseError) {
          console.error('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] è§£æå“åº”å¤±è´¥:', parseError);
          return false;
        }
      } else {
        console.error('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] HTTPè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
        return false;
      }
    } catch (error) {
      console.error('[ä¼ä¸šå¾®ä¿¡æœºå™¨äºº] å‘é€é€šçŸ¥å¤±è´¥:', error);
      return false;
    }
  }

  async function sendNotificationToAllChannels(title, commonContent, config, logPrefix = '[å®šæ—¶ä»»åŠ¡]') {
      if (!config.ENABLED_NOTIFIERS || config.ENABLED_NOTIFIERS.length === 0) {
          console.log(`${logPrefix} æœªå¯ç”¨ä»»ä½•é€šçŸ¥æ¸ é“ã€‚`);
          return;
      }

      if (config.ENABLED_NOTIFIERS.includes('notifyx')) {
          const notifyxContent = `## ${title}\n\n${commonContent}`;
          const success = await sendNotifyXNotification(title, notifyxContent, `è®¢é˜…æé†’`, config);
          console.log(`${logPrefix} å‘é€NotifyXé€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      }
      if (config.ENABLED_NOTIFIERS.includes('telegram')) {
          const telegramContent = `*${title}*\n\n${commonContent.replace(/(\s)/g, ' ')}`;
          const success = await sendTelegramNotification(telegramContent, config);
          console.log(`${logPrefix} å‘é€Telegramé€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      }
      if (config.ENABLED_NOTIFIERS.includes('webhook')) {
          const webhookContent = commonContent.replace(/(\**|\*|##|#|`)/g, '');
          const success = await sendWebhookNotification(title, webhookContent, config);
          console.log(`${logPrefix} å‘é€ä¼ä¸šå¾®ä¿¡åº”ç”¨é€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      }
      if (config.ENABLED_NOTIFIERS.includes('wechatbot')) {
          const wechatbotContent = commonContent.replace(/(\**|\*|##|#|`)/g, '');
          const success = await sendWechatBotNotification(title, wechatbotContent, config);
          console.log(`${logPrefix} å‘é€ä¼ä¸šå¾®ä¿¡æœºå™¨äººé€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      }
      if (config.ENABLED_NOTIFIERS.includes('weixin')) {
          const weixinContent = `ã€${title}ã€‘\n\n${commonContent.replace(/(\**|\*|##|#|`)/g, '')}`;
          const result = await sendWeComNotification(weixinContent, config);
          console.log(`${logPrefix} å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}. ${result.message}`);
      }
      if (config.ENABLED_NOTIFIERS.includes('email')) {
          const emailContent = commonContent.replace(/(\**|\*|##|#|`)/g, '');
          const success = await sendEmailNotification(title, emailContent, config);
          console.log(`${logPrefix} å‘é€é‚®ä»¶é€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
      }
  }

  async function sendTelegramNotification(message, config) {
    try {
      if (!config.TG_BOT_TOKEN || !config.TG_CHAT_ID) {
        console.error('[Telegram] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘Bot Tokenæˆ–Chat ID');
        return false;
      }

      console.log('[Telegram] å¼€å§‹å‘é€é€šçŸ¥åˆ° Chat ID: ' + config.TG_CHAT_ID);

      const url = 'https://api.telegram.org/bot' + config.TG_BOT_TOKEN + '/sendMessage';
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: config.TG_CHAT_ID,
          text: message,
          parse_mode: 'Markdown'
        })
      });

      const result = await response.json();
      console.log('[Telegram] å‘é€ç»“æœ:', result);
      return result.ok;
    } catch (error) {
      console.error('[Telegram] å‘é€é€šçŸ¥å¤±è´¥:', error);
      return false;
    }
  }

  async function sendNotifyXNotification(title, content, description, config) {
    try {
      if (!config.NOTIFYX_API_KEY) {
        console.error('[NotifyX] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘API Key');
        return false;
      }

      console.log('[NotifyX] å¼€å§‹å‘é€é€šçŸ¥: ' + title);

      const url = 'https://www.notifyx.cn/api/v1/send/' + config.NOTIFYX_API_KEY;
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title,
          content: content,
          description: description || ''
        })
      });

      const result = await response.json();
      console.log('[NotifyX] å‘é€ç»“æœ:', result);
      return result.status === 'queued';
    } catch (error) {
      console.error('[NotifyX] å‘é€é€šçŸ¥å¤±è´¥:', error);
      return false;
    }
  }

  async function sendEmailNotification(title, content, config) {
    try {
      if (!config.RESEND_API_KEY || !config.EMAIL_FROM || !config.EMAIL_TO) {
        console.error('[é‚®ä»¶é€šçŸ¥] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘å¿…è¦å‚æ•°');
        return false;
      }

      console.log('[é‚®ä»¶é€šçŸ¥] å¼€å§‹å‘é€é‚®ä»¶åˆ°: ' + config.EMAIL_TO);

      // ç”ŸæˆHTMLé‚®ä»¶å†…å®¹
      const htmlContent = `
  <!DOCTYPE html>
  <html>
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>${title}</title>
      <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
          .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center; }
          .header h1 { color: white; margin: 0; font-size: 24px; }
          .content { padding: 30px 20px; }
          .content h2 { color: #333; margin-top: 0; }
          .content p { color: #666; line-height: 1.6; margin: 16px 0; }
          .footer { background-color: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 14px; }
          .highlight { background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; }
          .button { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 20px 0; }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="header">
              <h1>ğŸ“… ${title}</h1>
          </div>
          <div class="content">
              <div class="highlight">
                  ${content.replace(/\n/g, '<br>')}
              </div>
              <p>æ­¤é‚®ä»¶ç”±è®¢é˜…ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨å‘é€ï¼Œè¯·åŠæ—¶å¤„ç†ç›¸å…³è®¢é˜…äº‹åŠ¡ã€‚</p>
          </div>
          <div class="footer">
              <p>è®¢é˜…ç®¡ç†ç³»ç»Ÿ | å‘é€æ—¶é—´: ${formatBeijingTime()}</p>
          </div>
      </div>
  </body>
  </html>`;

      const fromEmail = config.EMAIL_FROM_NAME ?
        `${config.EMAIL_FROM_NAME} <${config.EMAIL_FROM}>` :
        config.EMAIL_FROM;

      const response = await fetch('https://api.resend.com/emails', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${config.RESEND_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          from: fromEmail,
          to: config.EMAIL_TO,
          subject: title,
          html: htmlContent,
          text: content // çº¯æ–‡æœ¬å¤‡ç”¨
        })
      });

      const result = await response.json();
      console.log('[é‚®ä»¶é€šçŸ¥] å‘é€ç»“æœ:', response.status, result);

      if (response.ok && result.id) {
        console.log('[é‚®ä»¶é€šçŸ¥] é‚®ä»¶å‘é€æˆåŠŸï¼ŒID:', result.id);
        return true;
      } else {
        console.error('[é‚®ä»¶é€šçŸ¥] é‚®ä»¶å‘é€å¤±è´¥:', result);
        return false;
      }
    } catch (error) {
      console.error('[é‚®ä»¶é€šçŸ¥] å‘é€é‚®ä»¶å¤±è´¥:', error);
      return false;
    }
  }

  async function sendNotification(title, content, description, config) {
    if (config.NOTIFICATION_TYPE === 'notifyx') {
      return await sendNotifyXNotification(title, content, description, config);
    } else {
      return await sendTelegramNotification(content, config);
    }
  }

  // 4. ä¿®æ”¹å®šæ—¶ä»»åŠ¡ checkExpiringSubscriptionsï¼Œæ”¯æŒå†œå†å‘¨æœŸè‡ªåŠ¨ç»­è®¢å’Œå†œå†æé†’
  async function checkExpiringSubscriptions(env) {
    try {
      const now = new Date();
      const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
      console.log('[å®šæ—¶ä»»åŠ¡] å¼€å§‹æ£€æŸ¥å³å°†åˆ°æœŸçš„è®¢é˜… UTC: ' + now.toISOString() + ', åŒ—äº¬æ—¶é—´: ' + beijingTime.toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}));

      const subscriptions = await getAllSubscriptions(env);
      console.log('[å®šæ—¶ä»»åŠ¡] å…±æ‰¾åˆ° ' + subscriptions.length + ' ä¸ªè®¢é˜…');

      const config = await getConfig(env);
      const expiringSubscriptions = [];
      const updatedSubscriptions = [];
      let hasUpdates = false;

  for (const subscription of subscriptions) {
    if (subscription.isActive === false) {
      console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" å·²åœç”¨ï¼Œè·³è¿‡');
      continue;
    }

    let daysDiff;
    if (subscription.useLunar) {
      const expiryDate = new Date(subscription.expiryDate);
      let lunar = lunarCalendar.solar2lunar(
        expiryDate.getFullYear(),
        expiryDate.getMonth() + 1,
        expiryDate.getDate()
      );
      daysDiff = lunarBiz.daysToLunar(lunar);

      console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åˆ°æœŸæ—¥æœŸ: ' + expiryDate.toISOString() + ', å‰©ä½™å¤©æ•°: ' + daysDiff);

      if (daysDiff < 0 && subscription.periodValue && subscription.periodUnit && subscription.autoRenew !== false) {
        let nextLunar = lunar;
        do {
          nextLunar = lunarBiz.addLunarPeriod(nextLunar, subscription.periodValue, subscription.periodUnit);
          const solar = lunarBiz.lunar2solar(nextLunar);
          var newExpiryDate = new Date(solar.year, solar.month - 1, solar.day);
          daysDiff = lunarBiz.daysToLunar(nextLunar);
          console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" æ›´æ–°åˆ°æœŸæ—¥æœŸ: ' + newExpiryDate.toISOString() + ', å‰©ä½™å¤©æ•°: ' + daysDiff);
        } while (daysDiff < 0);

        const updatedSubscription = { ...subscription, expiryDate: newExpiryDate.toISOString() };
        updatedSubscriptions.push(updatedSubscription);
        hasUpdates = true;

        let reminderDays = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;
        let shouldRemindAfterRenewal = false;
        if (reminderDays === 0) {
          shouldRemindAfterRenewal = daysDiff === 0;
        } else {
          shouldRemindAfterRenewal = daysDiff >= 0 && daysDiff <= reminderDays;
        }
        if (shouldRemindAfterRenewal) {
          console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åœ¨æé†’èŒƒå›´å†…ï¼Œå°†å‘é€é€šçŸ¥');
          expiringSubscriptions.push({
            ...updatedSubscription,
            daysRemaining: daysDiff
          });
        }
        continue;
      }
    } else {
      const expiryDate = new Date(subscription.expiryDate);
      daysDiff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

      console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åˆ°æœŸæ—¥æœŸ: ' + expiryDate.toISOString() + ', å‰©ä½™å¤©æ•°: ' + daysDiff);

      if (daysDiff < 0 && subscription.periodValue && subscription.periodUnit && subscription.autoRenew !== false) {
        const newExpiryDate = new Date(expiryDate);

        if (subscription.periodUnit === 'day') {
          newExpiryDate.setDate(expiryDate.getDate() + subscription.periodValue);
        } else if (subscription.periodUnit === 'month') {
          newExpiryDate.setMonth(expiryDate.getMonth() + subscription.periodValue);
        } else if (subscription.periodUnit === 'year') {
          newExpiryDate.setFullYear(expiryDate.getFullYear() + subscription.periodValue);
        }

        while (newExpiryDate < now) {
          console.log('[å®šæ—¶ä»»åŠ¡] æ–°è®¡ç®—çš„åˆ°æœŸæ—¥æœŸ ' + newExpiryDate.toISOString() + ' ä»ç„¶è¿‡æœŸï¼Œç»§ç»­è®¡ç®—ä¸‹ä¸€ä¸ªå‘¨æœŸ');
          if (subscription.periodUnit === 'day') {
            newExpiryDate.setDate(newExpiryDate.getDate() + subscription.periodValue);
          } else if (subscription.periodUnit === 'month') {
            newExpiryDate.setMonth(newExpiryDate.getMonth() + subscription.periodValue);
          } else if (subscription.periodUnit === 'year') {
            newExpiryDate.setFullYear(newExpiryDate.getFullYear() + subscription.periodValue);
          }
        }

        console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" æ›´æ–°åˆ°æœŸæ—¥æœŸ: ' + newExpiryDate.toISOString());

        const updatedSubscription = { ...subscription, expiryDate: newExpiryDate.toISOString() };
        updatedSubscriptions.push(updatedSubscription);
        hasUpdates = true;

        const newDaysDiff = Math.ceil((newExpiryDate - now) / (1000 * 60 * 60 * 24));
        let reminderDays = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;
        let shouldRemindAfterRenewal = false;
        if (reminderDays === 0) {
          shouldRemindAfterRenewal = newDaysDiff === 0;
        } else {
          shouldRemindAfterRenewal = newDaysDiff >= 0 && newDaysDiff <= reminderDays;
        }
        if (shouldRemindAfterRenewal) {
          console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åœ¨æé†’èŒƒå›´å†…ï¼Œå°†å‘é€é€šçŸ¥');
          expiringSubscriptions.push({
            ...updatedSubscription,
            daysRemaining: newDaysDiff
          });
        }
        continue;
      }
    }

    const reminderDays = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;
    let shouldRemind = false;
    if (reminderDays === 0) {
      shouldRemind = daysDiff === 0;
    } else {
      shouldRemind = daysDiff >= 0 && daysDiff <= reminderDays;
    }

    if (daysDiff < 0 && subscription.autoRenew === false) {
      console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" å·²è¿‡æœŸä¸”æœªå¯ç”¨è‡ªåŠ¨ç»­è®¢ï¼Œå°†å‘é€è¿‡æœŸé€šçŸ¥');
      expiringSubscriptions.push({
        ...subscription,
        daysRemaining: daysDiff
      });
    } else if (shouldRemind) {
      console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åœ¨æé†’èŒƒå›´å†…ï¼Œå°†å‘é€é€šçŸ¥');
      expiringSubscriptions.push({
        ...subscription,
        daysRemaining: daysDiff
      });
    }
  }

      if (hasUpdates) {
        const mergedSubscriptions = subscriptions.map(sub => {
          const updated = updatedSubscriptions.find(u => u.id === sub.id);
          return updated || sub;
        });
        await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(mergedSubscriptions));
      }

      if (expiringSubscriptions.length > 0) {
        let commonContent = '';
        expiringSubscriptions.sort((a, b) => a.daysRemaining - b.daysRemaining);

        const showLunar = config.SHOW_LUNAR === true;

        for (const sub of expiringSubscriptions) {
          const typeText = sub.customType || 'å…¶ä»–';
          const periodText = (sub.periodValue && sub.periodUnit) ? `(å‘¨æœŸ: ${sub.periodValue} ${ { day: 'å¤©', month: 'æœˆ', year: 'å¹´' }[sub.periodUnit] || sub.periodUnit})` : '';

          let lunarExpiryText = '';
          if (showLunar) {
            const expiryDateObj = new Date(sub.expiryDate);
            const lunarExpiry = lunarCalendar.solar2lunar(expiryDateObj.getFullYear(), expiryDateObj.getMonth() + 1, expiryDateObj.getDate());
            lunarExpiryText = lunarExpiry ? ` (å†œå†: ${lunarExpiry.fullStr})` : '';
          }

          let statusText;
          if (sub.daysRemaining === 0) statusText = `âš ï¸ **${sub.name}** (${typeText}) ${periodText} ä»Šå¤©åˆ°æœŸï¼${lunarExpiryText}`;
          else if (sub.daysRemaining < 0) statusText = `ğŸš¨ **${sub.name}** (${typeText}) ${periodText} å·²è¿‡æœŸ ${Math.abs(sub.daysRemaining)} å¤©${lunarExpiryText}`;
          else statusText = `ğŸ“… **${sub.name}** (${typeText}) ${periodText} å°†åœ¨ ${sub.daysRemaining} å¤©ååˆ°æœŸ${lunarExpiryText}`;

          if (sub.notes) statusText += `\n   å¤‡æ³¨: ${sub.notes}`;
          commonContent += statusText + '\n\n';
        }

        const title = 'è®¢é˜…åˆ°æœŸæé†’';
        await sendNotificationToAllChannels(title, commonContent, config, '[å®šæ—¶ä»»åŠ¡]');
      }
    } catch (error) {
      console.error('[å®šæ—¶ä»»åŠ¡] æ£€æŸ¥å³å°†åˆ°æœŸçš„è®¢é˜…å¤±è´¥:', error);
    }
  }

  function getCookieValue(cookieString, key) {
    if (!cookieString) return null;

    const match = cookieString.match(new RegExp('(^| )' + key + '=([^;]+)'));
    return match ? match[2] : null;
  }

  async function handleRequest(request, env, ctx) {
    return new Response(loginPage, {
      headers: { 'Content-Type': 'text/html; charset=utf-8' }
    });
  }

  const CryptoJS = {
    HmacSHA256: function(message, key) {
      const keyData = new TextEncoder().encode(key);
      const messageData = new TextEncoder().encode(message);

      return Promise.resolve().then(() => {
        return crypto.subtle.importKey(
          "raw",
          keyData,
          { name: "HMAC", hash: {name: "SHA-256"} },
          false,
          ["sign"]
        );
      }).then(cryptoKey => {
        return crypto.subtle.sign(
          "HMAC",
          cryptoKey,
          messageData
        );
      }).then(buffer => {
        const hashArray = Array.from(new Uint8Array(buffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      });
    }
  };

  export default {
    async fetch(request, env, ctx) {
      const url = new URL(request.url);

      // æ·»åŠ è°ƒè¯•é¡µé¢
      if (url.pathname === '/debug') {
        try {
          const config = await getConfig(env);
          const debugInfo = {
            timestamp: new Date().toISOString(),
            pathname: url.pathname,
            kvBinding: !!env.SUBSCRIPTIONS_KV,
            configExists: !!config,
            adminUsername: config.ADMIN_USERNAME,
            hasJwtSecret: !!config.JWT_SECRET,
            jwtSecretLength: config.JWT_SECRET ? config.JWT_SECRET.length : 0
          };

          return new Response(`
  <!DOCTYPE html>
  <html>
  <head>
    <title>è°ƒè¯•ä¿¡æ¯</title>
    <style>
      body { font-family: monospace; padding: 20px; background: #f5f5f5; }
      .info { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; }
      .success { color: green; }
      .error { color: red; }
    </style>
  </head>
  <body>
    <h1>ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯</h1>
    <div class="info">
      <h3>åŸºæœ¬ä¿¡æ¯</h3>
      <p>æ—¶é—´: ${debugInfo.timestamp}</p>
      <p>è·¯å¾„: ${debugInfo.pathname}</p>
      <p class="${debugInfo.kvBinding ? 'success' : 'error'}">KVç»‘å®š: ${debugInfo.kvBinding ? 'âœ“' : 'âœ—'}</p>
    </div>

    <div class="info">
      <h3>é…ç½®ä¿¡æ¯</h3>
      <p class="${debugInfo.configExists ? 'success' : 'error'}">é…ç½®å­˜åœ¨: ${debugInfo.configExists ? 'âœ“' : 'âœ—'}</p>
      <p>ç®¡ç†å‘˜ç”¨æˆ·å: ${debugInfo.adminUsername}</p>
      <p class="${debugInfo.hasJwtSecret ? 'success' : 'error'}">JWTå¯†é’¥: ${debugInfo.hasJwtSecret ? 'âœ“' : 'âœ—'} (é•¿åº¦: ${debugInfo.jwtSecretLength})</p>
    </div>

    <div class="info">
      <h3>è§£å†³æ–¹æ¡ˆ</h3>
      <p>1. ç¡®ä¿KVå‘½åç©ºé—´å·²æ­£ç¡®ç»‘å®šä¸º SUBSCRIPTIONS_KV</p>
      <p>2. å°è¯•è®¿é—® <a href="/">/</a> è¿›è¡Œç™»å½•</p>
      <p>3. å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥Cloudflare Workersæ—¥å¿—</p>
    </div>
  </body>
  </html>`, {
            headers: { 'Content-Type': 'text/html; charset=utf-8' }
          });
        } catch (error) {
          return new Response(`è°ƒè¯•é¡µé¢é”™è¯¯: ${error.message}`, {
            status: 500,
            headers: { 'Content-Type': 'text/plain; charset=utf-8' }
          });
        }
      }

      if (url.pathname.startsWith('/api')) {
        return api.handleRequest(request, env, ctx);
      } else if (url.pathname.startsWith('/admin')) {
        return admin.handleRequest(request, env, ctx);
      } else {
        return handleRequest(request, env, ctx);
      }
    },

    async scheduled(event, env, ctx) {
      const now = new Date();
      const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
      console.log('[Workers] å®šæ—¶ä»»åŠ¡è§¦å‘ UTC:', now.toISOString(), 'åŒ—äº¬æ—¶é—´:', beijingTime.toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}));
      await checkExpiringSubscriptions(env);
    }
  };
  ```

  SubsTracker å¼€æºé¡¹ç›®ã€[ä»“åº“](https://github.com/wangwangit/SubsTracker))ã€‘
* ## å¦‚ä½•è·å–[Telegram](https://www.freedidi.com/?golink=aHR0cHM6Ly90ZWxlZ3JhbS5vcmcv)çš„`Bot_Token`å’Œ`Chat_ID`

  å¦‚æœæ‚¨è¿˜æ²¡æœ‰Telegramè´¦æˆ·ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªã€‚æ¥ç€ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œä»¥è·å–`BOT_TOKEN`å’Œ`CHAT_ID`ï¼š


  1. **è·å–`Bot_Token`**
     * åœ¨Telegramä¸­ï¼Œå‘[@BotFather](https://www.freedidi.com/?golink=aHR0cHM6Ly90Lm1lL0JvdEZhdGhlcg==)å‘é€å‘½ä»¤`/newbot`ï¼Œæ ¹æ®æç¤ºä¾æ¬¡è¾“å…¥æ‚¨çš„æœºå™¨äººåç§°å’Œç”¨æˆ·åã€‚æˆåŠŸåˆ›å»ºæœºå™¨äººåï¼Œæ‚¨å°†ä¼šæ”¶åˆ°ä¸€ä¸ª`BOT_TOKEN`ï¼Œç”¨äºä¸Telegram APIè¿›è¡Œäº¤äº’ã€‚ï¼ˆè¿™ä¸€ä¸²apiå°±æ˜¯Bot_Token)

<img src="https://5f4480c.webp.li/2025/07/83e2d63c90806894da9223e4fc2bd31b.webp" >

<img src="https://5f4480c.webp.li/2025/07/dfa9d7a0ea65bd514d1a6ca998d38c48.png" >

2ï¼šæ¥ç€æœç´¢ï¼š@getmyid\_bot è¿™ä¸ªæœºå™¨äººå¹¶å‘é€ä¿¡æ¯/start ç»™å®ƒå°±å¯ä»¥è·å¾—ä½ çš„ Chat IDï¼ˆCurrent chat IDï¼‰

<img src="https://5f4480c.webp.li/2025/07/74dc830a800251ad9b0d232d3261f919.jpg" >

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å‰ææ¡ä»¶

* Cloudflareè´¦æˆ·
* Telegram Bot (ç”¨äºå‘é€é€šçŸ¥)
* å¯ä»¥ç›´æ¥å°†ä»£ç ä¸¢ç»™AI,å¸®åŠ©æŸ¥æ¼è¡¥ç¼º

### éƒ¨ç½²æ­¥éª¤

**æ³¨æ„ï¼ï¼**ï¼šåœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€åœ¨Cloudfalreæ§åˆ¶å·¦ä¾§é¢æ¿é‡Œï¼Œä¾æ¬¡ç‚¹å‡»ï¼šå­˜å‚¨å’Œæ•°æ®åº“ â€“ KV â€“ åˆ›å»º â€“ åˆ›å»ºKVç©ºé—´ï¼Œç©ºé—´åç§°å¡«å†™ï¼šSUBSCRIPTIONS\_KV ä¿å­˜ã€‚**å¦åˆ™ SubsTracker æ·»åŠ è®¢é˜…å°†æ— æ³•ä¿å­˜ï¼**

1.ç™»é™†cloudflare,åˆ›å»ºworker,ç²˜è´´æœ¬é¡¹ç›®ä¸­çš„jsä»£ç ,ç‚¹å‡»éƒ¨ç½²

<img src="https://5f4480c.webp.li/2025/07/f3cacad2c75008b233493d4c9b66f9bf.png" >

2.åˆ›å»ºKVé”®å€¼ **SUBSCRIPTIONS\_KV**

<img src="https://5f4480c.webp.li/2025/07/c778add4e9398660731dd6ba5b2eb935.png" >

3.ç»™workerç»‘å®šä¸Šé”®å€¼å¯¹,ä»¥åŠè®¾ç½®å®šæ—¶æ‰§è¡Œæ—¶é—´!

<img src="https://5f4480c.webp.li/2025/07/1057537ce1a73ab5b949562b6ccce46e.png" >

4.æ‰“å¼€workeræä¾›çš„åŸŸååœ°å€,è¾“å…¥é»˜è®¤è´¦å·å¯†ç : admin password (æˆ–è€…æ˜¯ï¼šadmin admin123),å¯ä»¥åœ¨ä»£ç ä¸­æŸ¥çœ‹é»˜è®¤è´¦å·å¯†ç !

<img src="https://5f4480c.webp.li/2025/07/afc71eb7193ffcc329983d745874efe4.png" >

5.å‰å¾€ç³»ç»Ÿé…ç½®,ä¿®æ”¹è´¦å·å¯†ç ,ä»¥åŠé…ç½®tgé€šçŸ¥çš„ä¿¡æ¯

<img src="https://5f4480c.webp.li/2025/07/e1b8815294817c7acef4c2ef012577c3.png" >

6.é…ç½®å®Œæˆå¯ä»¥ç‚¹å‡»æµ‹è¯•é€šçŸ¥,æŸ¥çœ‹æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸é€šçŸ¥,ç„¶åå°±å¯ä»¥æ­£å¸¸æ·»åŠ è®¢é˜…ä½¿ç”¨äº†!

<img src="https://5f4480c.webp.li/2025/07/f7f30af1d278dc0595c49b799b726836.png" >

æ³¨ï¼šå†…å®¹ç¼–è¾‘äºæ²¹ç®¡ï¼šé›¶åº¦è§£è¯´
