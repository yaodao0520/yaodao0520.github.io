---
abbrlink: 'SubsTracker '
ai: å·¥å…·
aplayer: null
aside: null
background: '#fff'
categories:
- - å·¥å…·ç±»
comments: null
copyright: null
copyright_author: null
copyright_author_href: null
copyright_info: null
copyright_url: null
cover: https://5f4480c.webp.li/2025/07/a451a90a4bf6a24ba9772733ccec5d10.webp
date: '2025-07-05T13:44:04.162058+08:00'
description: null
highlight_shrink: null
katex: null
keywords: null
mathjax: null
swiper_index: 10
tags:
- å·¥å…·ç±»
title: ' è®¢é˜…ç®¡ç†ä¸æé†’ç³»ç»Ÿ'
toc: null
toc_number: null
toc_style_simple: null
top: null
top_group_index: 10
top_img: https://5f4480c.webp.li/2025/07/a451a90a4bf6a24ba9772733ccec5d10.webp
updated: '2025-07-05T15:06:36.329+08:00'
---
**SubsTracker â€“ è®¢é˜…ç®¡ç†ä¸æé†’ç³»ç»Ÿæ˜¯**åŸºäºCloudflare Workersçš„è½»é‡çº§è®¢é˜…ç®¡ç†ç³»ç»Ÿï¼Œå¸®åŠ©æ‚¨è½»æ¾è·Ÿè¸ªå„ç±»è®¢é˜…æœåŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œå¹¶é€šè¿‡Telegramå‘é€åŠæ—¶æé†’ã€‚

<img src="https://5f4480c.webp.li/2025/07/afc71eb7193ffcc329983d745874efe4.png" >

<img src="https://5f4480c.webp.li/2025/07/a451a90a4bf6a24ba9772733ccec5d10.webp" >

## âœ¨ ç‰¹æ€§

* ğŸ”” **è‡ªåŠ¨æé†’**: åœ¨è®¢é˜…åˆ°æœŸå‰è‡ªåŠ¨å‘é€Telegramé€šçŸ¥
* ğŸ“Š **è®¢é˜…ç®¡ç†**: ç›´è§‚çš„Webç•Œé¢ç®¡ç†æ‰€æœ‰è®¢é˜…
* ğŸ”„ **å‘¨æœŸè®¡ç®—**: æ™ºèƒ½è®¡ç®—å¾ªç¯è®¢é˜…çš„ä¸‹ä¸€ä¸ªå‘¨æœŸ
* ğŸ“± **å“åº”å¼è®¾è®¡**: å®Œç¾é€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢è®¾å¤‡
* â˜ï¸ **å…æœåŠ¡å™¨**: åŸºäºCloudflare Workersï¼Œæ— éœ€è‡ªå»ºæœåŠ¡å™¨
* ğŸ”’ **å®‰å…¨å¯é **: æ•°æ®å­˜å‚¨åœ¨Cloudflare KVä¸­ï¼Œå®‰å…¨ä¸”é«˜æ•ˆ

  ** V3 ç‰ˆæœ¬ä»£ç ï¼š**

  ```

  * ```
    // è®¢é˜…ç»­æœŸé€šçŸ¥ç½‘ç«™ - åŸºäºCloudFlare Workers (å®Œå…¨ä¼˜åŒ–ç‰ˆ)

    // å®šä¹‰HTMLæ¨¡æ¿
    const loginPage = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
      <style>
        .login-container {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
        }
        .login-box {
          backdrop-filter: blur(8px);
          background-color: rgba(255, 255, 255, 0.9);
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          transition: all 0.3s;
        }
        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .input-field {
          transition: all 0.3s;
          border: 1px solid #e2e8f0;
        }
        .input-field:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }
      </style>
    </head>
    <body class="login-container flex items-center justify-center">
      <div class="login-box p-8 rounded-xl w-full max-w-md">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-calendar-check mr-2"></i>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</h1>
          <p class="text-gray-600 mt-2">ç™»å½•ç®¡ç†æ‚¨çš„è®¢é˜…æé†’</p>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">
              <i class="fas fa-user mr-2"></i>ç”¨æˆ·å
            </label>
            <input type="text" id="username" name="username" required
              class="input-field w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none">
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
              <i class="fas fa-lock mr-2"></i>å¯†ç 
            </label>
            <input type="password" id="password" name="password" required
              class="input-field w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none">
          </div>

          <button type="submit" 
            class="btn-primary w-full py-3 rounded-lg text-white font-medium focus:outline-none">
            <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
          </button>

          <div id="errorMsg" class="text-red-500 text-center"></div>
        </form>
      </div>

      <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          const button = e.target.querySelector('button');
          const originalContent = button.innerHTML;
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç™»å½•ä¸­...';
          button.disabled = true;

          try {
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });

            const result = await response.json();

            if (result.success) {
              window.location.href = '/admin';
            } else {
              document.getElementById('errorMsg').textContent = result.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
              button.innerHTML = originalContent;
              button.disabled = false;
            }
          } catch (error) {
            document.getElementById('errorMsg').textContent = 'å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        });
      </script>
    </body>
    </html>
    `;

    const adminPage = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
      <style>
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn-danger { background: linear-gradient(135deg, #f87171 0%, #dc2626 100%); transition: all 0.3s; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn-success { background: linear-gradient(135deg, #34d399 0%, #059669 100%); transition: all 0.3s; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn-warning { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); transition: all 0.3s; }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); transition: all 0.3s; }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .table-container { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .modal-container { backdrop-filter: blur(8px); }
        .readonly-input { background-color: #f8fafc; border-color: #e2e8f0; cursor: not-allowed; }
        .error-message { font-size: 0.875rem; margin-top: 0.25rem; display: none; }
        .error-message.show { display: block; }

        /* Toast æ ·å¼ */
        .toast {
          position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
          color: white; font-weight: 500; z-index: 1000; transform: translateX(400px);
          transition: all 0.3s ease-in-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        .toast.warning { background-color: #f59e0b; }
      </style>
    </head>
    <body class="bg-gray-100 min-h-screen">
      <div id="toast-container"></div>

      <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
            <div class="flex items-center">
              <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
              <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
            </div>
            <div class="flex items-center space-x-4">
              <a href="/admin" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
              </a>
              <a href="/admin/config" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
              </a>
              <a href="/api/logout" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
              </a>
            </div>
          </div>
        </div>
      </nav>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">è®¢é˜…åˆ—è¡¨</h2>
          <div class="flex space-x-2">
            <button id="addSubscriptionBtn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
              <i class="fas fa-plus mr-2"></i>æ·»åŠ æ–°è®¢é˜…
            </button>
          </div>
        </div>

        <div class="table-container bg-white rounded-lg overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç§°</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç±»å‹</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  åˆ°æœŸæ—¶é—´ <i class="fas fa-sort-up ml-1 text-indigo-500" title="æŒ‰åˆ°æœŸæ—¶é—´å‡åºæ’åˆ—"></i>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æé†’è®¾ç½®</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="subscriptionsBody" class="bg-white divide-y divide-gray-200">
            </tbody>
          </table>
        </div>
      </div>

      <!-- æ·»åŠ /ç¼–è¾‘è®¢é˜…çš„æ¨¡æ€æ¡† -->
      <div id="subscriptionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-container hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
          <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
            <div class="flex items-center justify-between">
              <h3 id="modalTitle" class="text-lg font-medium text-gray-900">æ·»åŠ æ–°è®¢é˜…</h3>
              <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>

          <form id="subscriptionForm" class="p-6 space-y-6">
            <input type="hidden" id="subscriptionId">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…åç§° *</label>
                <input type="text" id="name" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <div class="error-message text-red-500"></div>
              </div>

              <div>
                <label for="customType" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…ç±»å‹</label>
                <input type="text" id="customType" placeholder="ä¾‹å¦‚ï¼šæµåª’ä½“ã€äº‘æœåŠ¡ã€è½¯ä»¶ç­‰"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <div class="error-message text-red-500"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="startDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <div class="error-message text-red-500"></div>
              </div>

              <div>
                <label for="periodValue" class="block text-sm font-medium text-gray-700 mb-1">å‘¨æœŸæ•°å€¼ *</label>
                <input type="number" id="periodValue" min="1" value="1" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <div class="error-message text-red-500"></div>
              </div>

              <div>
                <label for="periodUnit" class="block text-sm font-medium text-gray-700 mb-1">å‘¨æœŸå•ä½ *</label>
                <select id="periodUnit" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="day">å¤©</option>
                  <option value="month" selected>æœˆ</option>
                  <option value="year">å¹´</option>
                </select>
                <div class="error-message text-red-500"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">åˆ°æœŸæ—¥æœŸ *</label>
                <input type="date" id="expiryDate" required
                  class="readonly-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none">
                <div class="error-message text-red-500"></div>
              </div>

              <div class="flex items-end">
                <button type="button" id="calculateExpiryBtn" 
                  class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium h-10">
                  <i class="fas fa-calculator mr-2"></i>è‡ªåŠ¨è®¡ç®—åˆ°æœŸæ—¥æœŸ
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="reminderDays" class="block text-sm font-medium text-gray-700 mb-1">æå‰æé†’å¤©æ•°</label>
                <input type="number" id="reminderDays" min="0" value="7"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <p class="text-xs text-gray-500 mt-1">0 = ä»…åˆ°æœŸæ—¥å½“å¤©æé†’ï¼Œ1+ = æå‰Nå¤©å¼€å§‹æé†’</p>
                <div class="error-message text-red-500"></div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">é€‰é¡¹è®¾ç½®</label>
                <div class="space-y-2">
                  <label class="inline-flex items-center">
                    <input type="checkbox" id="isActive" checked 
                      class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700">å¯ç”¨è®¢é˜…</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="checkbox" id="autoRenew" checked 
                      class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700">è‡ªåŠ¨ç»­è®¢</span>
                  </label>
                </div>
              </div>
            </div>

            <div>
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
              <textarea id="notes" rows="3" placeholder="å¯æ·»åŠ ç›¸å…³å¤‡æ³¨ä¿¡æ¯..."
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
              <div class="error-message text-red-500"></div>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
              <button type="button" id="cancelBtn" 
                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                å–æ¶ˆ
              </button>
              <button type="submit" 
                class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-save mr-2"></i>ä¿å­˜
              </button>
            </div>
          </form>
        </div>
      </div>

      <script>
        function showToast(message, type = 'success', duration = 3000) {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'toast ' + type;

          const icon = type === 'success' ? 'check-circle' :
                       type === 'error' ? 'exclamation-circle' :
                       type === 'warning' ? 'exclamation-triangle' : 'info-circle';

          toast.innerHTML = '<div class="flex items-center"><i class="fas fa-' + icon + ' mr-2"></i><span>' + message + '</span></div>';

          container.appendChild(toast);
          setTimeout(() => toast.classList.add('show'), 100);
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              if (container.contains(toast)) {
                container.removeChild(toast);
              }
            }, 300);
          }, duration);
        }

        function showFieldError(fieldId, message) {
          const field = document.getElementById(fieldId);
          const errorDiv = field.parentElement.querySelector('.error-message');
          if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            field.classList.add('border-red-500');
          }
        }

        function clearFieldErrors() {
          document.querySelectorAll('.error-message').forEach(el => {
            el.classList.remove('show');
            el.textContent = '';
          });
          document.querySelectorAll('.border-red-500').forEach(el => {
            el.classList.remove('border-red-500');
          });
        }

        function validateForm() {
          clearFieldErrors();
          let isValid = true;

          const name = document.getElementById('name').value.trim();
          if (!name) {
            showFieldError('name', 'è¯·è¾“å…¥è®¢é˜…åç§°');
            isValid = false;
          }

          const periodValue = document.getElementById('periodValue').value;
          if (!periodValue || periodValue < 1) {
            showFieldError('periodValue', 'å‘¨æœŸæ•°å€¼å¿…é¡»å¤§äº0');
            isValid = false;
          }

          const expiryDate = document.getElementById('expiryDate').value;
          if (!expiryDate) {
            showFieldError('expiryDate', 'è¯·é€‰æ‹©åˆ°æœŸæ—¥æœŸ');
            isValid = false;
          }

          const reminderDays = document.getElementById('reminderDays').value;
          if (reminderDays === '' || reminderDays < 0) {
            showFieldError('reminderDays', 'æé†’å¤©æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
            isValid = false;
          }

          return isValid;
        }

        // è·å–æ‰€æœ‰è®¢é˜…å¹¶æŒ‰åˆ°æœŸæ—¶é—´æ’åº
        async function loadSubscriptions() {
          try {
            const tbody = document.getElementById('subscriptionsBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ä¸­...</td></tr>';

            const response = await fetch('/api/subscriptions');
            const data = await response.json();

            tbody.innerHTML = '';

            if (data.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">æ²¡æœ‰è®¢é˜…æ•°æ®</td></tr>';
              return;
            }

            // æŒ‰åˆ°æœŸæ—¶é—´å‡åºæ’åºï¼ˆæœ€æ—©åˆ°æœŸçš„åœ¨å‰ï¼‰
            data.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

            data.forEach(subscription => {
              const row = document.createElement('tr');
              row.className = subscription.isActive === false ? 'hover:bg-gray-50 bg-gray-100' : 'hover:bg-gray-50';

              const expiryDate = new Date(subscription.expiryDate);
              const now = new Date();
              const daysDiff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

              let statusHtml = '';
              if (!subscription.isActive) {
                statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-gray-500"><i class="fas fa-pause-circle mr-1"></i>å·²åœç”¨</span>';
              } else if (daysDiff < 0) {
                statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-red-500"><i class="fas fa-exclamation-circle mr-1"></i>å·²è¿‡æœŸ</span>';
              } else if (daysDiff <= (subscription.reminderDays || 7)) {
                statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-yellow-500"><i class="fas fa-exclamation-triangle mr-1"></i>å³å°†åˆ°æœŸ</span>';
              } else {
                statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-green-500"><i class="fas fa-check-circle mr-1"></i>æ­£å¸¸</span>';
              }

              let periodText = '';
              if (subscription.periodValue && subscription.periodUnit) {
                const unitMap = { day: 'å¤©', month: 'æœˆ', year: 'å¹´' };
                periodText = subscription.periodValue + ' ' + (unitMap[subscription.periodUnit] || subscription.periodUnit);
              }

              const autoRenewIcon = subscription.autoRenew !== false ? 
                '<i class="fas fa-sync-alt text-blue-500 ml-1" title="è‡ªåŠ¨ç»­è®¢"></i>' : 
                '<i class="fas fa-ban text-gray-400 ml-1" title="ä¸è‡ªåŠ¨ç»­è®¢"></i>';

              row.innerHTML = 
                '<td class="px-6 py-4 whitespace-nowrap">' + 
                  '<div class="text-sm font-medium text-gray-900">' + subscription.name + '</div>' +
                  (subscription.notes ? '<div class="text-xs text-gray-500">' + subscription.notes + '</div>' : '') +
                '</td>' +
                '<td class="px-6 py-4 whitespace-nowrap">' + 
                  '<div class="text-sm text-gray-900">' + 
                    '<i class="fas fa-tag mr-1"></i>' + (subscription.customType || 'å…¶ä»–') + 
                  '</div>' +
                  (periodText ? '<div class="text-xs text-gray-500">å‘¨æœŸ: ' + periodText + autoRenewIcon + '</div>' : '') +
                '</td>' +
                '<td class="px-6 py-4 whitespace-nowrap">' + 
                  '<div class="text-sm text-gray-900">' + new Date(subscription.expiryDate).toLocaleDateString() + '</div>' +
                  '<div class="text-xs text-gray-500">' + (daysDiff < 0 ? 'å·²è¿‡æœŸ' + Math.abs(daysDiff) + 'å¤©' : 'è¿˜å‰©' + daysDiff + 'å¤©') + '</div>' +
                  (subscription.startDate ? '<div class="text-xs text-gray-500">å¼€å§‹: ' + new Date(subscription.startDate).toLocaleDateString() + '</div>' : '') +
                '</td>' +
                '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + 
                  '<div><i class="fas fa-bell mr-1"></i>æå‰' + (subscription.reminderDays || 0) + 'å¤©</div>' +
                  (subscription.reminderDays === 0 ? '<div class="text-xs text-gray-500">ä»…åˆ°æœŸæ—¥æé†’</div>' : '') +
                '</td>' +
                '<td class="px-6 py-4 whitespace-nowrap">' + statusHtml + '</td>' +
                '<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">' +
                  '<div class="flex flex-wrap gap-1">' +
                    '<button class="edit btn-primary text-white px-2 py-1 rounded text-xs" data-id="' + subscription.id + '"><i class="fas fa-edit mr-1"></i>ç¼–è¾‘</button>' +
                    '<button class="test-notify btn-info text-white px-2 py-1 rounded text-xs" data-id="' + subscription.id + '"><i class="fas fa-paper-plane mr-1"></i>æµ‹è¯•</button>' +
                    '<button class="delete btn-danger text-white px-2 py-1 rounded text-xs" data-id="' + subscription.id + '"><i class="fas fa-trash-alt mr-1"></i>åˆ é™¤</button>' +
                    (subscription.isActive ? 
                      '<button class="toggle-status btn-warning text-white px-2 py-1 rounded text-xs" data-id="' + subscription.id + '" data-action="deactivate"><i class="fas fa-pause-circle mr-1"></i>åœç”¨</button>' : 
                      '<button class="toggle-status btn-success text-white px-2 py-1 rounded text-xs" data-id="' + subscription.id + '" data-action="activate"><i class="fas fa-play-circle mr-1"></i>å¯ç”¨</button>') +
                  '</div>' +
                '</td>';

              tbody.appendChild(row);
            });

            document.querySelectorAll('.edit').forEach(button => {
              button.addEventListener('click', editSubscription);
            });

            document.querySelectorAll('.delete').forEach(button => {
              button.addEventListener('click', deleteSubscription);
            });

            document.querySelectorAll('.toggle-status').forEach(button => {
              button.addEventListener('click', toggleSubscriptionStatus);
            });

            document.querySelectorAll('.test-notify').forEach(button => {
              button.addEventListener('click', testSubscriptionNotification);
            });
          } catch (error) {
            console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
            const tbody = document.getElementById('subscriptionsBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</td></tr>';
            showToast('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥', 'error');
          }
        }

        async function testSubscriptionNotification(e) {
            const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
            const id = button.dataset.id;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>';
            button.disabled = true;

            try {
                const response = await fetch('/api/subscriptions/' + id + '/test-notify', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message || 'æµ‹è¯•é€šçŸ¥å·²å‘é€', 'success');
                } else {
                    showToast(result.message || 'æµ‹è¯•é€šçŸ¥å‘é€å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
                showToast('å‘é€æµ‹è¯•é€šçŸ¥æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            } finally {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        async function toggleSubscriptionStatus(e) {
          const id = e.target.dataset.id || e.target.parentElement.dataset.id;
          const action = e.target.dataset.action || e.target.parentElement.dataset.action;
          const isActivate = action === 'activate';

          const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
          const originalContent = button.innerHTML;
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + (isActivate ? 'å¯ç”¨ä¸­...' : 'åœç”¨ä¸­...');
          button.disabled = true;

          try {
            const response = await fetch('/api/subscriptions/' + id + '/toggle-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isActive: isActivate })
            });

            if (response.ok) {
              showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'æˆåŠŸ', 'success');
              loadSubscriptions();
            } else {
              const error = await response.json();
              showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
              button.innerHTML = originalContent;
              button.disabled = false;
            }
          } catch (error) {
            console.error((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'è®¢é˜…å¤±è´¥:', error);
            showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        }

        document.getElementById('addSubscriptionBtn').addEventListener('click', () => {
          document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°è®¢é˜…';
          document.getElementById('subscriptionModal').classList.remove('hidden');

          document.getElementById('subscriptionForm').reset();
          document.getElementById('subscriptionId').value = '';
          clearFieldErrors();

          const today = new Date().toISOString().split('T')[0];
          document.getElementById('startDate').value = today;
          document.getElementById('reminderDays').value = '7';
          document.getElementById('isActive').checked = true;
          document.getElementById('autoRenew').checked = true;

          calculateExpiryDate();
          setupModalEventListeners();
        });

        function setupModalEventListeners() {
          document.getElementById('calculateExpiryBtn').removeEventListener('click', calculateExpiryDate);
          document.getElementById('calculateExpiryBtn').addEventListener('click', calculateExpiryDate);

          ['startDate', 'periodValue', 'periodUnit'].forEach(id => {
            const element = document.getElementById(id);
            element.removeEventListener('change', calculateExpiryDate);
            element.addEventListener('change', calculateExpiryDate);
          });

          document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('subscriptionModal').classList.add('hidden');
          });
        }

        function calculateExpiryDate() {
          const startDate = document.getElementById('startDate').value;
          const periodValue = parseInt(document.getElementById('periodValue').value);
          const periodUnit = document.getElementById('periodUnit').value;

          if (!startDate || !periodValue || !periodUnit) {
            return;
          }

          const start = new Date(startDate);
          const expiry = new Date(start);

          if (periodUnit === 'day') {
            expiry.setDate(start.getDate() + periodValue);
          } else if (periodUnit === 'month') {
            expiry.setMonth(start.getMonth() + periodValue);
          } else if (periodUnit === 'year') {
            expiry.setFullYear(start.getFullYear() + periodValue);
          }

          document.getElementById('expiryDate').value = expiry.toISOString().split('T')[0];
        }

        document.getElementById('closeModal').addEventListener('click', () => {
          document.getElementById('subscriptionModal').classList.add('hidden');
        });

        document.getElementById('subscriptionModal').addEventListener('click', (event) => {
          if (event.target === document.getElementById('subscriptionModal')) {
            document.getElementById('subscriptionModal').classList.add('hidden');
          }
        });

        document.getElementById('subscriptionForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!validateForm()) {
            return;
          }

          const id = document.getElementById('subscriptionId').value;
          const subscription = {
            name: document.getElementById('name').value.trim(),
            customType: document.getElementById('customType').value.trim(),
            notes: document.getElementById('notes').value.trim() || '',
            isActive: document.getElementById('isActive').checked,
            autoRenew: document.getElementById('autoRenew').checked,
            startDate: document.getElementById('startDate').value,
            expiryDate: document.getElementById('expiryDate').value,
            periodValue: parseInt(document.getElementById('periodValue').value),
            periodUnit: document.getElementById('periodUnit').value,
            reminderDays: parseInt(document.getElementById('reminderDays').value) || 0
          };

          const submitButton = e.target.querySelector('button[type="submit"]');
          const originalContent = submitButton.innerHTML;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + (id ? 'æ›´æ–°ä¸­...' : 'ä¿å­˜ä¸­...');
          submitButton.disabled = true;

          try {
            const url = id ? '/api/subscriptions/' + id : '/api/subscriptions';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(subscription)
            });

            const result = await response.json();

            if (result.success) {
              showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…æˆåŠŸ', 'success');
              document.getElementById('subscriptionModal').classList.add('hidden');
              loadSubscriptions();
            } else {
              showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
          } catch (error) {
            console.error((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥:', error);
            showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
          } finally {
            submitButton.innerHTML = originalContent;
            submitButton.disabled = false;
          }
        });

        async function editSubscription(e) {
          const id = e.target.dataset.id || e.target.parentElement.dataset.id;

          try {
            const response = await fetch('/api/subscriptions/' + id);
            const subscription = await response.json();

            if (subscription) {
              document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è®¢é˜…';
              document.getElementById('subscriptionId').value = subscription.id;
              document.getElementById('name').value = subscription.name;
              document.getElementById('customType').value = subscription.customType || '';
              document.getElementById('notes').value = subscription.notes || '';
              document.getElementById('isActive').checked = subscription.isActive !== false;
              document.getElementById('autoRenew').checked = subscription.autoRenew !== false;
              document.getElementById('startDate').value = subscription.startDate ? subscription.startDate.split('T')[0] : '';
              document.getElementById('expiryDate').value = subscription.expiryDate ? subscription.expiryDate.split('T')[0] : '';
              document.getElementById('periodValue').value = subscription.periodValue || 1;
              document.getElementById('periodUnit').value = subscription.periodUnit || 'month';
              document.getElementById('reminderDays').value = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;

              clearFieldErrors();
              document.getElementById('subscriptionModal').classList.remove('hidden');
              setupModalEventListeners();
            }
          } catch (error) {
            console.error('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥:', error);
            showToast('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥', 'error');
          }
        }

        async function deleteSubscription(e) {
          const id = e.target.dataset.id || e.target.parentElement.dataset.id;

          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
          }

          const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
          const originalContent = button.innerHTML;
          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>åˆ é™¤ä¸­...';
          button.disabled = true;

          try {
            const response = await fetch('/api/subscriptions/' + id, {
              method: 'DELETE'
            });

            if (response.ok) {
              showToast('åˆ é™¤æˆåŠŸ', 'success');
              loadSubscriptions();
            } else {
              const error = await response.json();
              showToast('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
              button.innerHTML = originalContent;
              button.disabled = false;
            }
          } catch (error) {
            console.error('åˆ é™¤è®¢é˜…å¤±è´¥:', error);
            showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        }

        window.addEventListener('load', loadSubscriptions);
      </script>
    </body>
    </html>
    `;

    const configPage = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ç³»ç»Ÿé…ç½® - è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
      <style>
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .btn-secondary { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); transition: all 0.3s; }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }

        .toast {
          position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
          color: white; font-weight: 500; z-index: 1000; transform: translateX(400px);
          transition: all 0.3s ease-in-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        .toast.warning { background-color: #f59e0b; }

        .config-section { 
          border: 1px solid #e5e7eb; 
          border-radius: 8px; 
          padding: 16px; 
          margin-bottom: 24px; 
        }
        .config-section.active { 
          background-color: #f8fafc; 
          border-color: #6366f1; 
        }
        .config-section.inactive { 
          background-color: #f9fafb; 
          opacity: 0.7; 
        }
      </style>
    </head>
    <body class="bg-gray-100 min-h-screen">
      <div id="toast-container"></div>

      <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
            <div class="flex items-center">
              <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
              <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
            </div>
            <div class="flex items-center space-x-4">
              <a href="/admin" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
              </a>
              <a href="/admin/config" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
              </a>
              <a href="/api/logout" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
              </a>
            </div>
          </div>
        </div>
      </nav>

      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»ç»Ÿé…ç½®</h2>

          <form id="configForm" class="space-y-8">
            <div class="border-b border-gray-200 pb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">ç®¡ç†å‘˜è´¦æˆ·</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="adminUsername" class="block text-sm font-medium text-gray-700">ç”¨æˆ·å</label>
                  <input type="text" id="adminUsername" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                  <label for="adminPassword" class="block text-sm font-medium text-gray-700">å¯†ç </label>
                  <input type="password" id="adminPassword" placeholder="å¦‚ä¸ä¿®æ”¹å¯†ç ï¼Œè¯·ç•™ç©º" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å½“å‰å¯†ç </p>
                </div>
              </div>
            </div>

            <div class="border-b border-gray-200 pb-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">é€šçŸ¥è®¾ç½®</h3>
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">é€šçŸ¥æ–¹å¼</label>
                <div class="flex space-x-6">
                  <label class="inline-flex items-center">
                    <input type="radio" name="notificationType" value="telegram" class="form-radio h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="ml-2 text-sm text-gray-700">Telegram</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="notificationType" value="notifyx" class="form-radio h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                    <span class="ml-2 text-sm text-gray-700 font-semibold">NotifyXï¼ˆæ¨èï¼‰</span>
                  </label>
                  <a href="https://www.notifyx.cn/" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                    <i class="fas fa-external-link-alt ml-1"></i> NotifyXå®˜ç½‘
                  </a>
                </div>
              </div>

              <div id="telegramConfig" class="config-section">
                <h4 class="text-md font-medium text-gray-900 mb-3">Telegram é…ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label for="tgBotToken" class="block text-sm font-medium text-gray-700">Bot Token</label>
                    <input type="text" id="tgBotToken" placeholder="ä» @BotFather è·å–" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  </div>
                  <div>
                    <label for="tgChatId" class="block text-sm font-medium text-gray-700">Chat ID</label>
                    <input type="text" id="tgChatId" placeholder="å¯ä» @userinfobot è·å–" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  </div>
                </div>
                <div class="flex justify-end">
                  <button type="button" id="testTelegramBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• Telegram é€šçŸ¥
                  </button>
                </div>
              </div>

              <div id="notifyxConfig" class="config-section">
                <h4 class="text-md font-medium text-gray-900 mb-3">NotifyX é…ç½®</h4>
                <div class="mb-4">
                  <label for="notifyxApiKey" class="block text-sm font-medium text-gray-700">API Key</label>
                  <input type="text" id="notifyxApiKey" placeholder="ä» NotifyX å¹³å°è·å–çš„ API Key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <p class="mt-1 text-sm text-gray-500">ä» <a href="https://www.notifyx.cn/" target="_blank" class="text-indigo-600 hover:text-indigo-800">NotifyXå¹³å°</a> è·å–çš„ API Key</p>
                </div>
                <div class="flex justify-end">
                  <button type="button" id="testNotifyXBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• NotifyX é€šçŸ¥
                  </button>
                </div>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="submit" class="btn-primary text-white px-6 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
              </button>
            </div>
          </form>
        </div>
      </div>

      <script>
        function showToast(message, type = 'success', duration = 3000) {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'toast ' + type;

          const icon = type === 'success' ? 'check-circle' :
                       type === 'error' ? 'exclamation-circle' :
                       type === 'warning' ? 'exclamation-triangle' : 'info-circle';

          toast.innerHTML = '<div class="flex items-center"><i class="fas fa-' + icon + ' mr-2"></i><span>' + message + '</span></div>';

          container.appendChild(toast);
          setTimeout(() => toast.classList.add('show'), 100);
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              if (container.contains(toast)) {
                container.removeChild(toast);
              }
            }, 300);
          }, duration);
        }

        async function loadConfig() {
          try {
            const response = await fetch('/api/config');
            const config = await response.json();

            document.getElementById('adminUsername').value = config.ADMIN_USERNAME || '';
            document.getElementById('tgBotToken').value = config.TG_BOT_TOKEN || '';
            document.getElementById('tgChatId').value = config.TG_CHAT_ID || '';
            document.getElementById('notifyxApiKey').value = config.NOTIFYX_API_KEY || '';

            const notificationType = config.NOTIFICATION_TYPE || 'notifyx';
            document.querySelector('input[name="notificationType"][value="' + notificationType + '"]').checked = true;

            toggleNotificationConfig(notificationType);
          } catch (error) {
            console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            showToast('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
          }
        }

        function toggleNotificationConfig(type) {
          const telegramConfig = document.getElementById('telegramConfig');
          const notifyxConfig = document.getElementById('notifyxConfig');

          if (type === 'telegram') {
            telegramConfig.classList.remove('inactive');
            telegramConfig.classList.add('active');
            notifyxConfig.classList.remove('active');
            notifyxConfig.classList.add('inactive');
          } else if (type === 'notifyx') {
            telegramConfig.classList.remove('active');
            telegramConfig.classList.add('inactive');
            notifyxConfig.classList.remove('inactive');
            notifyxConfig.classList.add('active');
          }
        }

        document.querySelectorAll('input[name="notificationType"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            toggleNotificationConfig(e.target.value);
          });
        });

        document.getElementById('configForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          const config = {
            ADMIN_USERNAME: document.getElementById('adminUsername').value.trim(),
            TG_BOT_TOKEN: document.getElementById('tgBotToken').value.trim(),
            TG_CHAT_ID: document.getElementById('tgChatId').value.trim(),
            NOTIFYX_API_KEY: document.getElementById('notifyxApiKey').value.trim(),
            NOTIFICATION_TYPE: document.querySelector('input[name="notificationType"]:checked').value
          };

          const passwordField = document.getElementById('adminPassword');
          if (passwordField.value.trim()) {
            config.ADMIN_PASSWORD = passwordField.value.trim();
          }

          const submitButton = e.target.querySelector('button[type="submit"]');
          const originalContent = submitButton.innerHTML;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ä¿å­˜ä¸­...';
          submitButton.disabled = true;

          try {
            const response = await fetch('/api/config', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(config)
            });

            const result = await response.json();

            if (result.success) {
              showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
              passwordField.value = '';
            } else {
              showToast('é…ç½®ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
          } catch (error) {
            console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
            showToast('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
          } finally {
            submitButton.innerHTML = originalContent;
            submitButton.disabled = false;
          }
        });

        async function testNotification(type) {
          const button = document.getElementById(type === 'telegram' ? 'testTelegramBtn' : 'testNotifyXBtn');
          const originalContent = button.innerHTML;
          const serviceName = type === 'telegram' ? 'Telegram' : 'NotifyX';

          button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
          button.disabled = true;

          const config = {};
          if (type === 'telegram') {
            config.TG_BOT_TOKEN = document.getElementById('tgBotToken').value.trim();
            config.TG_CHAT_ID = document.getElementById('tgChatId').value.trim();

            if (!config.TG_BOT_TOKEN || !config.TG_CHAT_ID) {
              showToast('è¯·å…ˆå¡«å†™ Telegram Bot Token å’Œ Chat ID', 'warning');
              button.innerHTML = originalContent;
              button.disabled = false;
              return;
            }
          } else {
            config.NOTIFYX_API_KEY = document.getElementById('notifyxApiKey').value.trim();

            if (!config.NOTIFYX_API_KEY) {
              showToast('è¯·å…ˆå¡«å†™ NotifyX API Key', 'warning');
              button.innerHTML = originalContent;
              button.disabled = false;
              return;
            }
          }

          try {
            const response = await fetch('/api/test-notification', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: type, ...config })
            });

            const result = await response.json();

            if (result.success) {
              showToast(serviceName + ' é€šçŸ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
              showToast(serviceName + ' é€šçŸ¥æµ‹è¯•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
          } catch (error) {
            console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
            showToast('æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
          } finally {
            button.innerHTML = originalContent;
            button.disabled = false;
          }
        }

        document.getElementById('testTelegramBtn').addEventListener('click', () => {
          testNotification('telegram');
        });

        document.getElementById('testNotifyXBtn').addEventListener('click', () => {
          testNotification('notifyx');
        });

        window.addEventListener('load', loadConfig);
      </script>
    </body>
    </html>
    `;

    // ç®¡ç†é¡µé¢
    const admin = {
      async handleRequest(request, env, ctx) {
        const url = new URL(request.url);
        const pathname = url.pathname;

        const token = getCookieValue(request.headers.get('Cookie'), 'token');
        const config = await getConfig(env);
        const user = token ? await verifyJWT(token, config.JWT_SECRET) : null;

        if (!user) {
          return new Response('', {
            status: 302,
            headers: { 'Location': '/' }
          });
        }

        if (pathname === '/admin/config') {
          return new Response(configPage, {
            headers: { 'Content-Type': 'text/html; charset=utf-8' }
          });
        }

        return new Response(adminPage, {
          headers: { 'Content-Type': 'text/html; charset=utf-8' }
        });
      }
    };

    // å¤„ç†APIè¯·æ±‚
    const api = {
      async handleRequest(request, env, ctx) {
        const url = new URL(request.url);
        const path = url.pathname.slice(4);
        const method = request.method;

        const config = await getConfig(env);

        if (path === '/login' && method === 'POST') {
          const body = await request.json();

          if (body.username === config.ADMIN_USERNAME && body.password === config.ADMIN_PASSWORD) {
            const token = await generateJWT(body.username, config.JWT_SECRET);

            return new Response(
              JSON.stringify({ success: true }),
              {
                headers: {
                  'Content-Type': 'application/json',
                  'Set-Cookie': 'token=' + token + '; HttpOnly; Path=/; SameSite=Strict; Max-Age=86400'
                }
              }
            );
          } else {
            return new Response(
              JSON.stringify({ success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' }),
              { headers: { 'Content-Type': 'application/json' } }
            );
          }
        }

        if (path === '/logout' && (method === 'GET' || method === 'POST')) {
          return new Response('', {
            status: 302,
            headers: {
              'Location': '/',
              'Set-Cookie': 'token=; HttpOnly; Path=/; SameSite=Strict; Max-Age=0'
            }
          });
        }

        const token = getCookieValue(request.headers.get('Cookie'), 'token');
        const user = token ? await verifyJWT(token, config.JWT_SECRET) : null;

        if (!user && path !== '/login') {
          return new Response(
            JSON.stringify({ success: false, message: 'æœªæˆæƒè®¿é—®' }),
            { status: 401, headers: { 'Content-Type': 'application/json' } }
          );
        }

        if (path === '/config') {
          if (method === 'GET') {
            const { JWT_SECRET, ADMIN_PASSWORD, ...safeConfig } = config;
            return new Response(
              JSON.stringify(safeConfig),
              { headers: { 'Content-Type': 'application/json' } }
            );
          }

          if (method === 'POST') {
            try {
              const newConfig = await request.json();

              const updatedConfig = { 
                ...config,
                ADMIN_USERNAME: newConfig.ADMIN_USERNAME || config.ADMIN_USERNAME,
                TG_BOT_TOKEN: newConfig.TG_BOT_TOKEN || '',
                TG_CHAT_ID: newConfig.TG_CHAT_ID || '',
                NOTIFYX_API_KEY: newConfig.NOTIFYX_API_KEY || '',
                NOTIFICATION_TYPE: newConfig.NOTIFICATION_TYPE || config.NOTIFICATION_TYPE
              };

              if (newConfig.ADMIN_PASSWORD) {
                updatedConfig.ADMIN_PASSWORD = newConfig.ADMIN_PASSWORD;
              }

              await env.SUBSCRIPTIONS_KV.put('config', JSON.stringify(updatedConfig));

              return new Response(
                JSON.stringify({ success: true }),
                { headers: { 'Content-Type': 'application/json' } }
              );
            } catch (error) {
              return new Response(
                JSON.stringify({ success: false, message: 'æ›´æ–°é…ç½®å¤±è´¥' }),
                { status: 400, headers: { 'Content-Type': 'application/json' } }
              );
            }
          }
        }

        if (path === '/test-notification' && method === 'POST') {
          try {
            const body = await request.json();
            let success = false;
            let message = '';

            if (body.type === 'telegram') {
              const testConfig = {
                ...config,
                TG_BOT_TOKEN: body.TG_BOT_TOKEN,
                TG_CHAT_ID: body.TG_CHAT_ID
              };

              const content = '*æµ‹è¯•é€šçŸ¥*\n\nè¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯Telegramé€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + new Date().toLocaleString();
              success = await sendTelegramNotification(content, testConfig);
              message = success ? 'Telegramé€šçŸ¥å‘é€æˆåŠŸ' : 'Telegramé€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
            } else if (body.type === 'notifyx') {
              const testConfig = {
                ...config,
                NOTIFYX_API_KEY: body.NOTIFYX_API_KEY
              };

              const title = 'æµ‹è¯•é€šçŸ¥';
              const content = '## è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥\n\nç”¨äºéªŒè¯NotifyXé€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå‘é€æ—¶é—´: ' + new Date().toLocaleString();
              const description = 'æµ‹è¯•NotifyXé€šçŸ¥åŠŸèƒ½';

              success = await sendNotifyXNotification(title, content, description, testConfig);
              message = success ? 'NotifyXé€šçŸ¥å‘é€æˆåŠŸ' : 'NotifyXé€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
            }

            return new Response(
              JSON.stringify({ success, message }),
              { headers: { 'Content-Type': 'application/json' } }
            );
          } catch (error) {
            console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
            return new Response(
              JSON.stringify({ success: false, message: 'æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message }),
              { status: 500, headers: { 'Content-Type': 'application/json' } }
            );
          }
        }

        if (path === '/subscriptions') {
          if (method === 'GET') {
            const subscriptions = await getAllSubscriptions(env);
            return new Response(
              JSON.stringify(subscriptions),
              { headers: { 'Content-Type': 'application/json' } }
            );
          }

          if (method === 'POST') {
            const subscription = await request.json();
            const result = await createSubscription(subscription, env);

            return new Response(
              JSON.stringify(result),
              { 
                status: result.success ? 201 : 400, 
                headers: { 'Content-Type': 'application/json' } 
              }
            );
          }
        }

        if (path.startsWith('/subscriptions/')) {
          const parts = path.split('/');
          const id = parts[2];

          if (parts[3] === 'toggle-status' && method === 'POST') {
            const body = await request.json();
            const result = await toggleSubscriptionStatus(id, body.isActive, env);

            return new Response(
              JSON.stringify(result),
              { 
                status: result.success ? 200 : 400, 
                headers: { 'Content-Type': 'application/json' } 
              }
            );
          }

          if (parts[3] === 'test-notify' && method === 'POST') {
            const result = await testSingleSubscriptionNotification(id, env);
            return new Response(JSON.stringify(result), { status: result.success ? 200 : 500, headers: { 'Content-Type': 'application/json' } });
          }

          if (method === 'GET') {
            const subscription = await getSubscription(id, env);

            return new Response(
              JSON.stringify(subscription),
              { headers: { 'Content-Type': 'application/json' } }
            );
          }

          if (method === 'PUT') {
            const subscription = await request.json();
            const result = await updateSubscription(id, subscription, env);

            return new Response(
              JSON.stringify(result),
              { 
                status: result.success ? 200 : 400, 
                headers: { 'Content-Type': 'application/json' } 
              }
            );
          }

          if (method === 'DELETE') {
            const result = await deleteSubscription(id, env);

            return new Response(
              JSON.stringify(result),
              { 
                status: result.success ? 200 : 400, 
                headers: { 'Content-Type': 'application/json' } 
              }
            );
          }
        }

        return new Response(
          JSON.stringify({ success: false, message: 'æœªæ‰¾åˆ°è¯·æ±‚çš„èµ„æº' }),
          { status: 404, headers: { 'Content-Type': 'application/json' } }
        );
      }
    };

    // å·¥å…·å‡½æ•°
    async function getConfig(env) {
      try {
        const data = await env.SUBSCRIPTIONS_KV.get('config');
        const config = data ? JSON.parse(data) : {};

        return {
          ADMIN_USERNAME: config.ADMIN_USERNAME || 'admin',
          ADMIN_PASSWORD: config.ADMIN_PASSWORD || 'password',
          JWT_SECRET: config.JWT_SECRET || 'your-secret-key',
          TG_BOT_TOKEN: config.TG_BOT_TOKEN || '',
          TG_CHAT_ID: config.TG_CHAT_ID || '',
          NOTIFYX_API_KEY: config.NOTIFYX_API_KEY || '',
          NOTIFICATION_TYPE: config.NOTIFICATION_TYPE || 'notifyx'
        };
      } catch (error) {
        return {
          ADMIN_USERNAME: 'admin',
          ADMIN_PASSWORD: 'password',
          JWT_SECRET: 'your-secret-key',
          TG_BOT_TOKEN: '',
          TG_CHAT_ID: '',
          NOTIFYX_API_KEY: '',
          NOTIFICATION_TYPE: 'notifyx'
        };
      }
    }

    async function generateJWT(username, secret) {
      const header = { alg: 'HS256', typ: 'JWT' };
      const payload = { username, iat: Math.floor(Date.now() / 1000) };

      const headerBase64 = btoa(JSON.stringify(header));
      const payloadBase64 = btoa(JSON.stringify(payload));

      const signatureInput = headerBase64 + '.' + payloadBase64;
      const signature = await CryptoJS.HmacSHA256(signatureInput, secret);

      return headerBase64 + '.' + payloadBase64 + '.' + signature;
    }

    async function verifyJWT(token, secret) {
      try {
        const parts = token.split('.');
        if (parts.length !== 3) return null;

        const [headerBase64, payloadBase64, signature] = parts;
        const signatureInput = headerBase64 + '.' + payloadBase64;
        const expectedSignature = await CryptoJS.HmacSHA256(signatureInput, secret);

        if (signature !== expectedSignature) return null;

        const payload = JSON.parse(atob(payloadBase64));
        return payload;
      } catch (error) {
        return null;
      }
    }

    async function getAllSubscriptions(env) {
      try {
        const data = await env.SUBSCRIPTIONS_KV.get('subscriptions');
        return data ? JSON.parse(data) : [];
      } catch (error) {
        return [];
      }
    }

    async function getSubscription(id, env) {
      const subscriptions = await getAllSubscriptions(env);
      return subscriptions.find(s => s.id === id);
    }

    async function createSubscription(subscription, env) {
      try {
        const subscriptions = await getAllSubscriptions(env);

        if (!subscription.name || !subscription.expiryDate) {
          return { success: false, message: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' };
        }

        let expiryDate = new Date(subscription.expiryDate);
        const now = new Date();

        if (expiryDate < now && subscription.periodValue && subscription.periodUnit) {
          while (expiryDate < now) {
            if (subscription.periodUnit === 'day') {
              expiryDate.setDate(expiryDate.getDate() + subscription.periodValue);
            } else if (subscription.periodUnit === 'month') {
              expiryDate.setMonth(expiryDate.getMonth() + subscription.periodValue);
            } else if (subscription.periodUnit === 'year') {
              expiryDate.setFullYear(expiryDate.getFullYear() + subscription.periodValue);
            }
          }
          subscription.expiryDate = expiryDate.toISOString();
        }

        const newSubscription = {
          id: Date.now().toString(),
          name: subscription.name,
          customType: subscription.customType || '',
          startDate: subscription.startDate || null,
          expiryDate: subscription.expiryDate,
          periodValue: subscription.periodValue || 1,
          periodUnit: subscription.periodUnit || 'month',
          reminderDays: subscription.reminderDays !== undefined ? subscription.reminderDays : 7,
          notes: subscription.notes || '',
          isActive: subscription.isActive !== false,
          autoRenew: subscription.autoRenew !== false,
          createdAt: new Date().toISOString()
        };

        subscriptions.push(newSubscription);

        await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(subscriptions));

        return { success: true, subscription: newSubscription };
      } catch (error) {
        return { success: false, message: 'åˆ›å»ºè®¢é˜…å¤±è´¥' };
      }
    }

    async function updateSubscription(id, subscription, env) {
      try {
        const subscriptions = await getAllSubscriptions(env);
        const index = subscriptions.findIndex(s => s.id === id);

        if (index === -1) {
          return { success: false, message: 'è®¢é˜…ä¸å­˜åœ¨' };
        }

        if (!subscription.name || !subscription.expiryDate) {
          return { success: false, message: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' };
        }

        let expiryDate = new Date(subscription.expiryDate);
        const now = new Date();

        if (expiryDate < now && subscription.periodValue && subscription.periodUnit) {
          while (expiryDate < now) {
            if (subscription.periodUnit === 'day') {
              expiryDate.setDate(expiryDate.getDate() + subscription.periodValue);
            } else if (subscription.periodUnit === 'month') {
              expiryDate.setMonth(expiryDate.getMonth() + subscription.periodValue);
            } else if (subscription.periodUnit === 'year') {
              expiryDate.setFullYear(expiryDate.getFullYear() + subscription.periodValue);
            }
          }
          subscription.expiryDate = expiryDate.toISOString();
        }

        subscriptions[index] = {
          ...subscriptions[index],
          name: subscription.name,
          customType: subscription.customType || subscriptions[index].customType || '',
          startDate: subscription.startDate || subscriptions[index].startDate,
          expiryDate: subscription.expiryDate,
          periodValue: subscription.periodValue || subscriptions[index].periodValue || 1,
          periodUnit: subscription.periodUnit || subscriptions[index].periodUnit || 'month',
          reminderDays: subscription.reminderDays !== undefined ? subscription.reminderDays : (subscriptions[index].reminderDays !== undefined ? subscriptions[index].reminderDays : 7),
          notes: subscription.notes || '',
          isActive: subscription.isActive !== undefined ? subscription.isActive : subscriptions[index].isActive,
          autoRenew: subscription.autoRenew !== undefined ? subscription.autoRenew : (subscriptions[index].autoRenew !== undefined ? subscriptions[index].autoRenew : true),
          updatedAt: new Date().toISOString()
        };

        await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(subscriptions));

        return { success: true, subscription: subscriptions[index] };
      } catch (error) {
        return { success: false, message: 'æ›´æ–°è®¢é˜…å¤±è´¥' };
      }
    }

    async function deleteSubscription(id, env) {
      try {
        const subscriptions = await getAllSubscriptions(env);
        const filteredSubscriptions = subscriptions.filter(s => s.id !== id);

        if (filteredSubscriptions.length === subscriptions.length) {
          return { success: false, message: 'è®¢é˜…ä¸å­˜åœ¨' };
        }

        await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(filteredSubscriptions));

        return { success: true };
      } catch (error) {
        return { success: false, message: 'åˆ é™¤è®¢é˜…å¤±è´¥' };
      }
    }

    async function toggleSubscriptionStatus(id, isActive, env) {
      try {
        const subscriptions = await getAllSubscriptions(env);
        const index = subscriptions.findIndex(s => s.id === id);

        if (index === -1) {
          return { success: false, message: 'è®¢é˜…ä¸å­˜åœ¨' };
        }

        subscriptions[index] = {
          ...subscriptions[index],
          isActive: isActive,
          updatedAt: new Date().toISOString()
        };

        await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(subscriptions));

        return { success: true, subscription: subscriptions[index] };
      } catch (error) {
        return { success: false, message: 'æ›´æ–°è®¢é˜…çŠ¶æ€å¤±è´¥' };
      }
    }

    async function testSingleSubscriptionNotification(id, env) {
      try {
        const subscription = await getSubscription(id, env);
        if (!subscription) {
          return { success: false, message: 'æœªæ‰¾åˆ°è¯¥è®¢é˜…' };
        }
        const config = await getConfig(env);

        const title = `æ‰‹åŠ¨æµ‹è¯•é€šçŸ¥: ${subscription.name}`;
        const description = `è¿™æ˜¯ä¸€ä¸ªå¯¹è®¢é˜… "${subscription.name}" çš„æ‰‹åŠ¨æµ‹è¯•é€šçŸ¥ã€‚`;
        let content = '';

        // æ ¹æ®æ‰€é€‰é€šçŸ¥æ¸ é“æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œä¸ä¸»æé†’åŠŸèƒ½ä¿æŒä¸€è‡´
        if (config.NOTIFICATION_TYPE === 'notifyx') {
            content = `## ${title}\n\n**è®¢é˜…è¯¦æƒ…**:\n- **ç±»å‹**: ${subscription.customType || 'å…¶ä»–'}\n- **åˆ°æœŸæ—¥**: ${new Date(subscription.expiryDate).toLocaleDateString()}\n- **å¤‡æ³¨**: ${subscription.notes || 'æ— '}`;
        } else { // é»˜è®¤ Telegram
            content = `*${title}*\n\n**è®¢é˜…è¯¦æƒ…**:\n- **ç±»å‹**: ${subscription.customType || 'å…¶ä»–'}\n- **åˆ°æœŸæ—¥**: ${new Date(subscription.expiryDate).toLocaleDateString()}\n- **å¤‡æ³¨**: ${subscription.notes || 'æ— '}`;
        }

        const success = await sendNotification(title, content, description, config);

        if (success) {
            return { success: true, message: 'æµ‹è¯•é€šçŸ¥å·²æˆåŠŸå‘é€' };
        } else {
            return { success: false, message: 'æµ‹è¯•é€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®' };
        }

      } catch (error) {
        console.error('[æ‰‹åŠ¨æµ‹è¯•] å‘é€å¤±è´¥:', error);
        return { success: false, message: 'å‘é€æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message };
      }
    }

    async function sendWeComNotification(message, config) {
        // This is a placeholder. In a real scenario, you would implement the WeCom notification logic here.
        console.log("[ä¼ä¸šå¾®ä¿¡] é€šçŸ¥åŠŸèƒ½æœªå®ç°");
        return { success: false, message: "ä¼ä¸šå¾®ä¿¡é€šçŸ¥åŠŸèƒ½æœªå®ç°" };
    }

    async function sendNotificationToAllChannels(title, commonContent, config, logPrefix = '[å®šæ—¶ä»»åŠ¡]') {
        if (!config.ENABLED_NOTIFIERS || config.ENABLED_NOTIFIERS.length === 0) {
            console.log(`${logPrefix} æœªå¯ç”¨ä»»ä½•é€šçŸ¥æ¸ é“ã€‚`);
            return;
        }

        if (config.ENABLED_NOTIFIERS.includes('notifyx')) {
            const notifyxContent = `## ${title}\n\n${commonContent}`;
            const success = await sendNotifyXNotification(title, notifyxContent, `è®¢é˜…æé†’`, config);
            console.log(`${logPrefix} å‘é€NotifyXé€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
        }
        if (config.ENABLED_NOTIFIERS.includes('telegram')) {
            const telegramContent = `*${title}*\n\n${commonContent.replace(/(\s)/g, ' ')}`;
            const success = await sendTelegramNotification(telegramContent, config);
            console.log(`${logPrefix} å‘é€Telegramé€šçŸ¥ ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
        }
        if (config.ENABLED_NOTIFIERS.includes('weixin')) {
            const weixinContent = `ã€${title}ã€‘\n\n${commonContent.replace(/(\**|\*|##|#|`)/g, '')}`;
            const result = await sendWeComNotification(weixinContent, config);
            console.log(`${logPrefix} å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}. ${result.message}`);
        }
    }

    async function sendTelegramNotification(message, config) {
      try {
        if (!config.TG_BOT_TOKEN || !config.TG_CHAT_ID) {
          console.error('[Telegram] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘Bot Tokenæˆ–Chat ID');
          return false;
        }

        console.log('[Telegram] å¼€å§‹å‘é€é€šçŸ¥åˆ° Chat ID: ' + config.TG_CHAT_ID);

        const url = 'https://api.telegram.org/bot' + config.TG_BOT_TOKEN + '/sendMessage';
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: config.TG_CHAT_ID,
            text: message,
            parse_mode: 'Markdown'
          })
        });

        const result = await response.json();
        console.log('[Telegram] å‘é€ç»“æœ:', result);
        return result.ok;
      } catch (error) {
        console.error('[Telegram] å‘é€é€šçŸ¥å¤±è´¥:', error);
        return false;
      }
    }

    async function sendNotifyXNotification(title, content, description, config) {
      try {
        if (!config.NOTIFYX_API_KEY) {
          console.error('[NotifyX] é€šçŸ¥æœªé…ç½®ï¼Œç¼ºå°‘API Key');
          return false;
        }

        console.log('[NotifyX] å¼€å§‹å‘é€é€šçŸ¥: ' + title);

        const url = 'https://www.notifyx.cn/api/v1/send/' + config.NOTIFYX_API_KEY;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: title,
            content: content,
            description: description || ''
          })
        });

        const result = await response.json();
        console.log('[NotifyX] å‘é€ç»“æœ:', result);
        return result.status === 'queued';
      } catch (error) {
        console.error('[NotifyX] å‘é€é€šçŸ¥å¤±è´¥:', error);
        return false;
      }
    }

    async function sendNotification(title, content, description, config) {
      if (config.NOTIFICATION_TYPE === 'notifyx') {
        return await sendNotifyXNotification(title, content, description, config);
      } else {
        return await sendTelegramNotification(content, config);
      }
    }

    // å®šæ—¶æ£€æŸ¥å³å°†åˆ°æœŸçš„è®¢é˜… - å®Œå…¨ä¼˜åŒ–ç‰ˆ
    async function checkExpiringSubscriptions(env) {
      try {
        console.log('[å®šæ—¶ä»»åŠ¡] å¼€å§‹æ£€æŸ¥å³å°†åˆ°æœŸçš„è®¢é˜…: ' + new Date().toISOString());

        const subscriptions = await getAllSubscriptions(env);
        console.log('[å®šæ—¶ä»»åŠ¡] å…±æ‰¾åˆ° ' + subscriptions.length + ' ä¸ªè®¢é˜…');

        const config = await getConfig(env);
        const now = new Date();
        const expiringSubscriptions = [];
        const updatedSubscriptions = [];
        let hasUpdates = false;

        for (const subscription of subscriptions) {
          if (subscription.isActive === false) {
            console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" å·²åœç”¨ï¼Œè·³è¿‡');
            continue;
          }

          const expiryDate = new Date(subscription.expiryDate);
          const daysDiff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

          console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åˆ°æœŸæ—¥æœŸ: ' + expiryDate.toISOString() + ', å‰©ä½™å¤©æ•°: ' + daysDiff);

          // ä¿®å¤æå‰æé†’å¤©æ•°é€»è¾‘
          const reminderDays = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;
          let shouldRemind = false;

          if (reminderDays === 0) {
            // å½“æå‰æé†’å¤©æ•°ä¸º0æ—¶ï¼Œåªåœ¨åˆ°æœŸæ—¥å½“å¤©æé†’
            shouldRemind = daysDiff === 0;
          } else {
            // å½“æå‰æé†’å¤©æ•°å¤§äº0æ—¶ï¼Œåœ¨æŒ‡å®šèŒƒå›´å†…æé†’
            shouldRemind = daysDiff >= 0 && daysDiff <= reminderDays;
          }

          // å¦‚æœå·²è¿‡æœŸï¼Œä¸”è®¾ç½®äº†å‘¨æœŸå’Œè‡ªåŠ¨ç»­è®¢ï¼Œåˆ™è‡ªåŠ¨æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ
          if (daysDiff < 0 && subscription.periodValue && subscription.periodUnit && subscription.autoRenew !== false) {
            console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" å·²è¿‡æœŸä¸”å¯ç”¨è‡ªåŠ¨ç»­è®¢ï¼Œæ­£åœ¨æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ');

            const newExpiryDate = new Date(expiryDate);

            if (subscription.periodUnit === 'day') {
              newExpiryDate.setDate(expiryDate.getDate() + subscription.periodValue);
            } else if (subscription.periodUnit === 'month') {
              newExpiryDate.setMonth(expiryDate.getMonth() + subscription.periodValue);
            } else if (subscription.periodUnit === 'year') {
              newExpiryDate.setFullYear(expiryDate.getFullYear() + subscription.periodValue);
            }

            while (newExpiryDate < now) {
              console.log('[å®šæ—¶ä»»åŠ¡] æ–°è®¡ç®—çš„åˆ°æœŸæ—¥æœŸ ' + newExpiryDate.toISOString() + ' ä»ç„¶è¿‡æœŸï¼Œç»§ç»­è®¡ç®—ä¸‹ä¸€ä¸ªå‘¨æœŸ');

              if (subscription.periodUnit === 'day') {
                newExpiryDate.setDate(newExpiryDate.getDate() + subscription.periodValue);
              } else if (subscription.periodUnit === 'month') {
                newExpiryDate.setMonth(newExpiryDate.getMonth() + subscription.periodValue);
              } else if (subscription.periodUnit === 'year') {
                newExpiryDate.setFullYear(newExpiryDate.getFullYear() + subscription.periodValue);
              }
            }

            console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" æ›´æ–°åˆ°æœŸæ—¥æœŸ: ' + newExpiryDate.toISOString());

            const updatedSubscription = { ...subscription, expiryDate: newExpiryDate.toISOString() };
            updatedSubscriptions.push(updatedSubscription);
            hasUpdates = true;

            const newDaysDiff = Math.ceil((newExpiryDate - now) / (1000 * 60 * 60 * 24));

            let shouldRemindAfterRenewal = false;
            if (reminderDays === 0) {
              shouldRemindAfterRenewal = newDaysDiff === 0;
            } else {
              shouldRemindAfterRenewal = newDaysDiff >= 0 && newDaysDiff <= reminderDays;
            }

            if (shouldRemindAfterRenewal) {
              console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åœ¨æé†’èŒƒå›´å†…ï¼Œå°†å‘é€é€šçŸ¥');
              expiringSubscriptions.push({
                ...updatedSubscription,
                daysRemaining: newDaysDiff
              });
            }
          } else if (daysDiff < 0 && subscription.autoRenew === false) {
            console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" å·²è¿‡æœŸä¸”æœªå¯ç”¨è‡ªåŠ¨ç»­è®¢ï¼Œå°†å‘é€è¿‡æœŸé€šçŸ¥');
            expiringSubscriptions.push({
              ...subscription,
              daysRemaining: daysDiff
            });
          } else if (shouldRemind) {
            console.log('[å®šæ—¶ä»»åŠ¡] è®¢é˜… "' + subscription.name + '" åœ¨æé†’èŒƒå›´å†…ï¼Œå°†å‘é€é€šçŸ¥');
            expiringSubscriptions.push({
              ...subscription,
              daysRemaining: daysDiff
            });
          }
        }

        if (hasUpdates) {
          console.log('[å®šæ—¶ä»»åŠ¡] æœ‰ ' + updatedSubscriptions.length + ' ä¸ªè®¢é˜…éœ€è¦æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ');

          const mergedSubscriptions = subscriptions.map(sub => {
            const updated = updatedSubscriptions.find(u => u.id === sub.id);
            return updated || sub;
          });

          await env.SUBSCRIPTIONS_KV.put('subscriptions', JSON.stringify(mergedSubscriptions));
          console.log('[å®šæ—¶ä»»åŠ¡] å·²æ›´æ–°è®¢é˜…åˆ—è¡¨');
        }

        if (expiringSubscriptions.length > 0) {
          console.log('[å®šæ—¶ä»»åŠ¡] æœ‰ ' + expiringSubscriptions.length + ' ä¸ªè®¢é˜…éœ€è¦å‘é€é€šçŸ¥');

          let commonContent = '';
          expiringSubscriptions.sort((a, b) => a.daysRemaining - b.daysRemaining);

          for (const sub of expiringSubscriptions) {
            const typeText = sub.customType || 'å…¶ä»–';
            const periodText = (sub.periodValue && sub.periodUnit) ? `(å‘¨æœŸ: ${sub.periodValue} ${ { day: 'å¤©', month: 'æœˆ', year: 'å¹´' }[sub.periodUnit] || sub.periodUnit})` : '';

            let statusText;
            if (sub.daysRemaining === 0) statusText = `âš ï¸ **${sub.name}** (${typeText}) ${periodText} ä»Šå¤©åˆ°æœŸï¼`;
            else if (sub.daysRemaining < 0) statusText = `ğŸš¨ **${sub.name}** (${typeText}) ${periodText} å·²è¿‡æœŸ ${Math.abs(sub.daysRemaining)} å¤©`;
            else statusText = `ğŸ“… **${sub.name}** (${typeText}) ${periodText} å°†åœ¨ ${sub.daysRemaining} å¤©ååˆ°æœŸ`;

            if (sub.notes) statusText += `\n   å¤‡æ³¨: ${sub.notes}`;
            commonContent += statusText + '\n\n';
          }

          await sendNotificationToAllChannels(title, commonContent, config, logPrefix);

        } else {
          console.log('[å®šæ—¶ä»»åŠ¡] æ²¡æœ‰éœ€è¦æé†’çš„è®¢é˜…');
        }

        console.log('[å®šæ—¶ä»»åŠ¡] æ£€æŸ¥å®Œæˆ');
      } catch (error) {
        console.error('[å®šæ—¶ä»»åŠ¡] æ£€æŸ¥å³å°†åˆ°æœŸçš„è®¢é˜…å¤±è´¥:', error);
      }
    }

    function getCookieValue(cookieString, key) {
      if (!cookieString) return null;

      const match = cookieString.match(new RegExp('(^| )' + key + '=([^;]+)'));
      return match ? match[2] : null;
    }

    async function handleRequest(request, env, ctx) {
      return new Response(loginPage, {
        headers: { 'Content-Type': 'text/html; charset=utf-8' }
      });
    }

    const CryptoJS = {
      HmacSHA256: function(message, key) {
        const keyData = new TextEncoder().encode(key);
        const messageData = new TextEncoder().encode(message);

        return Promise.resolve().then(() => {
          return crypto.subtle.importKey(
            "raw", 
            keyData,
            { name: "HMAC", hash: {name: "SHA-256"} },
            false,
            ["sign"]
          );
        }).then(cryptoKey => {
          return crypto.subtle.sign(
            "HMAC",
            cryptoKey,
            messageData
          );
        }).then(buffer => {
          const hashArray = Array.from(new Uint8Array(buffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        });
      }
    };

    export default {
      async fetch(request, env, ctx) {
        const url = new URL(request.url);

        if (url.pathname.startsWith('/api')) {
          return api.handleRequest(request, env, ctx);
        } else if (url.pathname.startsWith('/admin')) {
          return admin.handleRequest(request, env, ctx);
        } else {
          return handleRequest(request, env, ctx);
        }
      },

      async scheduled(event, env, ctx) {
        console.log('[Workers] å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶é—´:', new Date().toISOString());
        await checkExpiringSubscriptions(env);
      }
    };
  ```

  SubsTracker å¼€æºé¡¹ç›®ã€[ä»“åº“](https://www.freedidi.com/?golink=aHR0cHM6Ly9naXRjb2RlLmNvbS9naF9taXJyb3JzL3N1Yi9TdWJzVHJhY2tlcg==)ã€‘
* ## å¦‚ä½•è·å–[Telegram](https://www.freedidi.com/?golink=aHR0cHM6Ly90ZWxlZ3JhbS5vcmcv)çš„`Bot_Token`å’Œ`Chat_ID`

  å¦‚æœæ‚¨è¿˜æ²¡æœ‰Telegramè´¦æˆ·ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªã€‚æ¥ç€ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œä»¥è·å–`BOT_TOKEN`å’Œ`CHAT_ID`ï¼š


  1. **è·å–`Bot_Token`**
     * åœ¨Telegramä¸­ï¼Œå‘[@BotFather](https://www.freedidi.com/?golink=aHR0cHM6Ly90Lm1lL0JvdEZhdGhlcg==)å‘é€å‘½ä»¤`/newbot`ï¼Œæ ¹æ®æç¤ºä¾æ¬¡è¾“å…¥æ‚¨çš„æœºå™¨äººåç§°å’Œç”¨æˆ·åã€‚æˆåŠŸåˆ›å»ºæœºå™¨äººåï¼Œæ‚¨å°†ä¼šæ”¶åˆ°ä¸€ä¸ª`BOT_TOKEN`ï¼Œç”¨äºä¸Telegram APIè¿›è¡Œäº¤äº’ã€‚ï¼ˆè¿™ä¸€ä¸²apiå°±æ˜¯Bot_Token)

<img src="https://5f4480c.webp.li/2025/07/83e2d63c90806894da9223e4fc2bd31b.webp" >

<img src="https://5f4480c.webp.li/2025/07/dfa9d7a0ea65bd514d1a6ca998d38c48.png" >

2ï¼šæ¥ç€æœç´¢ï¼š@getmyid\_bot è¿™ä¸ªæœºå™¨äººå¹¶å‘é€ä¿¡æ¯/start ç»™å®ƒå°±å¯ä»¥è·å¾—ä½ çš„ Chat IDï¼ˆCurrent chat IDï¼‰

<img src="https://5f4480c.webp.li/2025/07/74dc830a800251ad9b0d232d3261f919.jpg" >

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å‰ææ¡ä»¶

* Cloudflareè´¦æˆ·
* Telegram Bot (ç”¨äºå‘é€é€šçŸ¥)
* å¯ä»¥ç›´æ¥å°†ä»£ç ä¸¢ç»™AI,å¸®åŠ©æŸ¥æ¼è¡¥ç¼º

### éƒ¨ç½²æ­¥éª¤

**æ³¨æ„ï¼ï¼**ï¼šåœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€åœ¨Cloudfalreæ§åˆ¶å·¦ä¾§é¢æ¿é‡Œï¼Œä¾æ¬¡ç‚¹å‡»ï¼šå­˜å‚¨å’Œæ•°æ®åº“ â€“ KV â€“ åˆ›å»º â€“ åˆ›å»ºKVç©ºé—´ï¼Œç©ºé—´åç§°å¡«å†™ï¼šSUBSCRIPTIONS\_KV ä¿å­˜ã€‚**å¦åˆ™ SubsTracker æ·»åŠ è®¢é˜…å°†æ— æ³•ä¿å­˜ï¼**

1.ç™»é™†cloudflare,åˆ›å»ºworker,ç²˜è´´æœ¬é¡¹ç›®ä¸­çš„jsä»£ç ,ç‚¹å‡»éƒ¨ç½²

<img src="https://5f4480c.webp.li/2025/07/f3cacad2c75008b233493d4c9b66f9bf.png" >

2.åˆ›å»ºKVé”®å€¼ **SUBSCRIPTIONS\_KV**

<img src="https://5f4480c.webp.li/2025/07/c778add4e9398660731dd6ba5b2eb935.png" >

3.ç»™workerç»‘å®šä¸Šé”®å€¼å¯¹,ä»¥åŠè®¾ç½®å®šæ—¶æ‰§è¡Œæ—¶é—´!

<img src="https://5f4480c.webp.li/2025/07/1057537ce1a73ab5b949562b6ccce46e.png" >

4.æ‰“å¼€workeræä¾›çš„åŸŸååœ°å€,è¾“å…¥é»˜è®¤è´¦å·å¯†ç : admin password (æˆ–è€…æ˜¯ï¼šadmin admin123),å¯ä»¥åœ¨ä»£ç ä¸­æŸ¥çœ‹é»˜è®¤è´¦å·å¯†ç !

<img src="https://5f4480c.webp.li/2025/07/afc71eb7193ffcc329983d745874efe4.png" >

5.å‰å¾€ç³»ç»Ÿé…ç½®,ä¿®æ”¹è´¦å·å¯†ç ,ä»¥åŠé…ç½®tgé€šçŸ¥çš„ä¿¡æ¯

<img src="https://5f4480c.webp.li/2025/07/e1b8815294817c7acef4c2ef012577c3.png" >

6.é…ç½®å®Œæˆå¯ä»¥ç‚¹å‡»æµ‹è¯•é€šçŸ¥,æŸ¥çœ‹æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸é€šçŸ¥,ç„¶åå°±å¯ä»¥æ­£å¸¸æ·»åŠ è®¢é˜…ä½¿ç”¨äº†!

<img src="https://5f4480c.webp.li/2025/07/f7f30af1d278dc0595c49b799b726836.png" >
